<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PDV - Asistente Beer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            overflow: hidden;
        }

        .chat-container {
            width: 100%;
            height: 100vh;
            background: #f0f2f5;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .chat-header {
            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
            color: white;
            padding: 15px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 100;
        }

        .header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd700 0%, #ffb800 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        .header-info {
            flex: 1;
        }

        .header-name {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .header-status {
            font-size: 0.75em;
            color: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .chat-messages {
            flex: 1;
            padding: 15px 12px 80px;
            overflow-y: auto;
            background: #f0f2f5;
            -webkit-overflow-scrolling: touch;
        }

        .chat-messages::-webkit-scrollbar {
            width: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(37, 211, 102, 0.3);
            border-radius: 2px;
        }

        .message {
            margin-bottom: 12px;
            display: flex;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-content {
            max-width: 80%;
            position: relative;
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 0.95em;
            line-height: 1.4;
        }

        .bot-message {
            justify-content: flex-start;
        }

        .bot-message .message-content {
            background: white;
            color: #111;
            border-radius: 0 18px 18px 18px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .user-message {
            justify-content: flex-end;
        }

        .user-message .message-content {
            background: linear-gradient(135deg, #25d366 0%, #20ba5a 100%);
            color: white;
            border-radius: 18px 0 18px 18px;
        }

        .message-time {
            font-size: 0.7em;
            color: rgba(0,0,0,0.4);
            margin-top: 4px;
            text-align: right;
        }

        .bubble-container {
            background: white;
            padding: 16px;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 8px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .bubble-title {
            font-size: 0.95em;
            color: #111;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .custom-select {
            position: relative;
            margin-bottom: 10px;
        }

        .select-button {
            width: 100%;
            padding: 14px 16px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            color: #333;
            font-size: 0.95em;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .select-button:hover {
            border-color: #25d366;
        }

        .select-button.active {
            border-color: #25d366;
            background: rgba(37, 211, 102, 0.05);
        }

        .select-dropdown {
            position: absolute;
            left: 0;
            right: 0;
            background: white;
            border-radius: 16px;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            z-index: 1000;
            opacity: 0;
            margin-top: 5px;
        }

        .select-dropdown.active {
            max-height: 60vh;
            overflow-y: auto;
            padding: 15px;
            opacity: 1;
        }

        .select-search {
            position: sticky;
            top: 0;
            padding: 10px 0;
            background: white;
            z-index: 10;
            margin-bottom: 10px;
        }

        .select-search input {
            width: 100%;
            padding: 12px 16px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 0.95em;
            outline: none;
        }

        .select-option {
            padding: 14px 16px;
            color: #333;
            cursor: pointer;
            border-radius: 12px;
            margin: 4px 0;
            transition: all 0.2s;
            font-size: 0.95em;
        }

        .select-option:hover {
            background: rgba(37, 211, 102, 0.1);
            transform: translateX(5px);
        }

        .capture-container {
            background: white;
            padding: 16px;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 8px;
        }

        .capture-title {
            font-size: 0.95em;
            color: #111;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .action-button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #25d366 0%, #20ba5a 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .action-button:active {
            transform: scale(0.98);
        }

        .action-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .action-button.camera-btn {
            background: linear-gradient(135deg, #2196F3 0%, #0b7dda 100%);
        }

        .action-button.skip-btn {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }

        video {
            width: 100%;
            border-radius: 12px;
            margin: 12px 0;
            transform: scaleX(-1);
            display: none;
        }

        .captured-photo {
            width: 100%;
            border-radius: 12px;
            margin: 12px 0;
            display: none;
            border: 3px solid white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .info-text {
            font-size: 0.85em;
            color: #666;
            margin-top: 10px;
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .menu-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-top: 15px;
        }

        .menu-button {
            padding: 14px 16px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            color: #333;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-button:active {
            transform: scale(0.98);
            background: #e9ecef;
        }

        .typing-indicator {
            display: flex;
            gap: 6px;
            padding: 10px 20px;
            background: white;
            border-radius: 18px;
            width: fit-content;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #25d366;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }

        .input-bubble {
            background: white;
            padding: 16px;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 8px;
        }

        .input-bubble-text {
            margin-bottom: 12px;
            font-size: 0.95em;
            color: #111;
            font-weight: 600;
        }

        .input-field {
            width: 100%;
            padding: 14px 16px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 0.95em;
            outline: none;
        }

        .input-field:focus {
            border-color: #25d366;
        }

        .send-input-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #25d366 0%, #20ba5a 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            margin-top: 12px;
            transition: all 0.2s;
        }

        .send-input-btn:active {
            transform: scale(0.98);
        }

        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
            
            .chat-container {
                max-width: 450px;
                height: 800px;
                border-radius: 20px;
                overflow: hidden;
                box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="header-avatar">üç∫</div>
            <div class="header-info">
                <div class="header-name">Asistente PDV Beer</div>
                <div class="header-status">
                    <div class="status-dot"></div>
                    <span id="connectionStatus">inicializando...</span>
                </div>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages"></div>
    </div>

    <!-- Elementos multimedia ocultos -->
    <video id="videoStream" autoplay playsinline style="display:none;"></video>
    <canvas id="photoCanvas" style="display:none;"></canvas>

    <!-- Formularios ocultos -->
    <iframe name="hidden_iframe_ingreso" id="hiddenIframeIngreso" style="display:none;"></iframe>
    <form id="googleFormIngreso" 
          action="https://docs.google.com/forms/d/e/1FAIpQLSc0Kt8C392ffQH6b5eFt-TE8-778mqqwb9tdWCt8XWqQfUgFg/formResponse" 
          target="hiddenIframeIngreso" 
          method="POST"
          style="display:none;">
        <input type="text" name="entry.1176318650" id="asesorField">
        <input type="text" name="entry.735888429" id="ubicacionField">
        <input type="text" name="entry.363650812" id="selfieField">
        <input type="text" name="entry.704645502" id="ciudadField">
        <input type="text" name="entry.732551510" id="puntoVentaField">
        <input type="text" name="entry.1281420665" id="confirmacionField" value="S√≠, es correcta">
    </form>

    <iframe name="hidden_iframe_lineal" id="hiddenIframeLineal" style="display:none;"></iframe>
    <!-- FORMULARIO LINEAL CON TODOS LOS CAMPOS OCULTOS -->
    <form id="googleFormLineal" 
          action="https://docs.google.com/forms/d/e/1FAIpQLScieYTjkAlXma8QLdmMQD2q-gcQb3h8fBWlw1kAWdHrLs8Vow/formResponse" 
          target="hiddenIframeLineal" 
          method="POST"
          style="display:none;">
        <!-- Campos del asesor, ciudad y PDV (ocultos) -->
        <input type="text" name="entry.293595922" id="linealAsesorField">
        <input type="text" name="entry.1357513793" id="linealCiudadField">
        <input type="text" name="entry.1347251759" id="linealPuntoVentaField">
        
        <!-- Campos que el usuario ver√° y completar√° -->
        <input type="text" name="entry.238753566" id="tipoMarcaField">
        <input type="text" name="entry.536323816" id="productoField">
        <input type="text" name="entry.857124037" id="numeroFrentesField">
        <input type="text" name="entry.1305667853" id="datosCorrectosField" value="S√≠">
        
        <!-- Campos adicionales para marca competencia -->
        <input type="text" name="entry.384259513" id="productoCompetenciaField">
        <input type="text" name="entry.1918813643" id="frentesCompetenciaField">
        <input type="text" name="entry.1870261210" id="confirmacionCompetenciaField" value="S√≠">
    </form>

    <script>
        // ========== CONFIGURACI√ìN ==========
        const API_KEY = 'TU_API_KEY_AQUI'; // Necesitar√°s obtener una API Key de Google Cloud
        
        // IDs de los Google Sheets
        const SHEET_ASESORES = '185O1g8wAYZoQn3fiPkOOnVhauaDiTR_hC12f_34oxh4';
        const SHEET_DATOS = '1RO0xo3-61sEiwEM0oHBXZiP90Zio8nJqUCvQsiSjneg';
        
        // Nombres de las hojas
        const HOJA_USUARIOS = 'Usuarios';
        const HOJA_PDV_CIUDADES = 'PDV_Ciudades';
        const HOJA_LISTAS_ACTUALIZADAS = 'Listas_Actualizadas';

        // ========== VARIABLES GLOBALES ==========
        let appState = {
            // Estado del ingreso
            ingreso: {
                asesor: '',
                ubicacion: '',
                selfie: '',
                ciudad: '',
                puntoVenta: '',
                completado: false
            },
            // Estado del lineal
            lineal: {
                asesor: '',
                ciudad: '',
                pdv: '',
                tipoMarca: '',
                producto: '',
                numeroFrente: '',
                enviando: false
            },
            // Datos cargados
            datos: {
                asesores: [],
                ciudadesPDV: {},
                listasActualizadas: {}
            },
            currentStep: 0,
            isProcessingPhoto: false,
            menuBloqueado: false
        };

        const chatMessages = document.getElementById('chatMessages');
        const connectionStatus = document.getElementById('connectionStatus');

        // ========== FUNCIONES PARA CARGAR DATOS ==========
        async function cargarDatosIniciales() {
            try {
                connectionStatus.textContent = 'cargando datos...';
                
                // 1. Cargar asesores iniciales
                const urlAsesores = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ASESORES}/values/${HOJA_USUARIOS}!C:C?key=${API_KEY}`;
                const respuestaAsesores = await fetch(urlAsesores);
                const datosAsesores = await respuestaAsesores.json();
                
                if (datosAsesores.values && datosAsesores.values.length > 1) {
                    appState.datos.asesores = datosAsesores.values
                        .slice(1) // Saltar encabezado
                        .map(row => row[0]?.trim())
                        .filter(nombre => nombre && nombre !== '');
                }
                
                // 2. Cargar datos de Listas_Actualizadas
                const urlListas = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_DATOS}/values/${HOJA_LISTAS_ACTUALIZADAS}!A:Z?key=${API_KEY}`;
                const respuestaListas = await fetch(urlListas);
                const datosListas = await respuestaListas.json();
                
                if (datosListas.values && datosListas.values.length > 1) {
                    procesarListasActualizadas(datosListas.values);
                }
                
                // 3. Cargar ciudades y PDVs
                const urlCiudades = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ASESORES}/values/${HOJA_PDV_CIUDADES}!A:B?key=${API_KEY}`;
                const respuestaCiudades = await fetch(urlCiudades);
                const datosCiudades = await respuestaCiudades.json();
                
                if (datosCiudades.values && datosCiudades.values.length > 1) {
                    procesarCiudadesPDV(datosCiudades.values);
                }
                
                connectionStatus.textContent = 'en l√≠nea';
                console.log('Datos cargados exitosamente');
                return true;
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                connectionStatus.textContent = 'error conexi√≥n';
                
                // Datos de respaldo
                appState.datos.asesores = ['Ana Lucia Calderon', 'Robinson Esneyder Zapata Anzola'];
                appState.datos.listasActualizadas = {
                    'Robinson Esneyder Zapata Anzola': {
                        ciudad: 'Armenia',
                        pdv: 'Si 4239 Super Inter Armenia Plaza'
                    },
                    'Ana Lucia Calderon': {
                        ciudad: 'Armenia',
                        pdv: 'St 355 Armenia Norte'
                    }
                };
                
                setTimeout(() => {
                    connectionStatus.textContent = 'modo local';
                }, 2000);
                
                return false;
            }
        }

        function procesarListasActualizadas(datos) {
            const encabezados = datos[0];
            const indiceAsesor = encabezados.findIndex(h => 
                h.toLowerCase().includes('asesor') || h.toLowerCase().includes('nombre')
            );
            const indiceCiudad = encabezados.findIndex(h => 
                h.toLowerCase().includes('ciudad')
            );
            const indicePDV = encabezados.findIndex(h => 
                h.toLowerCase().includes('punto') || h.toLowerCase().includes('pdv')
            );
            
            for (let i = 1; i < datos.length; i++) {
                const fila = datos[i];
                if (fila.length > Math.max(indiceAsesor, indiceCiudad, indicePDV)) {
                    const asesor = fila[indiceAsesor]?.trim();
                    const ciudad = fila[indiceCiudad]?.trim();
                    const pdv = fila[indicePDV]?.trim();
                    
                    if (asesor) {
                        appState.datos.listasActualizadas[asesor] = {
                            ciudad: ciudad || 'No especificada',
                            pdv: pdv || 'No especificado'
                        };
                    }
                }
            }
        }

        function procesarCiudadesPDV(datos) {
            for (let i = 1; i < datos.length; i++) {
                const fila = datos[i];
                if (fila.length >= 2) {
                    const ciudad = fila[0]?.trim();
                    const pdv = fila[1]?.trim();
                    
                    if (ciudad && pdv) {
                        if (!appState.datos.ciudadesPDV[ciudad]) {
                            appState.datos.ciudadesPDV[ciudad] = [];
                        }
                        appState.datos.ciudadesPDV[ciudad].push(pdv);
                    }
                }
            }
        }

        // ========== FUNCIONES B√ÅSICAS ==========
        function getTime() {
            const now = new Date();
            return now.getHours().toString().padStart(2, '0') + ':' + 
                   now.getMinutes().toString().padStart(2, '0');
        }

        function scrollToBottom() {
            setTimeout(() => {
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }

        function addBotMessage(text, customElement = null) {
            const wrapper = document.createElement('div');
            wrapper.className = 'message bot-message';

            if (!customElement) {
                const bubble = document.createElement('div');
                bubble.className = 'message-content';
                bubble.innerHTML = text;
                
                const time = document.createElement('div');
                time.className = 'message-time';
                time.textContent = getTime();
                bubble.appendChild(time);
                
                wrapper.appendChild(bubble);
            } else {
                wrapper.appendChild(customElement);
            }

            chatMessages.appendChild(wrapper);
            scrollToBottom();
            return wrapper;
        }

        function addUserMessage(text) {
            const wrapper = document.createElement('div');
            wrapper.className = 'message user-message';

            const bubble = document.createElement('div');
            bubble.className = 'message-content';
            bubble.textContent = text;

            const time = document.createElement('div');
            time.className = 'message-time';
            time.textContent = getTime();
            bubble.appendChild(time);

            wrapper.appendChild(bubble);
            chatMessages.appendChild(wrapper);
            scrollToBottom();
        }

        function showTyping() {
            const wrapper = document.createElement('div');
            wrapper.className = 'message bot-message';
            wrapper.id = 'typing';
            wrapper.innerHTML = `
                <div class="message-content">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(wrapper);
            scrollToBottom();
        }

        function hideTyping() {
            const typing = document.getElementById('typing');
            if (typing) typing.remove();
        }

        // ========== COMPONENTES ==========
        function createSelect(options, placeholder, label, onSelect) {
            const bubble = document.createElement('div');
            bubble.className = 'bubble-container';

            const selectId = 'select-' + Date.now();
            bubble.innerHTML = `
                <div class="bubble-title">${label}</div>
                <div class="custom-select">
                    <div class="select-button" id="${selectId}-btn">
                        <span id="${selectId}-text">${placeholder}</span>
                        <span style="color:#999;">‚ñº</span>
                    </div>
                    <div class="select-dropdown" id="${selectId}-dropdown">
                        <div class="select-search">
                            <input type="text" placeholder="üîç Buscar..." id="${selectId}-search">
                        </div>
                        <div class="select-options" id="${selectId}-options"></div>
                    </div>
                </div>
            `;

            setTimeout(() => {
                const btn = document.getElementById(`${selectId}-btn`);
                const dropdown = document.getElementById(`${selectId}-dropdown`);
                const search = document.getElementById(`${selectId}-search`);
                const optionsContainer = document.getElementById(`${selectId}-options`);
                const textSpan = document.getElementById(`${selectId}-text`);

                optionsContainer.innerHTML = '';

                options.forEach(opt => {
                    const optDiv = document.createElement('div');
                    optDiv.className = 'select-option';
                    optDiv.textContent = opt;
                    optDiv.onclick = () => {
                        textSpan.textContent = opt;
                        dropdown.classList.remove('active');
                        btn.classList.remove('active');
                        addUserMessage(opt);
                        if (onSelect) onSelect(opt);
                    };
                    optionsContainer.appendChild(optDiv);
                });

                btn.onclick = (e) => {
                    e.stopPropagation();
                    const isOpen = dropdown.classList.contains('active');
                    
                    document.querySelectorAll('.select-dropdown').forEach(d => d.classList.remove('active'));
                    document.querySelectorAll('.select-button').forEach(b => b.classList.remove('active'));
                    
                    if (!isOpen) {
                        dropdown.classList.add('active');
                        btn.classList.add('active');
                        setTimeout(() => search.focus(), 100);
                    }
                };

                search.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    optionsContainer.querySelectorAll('.select-option').forEach(opt => {
                        const text = opt.textContent.toLowerCase();
                        opt.style.display = text.includes(term) ? 'block' : 'none';
                    });
                });

                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.custom-select')) {
                        dropdown.classList.remove('active');
                        btn.classList.remove('active');
                    }
                });
            }, 100);

            return bubble;
        }

        function createInputBubble(label, placeholder, onSubmit, type = 'text') {
            const bubble = document.createElement('div');
            bubble.className = 'input-bubble';

            const inputId = 'input-' + Date.now();
            bubble.innerHTML = `
                <div class="input-bubble-text">${label}</div>
                <input type="${type}" class="input-field" id="${inputId}" placeholder="${placeholder}">
                <button class="send-input-btn" id="${inputId}-btn">Enviar</button>
            `;

            setTimeout(() => {
                const input = document.getElementById(inputId);
                const btn = document.getElementById(`${inputId}-btn`);

                const submitValue = () => {
                    const value = input.value.trim();
                    if (value) {
                        input.disabled = true;
                        btn.disabled = true;
                        addUserMessage(value);
                        if (onSubmit) onSubmit(value);
                    }
                };

                btn.onclick = submitValue;
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') submitValue();
                });
                
                setTimeout(() => input.focus(), 300);
            }, 100);

            return bubble;
        }

        // ========== FLUJO DE INGRESO ==========
        async function startIngresoFlow() {
            appState.currentStep = 0;
            appState.ingreso = {
                asesor: '',
                ubicacion: '',
                selfie: '',
                ciudad: '',
                puntoVenta: '',
                completado: false
            };
            
            // Esperar datos si no est√°n cargados
            if (appState.datos.asesores.length === 0) {
                showTyping();
                setTimeout(async () => {
                    hideTyping();
                    await cargarDatosIniciales();
                    mostrarSeleccionAsesorIngreso();
                }, 800);
            } else {
                mostrarSeleccionAsesorIngreso();
            }
        }

        function mostrarSeleccionAsesorIngreso() {
            showTyping();
            setTimeout(() => {
                hideTyping();
                addBotMessage('¬°Bienvenido! Vamos a registrar tu ingreso al PDV.');
                
                if (appState.datos.asesores.length === 0) {
                    addBotMessage('‚ö†Ô∏è No hay asesores disponibles.');
                    return;
                }
                
                setTimeout(() => {
                    addBotMessage('', createSelect(
                        appState.datos.asesores,
                        'Selecciona tu nombre...',
                        'üë§ Selecciona tu nombre:',
                        (asesor) => handleSeleccionAsesorIngreso(asesor)
                    ));
                }, 600);
            }, 800);
        }

        function handleSeleccionAsesorIngreso(asesorNombre) {
            appState.ingreso.asesor = asesorNombre;
            
            showTyping();
            setTimeout(() => {
                hideTyping();
                
                addBotMessage(`‚úÖ <strong>Asesor registrado:</strong> ${asesorNombre}`);
                
                // Mostrar selecci√≥n de ciudad
                const ciudades = Object.keys(appState.datos.ciudadesPDV);
                if (ciudades.length > 0) {
                    setTimeout(() => {
                        addBotMessage('', createSelect(
                            ciudades,
                            'Selecciona tu ciudad...',
                            'üìç Selecciona tu ciudad:',
                            (ciudad) => handleSeleccionCiudad(ciudad)
                        ));
                    }, 600);
                } else {
                    // Si no hay ciudades, ir directamente a captura
                    iniciarCapturaUbicacion();
                }
            }, 800);
        }

        function handleSeleccionCiudad(ciudad) {
            appState.ingreso.ciudad = ciudad;
            
            showTyping();
            setTimeout(() => {
                hideTyping();
                
                const pdvs = appState.datos.ciudadesPDV[ciudad] || [];
                
                if (pdvs.length > 0) {
                    setTimeout(() => {
                        addBotMessage('', createSelect(
                            pdvs,
                            'Selecciona el PDV...',
                            `üè™ Selecciona el punto de venta en ${ciudad}:`,
                            (pdv) => handleSeleccionPDV(pdv)
                        ));
                    }, 600);
                } else {
                    // Si no hay PDVs, pedir que se escriba
                    setTimeout(() => {
                        addBotMessage('', createInputBubble(
                            `Escribe el nombre del PDV en ${ciudad}:`,
                            'Ej: Tienda La Econom√≠a...',
                            (pdv) => handleSeleccionPDV(pdv)
                        ));
                    }, 600);
                }
            }, 800);
        }

        function handleSeleccionPDV(pdv) {
            appState.ingreso.puntoVenta = pdv;
            
            showTyping();
            setTimeout(() => {
                hideTyping();
                addBotMessage(`‚úÖ <strong>PDV registrado:</strong> ${pdv}`);
                
                // Iniciar captura de ubicaci√≥n y foto
                setTimeout(() => {
                    mostrarCapturaUbicacion();
                }, 800);
            }, 800);
        }

        function mostrarCapturaUbicacion() {
            const captureContainer = document.createElement('div');
            captureContainer.className = 'capture-container';
            captureContainer.id = 'captureContainer';

            captureContainer.innerHTML = `
                <div class="capture-title">üìç Captura de ubicaci√≥n y foto</div>
                <div class="info-text">Primero captura tu ubicaci√≥n GPS, luego puedes tomar una foto selfie.</div>
                <button class="action-button" id="locationBtn">
                    <span style="font-size:1.2em;">üìç</span> Capturar ubicaci√≥n
                </button>
                <button class="action-button camera-btn" id="cameraBtn" style="display:none;">
                    <span style="font-size:1.2em;">üì∏</span> Abrir c√°mara
                </button>
                <button class="action-button skip-btn" id="skipPhotoBtn" style="display:none;">
                    <span style="font-size:1.2em;">‚è≠Ô∏è</span> Continuar sin foto
                </button>
                <div class="info-text" id="infoText"></div>
            `;

            addBotMessage('', captureContainer);

            setTimeout(() => {
                document.getElementById('locationBtn').onclick = capturarUbicacion;
                document.getElementById('cameraBtn').onclick = abrirCamara;
                document.getElementById('skipPhotoBtn').onclick = saltarFoto;
            }, 100);
        }

        function capturarUbicacion() {
            const btn = document.getElementById('locationBtn');
            const infoText = document.getElementById('infoText');
            
            btn.disabled = true;
            btn.innerHTML = '<span style="font-size:1.2em;">‚è≥</span> Obteniendo...';
            infoText.textContent = 'Solicitando permiso de ubicaci√≥n...';

            if (!navigator.geolocation) {
                infoText.textContent = '‚ùå Tu dispositivo no soporta geolocalizaci√≥n';
                appState.ingreso.ubicacion = 'No soportado';
                mostrarOpcionesCamara();
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const coords = `${position.coords.latitude.toFixed(7)},${position.coords.longitude.toFixed(7)}`;
                    appState.ingreso.ubicacion = coords;
                    
                    btn.innerHTML = '<span style="font-size:1.2em;">‚úÖ</span> Ubicaci√≥n capturada';
                    btn.style.background = 'linear-gradient(135deg, #128c7e 0%, #075e54 100%)';
                    infoText.innerHTML = `
                        ‚úÖ <strong>Ubicaci√≥n capturada</strong><br>
                        üìç ${coords}
                    `;
                    
                    mostrarOpcionesCamara();
                },
                (error) => {
                    infoText.innerHTML = `‚ö†Ô∏è <strong>No se pudo obtener la ubicaci√≥n.</strong>`;
                    appState.ingreso.ubicacion = 'Error: ' + error.message;
                    
                    btn.disabled = false;
                    btn.innerHTML = '<span style="font-size:1.2em;">üìç</span> Reintentar';
                    
                    // Mostrar opciones de c√°mara de todas formas
                    setTimeout(() => mostrarOpcionesCamara(), 1000);
                },
                { 
                    enableHighAccuracy: true, 
                    timeout: 20000, 
                    maximumAge: 0 
                }
            );
        }

        function mostrarOpcionesCamara() {
            setTimeout(() => {
                document.getElementById('cameraBtn').style.display = 'block';
                document.getElementById('skipPhotoBtn').style.display = 'block';
                scrollToBottom();
            }, 500);
        }

        async function abrirCamara() {
            if (appState.isProcessingPhoto) return;
            
            const btn = document.getElementById('cameraBtn');
            const video = document.getElementById('videoStream');
            const infoText = document.getElementById('infoText');

            try {
                appState.isProcessingPhoto = true;
                btn.disabled = true;
                btn.innerHTML = '<span style="font-size:1.2em;">‚è≥</span> Iniciando...';
                infoText.textContent = 'Solicitando permiso de c√°mara...';

                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'user',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                });

                video.srcObject = stream;
                
                // Crear contenedor para la c√°mara
                const cameraContainer = document.createElement('div');
                cameraContainer.className = 'capture-container';
                cameraContainer.innerHTML = `
                    <div class="capture-title">üì∏ Toma tu selfie</div>
                    <video id="videoPreview" autoplay playsinline style="width:100%; border-radius:12px; margin:12px 0; transform:scaleX(-1);"></video>
                    <button class="action-button" id="capturePhotoBtn">
                        <span style="font-size:1.2em;">üì∑</span> Tomar foto
                    </button>
                    <img id="capturedPhoto" class="captured-photo" style="display:none;">
                    <div class="info-text" id="cameraInfoText"></div>
                `;
                
                addBotMessage('', cameraContainer);
                
                setTimeout(() => {
                    const videoPreview = document.getElementById('videoPreview');
                    videoPreview.srcObject = stream;
                    
                    document.getElementById('capturePhotoBtn').onclick = () => tomarFoto(stream);
                }, 100);
                
                // Ocultar botones anteriores
                btn.style.display = 'none';
                document.getElementById('skipPhotoBtn').style.display = 'none';

            } catch (error) {
                infoText.innerHTML = `
                    ‚ùå <strong>No se pudo acceder a la c√°mara.</strong><br>
                    Puedes continuar sin foto.
                `;
                
                btn.disabled = false;
                btn.innerHTML = '<span style="font-size:1.2em;">üì∏</span> Intentar de nuevo';
                appState.isProcessingPhoto = false;
            }
        }

        async function tomarFoto(stream) {
            const btn = document.getElementById('capturePhotoBtn');
            const video = document.getElementById('videoPreview');
            const canvas = document.getElementById('photoCanvas');
            const capturedImg = document.getElementById('capturedPhoto');
            const infoText = document.getElementById('cameraInfoText');

            try {
                btn.disabled = true;
                btn.innerHTML = '<span style="font-size:1.2em;">‚è≥</span> Capturando...';
                infoText.textContent = 'Capturando foto...';

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.translate(canvas.width, 0);
                ctx.scale(-1, 1);
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                // Detener c√°mara
                stream.getTracks().forEach(track => track.stop());
                
                // Simular subida exitosa
                appState.ingreso.selfie = 'Selfie capturada - ' + new Date().toLocaleString();
                
                infoText.textContent = '‚úÖ Foto capturada correctamente';
                btn.style.display = 'none';
                
                // Continuar con el flujo
                setTimeout(() => {
                    finalizarIngreso();
                }, 1500);

            } catch (error) {
                infoText.innerHTML = '‚ö†Ô∏è Error al capturar la foto. Continuando sin foto.';
                appState.ingreso.selfie = 'Error al capturar: ' + error.message;
                
                setTimeout(() => {
                    finalizarIngreso();
                }, 1500);
            } finally {
                appState.isProcessingPhoto = false;
            }
        }

        function saltarFoto() {
            appState.ingreso.selfie = 'No capturada - Usuario decidi√≥ saltar';
            finalizarIngreso();
        }

        function finalizarIngreso() {
            showTyping();
            setTimeout(() => {
                hideTyping();
                
                // Llenar formulario
                document.getElementById('asesorField').value = appState.ingreso.asesor;
                document.getElementById('ubicacionField').value = appState.ingreso.ubicacion;
                document.getElementById('selfieField').value = appState.ingreso.selfie;
                document.getElementById('ciudadField').value = appState.ingreso.ciudad;
                document.getElementById('puntoVentaField').value = appState.ingreso.puntoVenta;

                // Enviar formulario
                document.getElementById('googleFormIngreso').submit();

                addBotMessage(`
                    ‚úÖ <strong>¬°Ingreso registrado exitosamente!</strong><br><br>
                    üìã <strong>Resumen:</strong><br>
                    üë§ Asesor: ${appState.ingreso.asesor}<br>
                    üìç Ciudad: ${appState.ingreso.ciudad}<br>
                    üè™ PDV: ${appState.ingreso.puntoVenta}<br>
                    üì∏ Selfie: ${appState.ingreso.selfie.includes('No capturada') ? 'No capturada' : 'Capturada'}
                `);
                
                appState.ingreso.completado = true;
                
                // Preguntar qu√© desea hacer
                setTimeout(() => {
                    mostrarMenuPrincipal();
                }, 1500);
            }, 1500);
        }

        // ========== FLUJO LINEAL ==========
        function startLinealFlow() {
            // Resetear estado
            appState.lineal = {
                asesor: '',
                ciudad: '',
                pdv: '',
                tipoMarca: '',
                producto: '',
                numeroFrente: '',
                enviando: false
            };
            appState.currentStep = 0;
            appState.menuBloqueado = true;
            
            showTyping();
            setTimeout(() => {
                hideTyping();
                addBotMessage('üìä <strong>Registro de Participaci√≥n Lineal</strong>');
                
                // Obtener lista de asesores desde Listas_Actualizadas
                const asesoresLineal = Object.keys(appState.datos.listasActualizadas);
                
                if (asesoresLineal.length === 0) {
                    addBotMessage('‚ö†Ô∏è No hay asesores disponibles para lineal.');
                    appState.menuBloqueado = false;
                    return;
                }
                
                setTimeout(() => {
                    addBotMessage('', createSelect(
                        asesoresLineal,
                        'Selecciona el asesor...',
                        'üë§ <strong>Paso 1:</strong> Selecciona el asesor:',
                        (asesor) => handleSeleccionAsesorLineal(asesor)
                    ));
                }, 600);
            }, 800);
        }

        function handleSeleccionAsesorLineal(asesorNombre) {
            // Obtener ciudad y PDV autom√°ticamente de Listas_Actualizadas
            const infoAsesor = appState.datos.listasActualizadas[asesorNombre] || {
                ciudad: 'No encontrada',
                pdv: 'No encontrado'
            };
            
            appState.lineal.asesor = asesorNombre;
            appState.lineal.ciudad = infoAsesor.ciudad;
            appState.lineal.pdv = infoAsesor.pdv;
            
            showTyping();
            setTimeout(() => {
                hideTyping();
                
                addBotMessage(`
                    ‚úÖ <strong>Asesor registrado:</strong> ${asesorNombre}<br>
                    üìç <strong>Ciudad:</strong> ${infoAsesor.ciudad}<br>
                    üè™ <strong>PDV:</strong> ${infoAsesor.pdv}
                `);
                
                // Continuar con tipo de marca
                setTimeout(() => {
                    addBotMessage('', createSelect(
                        ['MARCA PROPIA', 'MARCA COMPETENCIA'],
                        'Selecciona el tipo...',
                        'üè∑Ô∏è <strong>Paso 2:</strong> Tipo de marca:',
                        (tipo) => handleTipoMarca(tipo)
                    ));
                }, 800);
            }, 800);
        }

        function handleTipoMarca(tipo) {
            appState.lineal.tipoMarca = tipo;
            
            showTyping();
            setTimeout(() => {
                hideTyping();
                
                addBotMessage(`‚úÖ <strong>Tipo de marca:</strong> ${tipo}`);
                
                if (tipo === 'MARCA PROPIA') {
                    const productosMarcaPropia = [
                        'ANDINA 330 ml x 6', 'ANDINA 330 ml x 24', 'ANDINA ZERO 330 ml x 6',
                        'CLUB COLOMBIA DORADA 330 ml x 6', 'CLUB COLOMBIA DORADA 330 ml x 24',
                        'POKER 330 ml x 6', 'POKER 330 ml x 24', 'PILSEN 330 ml x 6',
                        'COSTE√ëA 330 ml x 6', '√ÅGUILA 330 ml x 6', '√ÅGUILA LIGHT 330 ml x 6'
                    ];
                    
                    setTimeout(() => {
                        addBotMessage('', createSelect(
                            productosMarcaPropia,
                            'Selecciona el producto...',
                            'üì¶ <strong>Paso 3:</strong> Selecciona el producto:',
                            (producto) => handleProducto(producto)
                        ));
                    }, 600);
                } else {
                    setTimeout(() => {
                        addBotMessage('', createInputBubble(
                            'üìù <strong>Paso 3:</strong> Escribe el producto competencia:',
                            'Ej: Corona, Heineken, Budweiser...',
                            (producto) => handleProductoCompetencia(producto)
                        ));
                    }, 600);
                }
            }, 800);
        }

        function handleProducto(producto) {
            appState.lineal.producto = producto;
            
            showTyping();
            setTimeout(() => {
                hideTyping();
                
                addBotMessage(`‚úÖ <strong>Producto registrado:</strong> ${producto}`);
                
                setTimeout(() => {
                    addBotMessage('', createInputBubble(
                        'üî¢ <strong>Paso 4:</strong> N√∫mero de frentes:',
                        'Ingresa solo n√∫meros...',
                        (numero) => handleNumeroFrentes(numero),
                        'number'
                    ));
                }, 600);
            }, 800);
        }

        function handleProductoCompetencia(producto) {
            appState.lineal.producto = producto;
            
            showTyping();
            setTimeout(() => {
                hideTyping();
                
                addBotMessage(`‚úÖ <strong>Producto competencia:</strong> ${producto}`);
                
                setTimeout(() => {
                    addBotMessage('', createInputBubble(
                        'üî¢ <strong>Paso 4:</strong> N√∫mero de frentes:',
                        'Ingresa solo n√∫meros...',
                        (numero) => handleNumeroFrentesCompetencia(numero),
                        'number'
                    ));
                }, 600);
            }, 800);
        }

        function handleNumeroFrentes(numero) {
            if (!isNaN(numero) && numero.trim() !== '' && parseInt(numero) > 0) {
                appState.lineal.numeroFrente = numero.trim();
                
                showTyping();
                setTimeout(() => {
                    hideTyping();
                    mostrarConfirmacionLineal();
                }, 800);
            } else {
                addBotMessage('‚ùå Por favor ingresa un n√∫mero v√°lido mayor a 0.');
            }
        }

        function handleNumeroFrentesCompetencia(numero) {
            if (!isNaN(numero) && numero.trim() !== '' && parseInt(numero) > 0) {
                appState.lineal.numeroFrente = numero.trim();
                
                showTyping();
                setTimeout(() => {
                    hideTyping();
                    mostrarConfirmacionLinealCompetencia();
                }, 800);
            } else {
                addBotMessage('‚ùå Por favor ingresa un n√∫mero v√°lido mayor a 0.');
            }
        }

        function mostrarConfirmacionLineal() {
            const confirmBubble = document.createElement('div');
            confirmBubble.className = 'bubble-container';

            confirmBubble.innerHTML = `
                <div class="bubble-title">üìã <strong>Paso 5:</strong> Confirma los datos</div>
                <div style="background: rgba(37, 211, 102, 0.1); padding: 15px; border-radius: 12px; margin: 15px 0; border: 1px solid rgba(37, 211, 102, 0.2);">
                    <div style="margin-bottom: 10px;">
                        <strong>üë§ Asesor:</strong> ${appState.lineal.asesor}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>üìç Ciudad:</strong> ${appState.lineal.ciudad}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>üè™ PDV:</strong> ${appState.lineal.pdv}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>üè∑Ô∏è Tipo:</strong> ${appState.lineal.tipoMarca}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>üì¶ Producto:</strong> ${appState.lineal.producto}
                    </div>
                    <div>
                        <strong>üî¢ Frentes:</strong> ${appState.lineal.numeroFrente}
                    </div>
                </div>
                <div style="margin-bottom: 12px; font-size: 0.9em; color: #666;">
                    ¬øLos datos son correctos?
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="action-button" id="btnConfirmarLineal" style="flex:1;">
                        ‚úÖ S√≠, enviar
                    </button>
                    <button class="action-button skip-btn" id="btnCorregirLineal" style="flex:1;">
                        ‚ùå No, corregir
                    </button>
                </div>
            `;

            addBotMessage('', confirmBubble);

            setTimeout(() => {
                document.getElementById('btnConfirmarLineal').onclick = () => {
                    enviarFormularioLineal();
                };
                
                document.getElementById('btnCorregirLineal').onclick = () => {
                    // Volver al inicio del flujo lineal
                    const messages = document.querySelectorAll('.message');
                    for (let i = messages.length - 1; i >= 0; i--) {
                        if (messages[i].textContent.includes('Registro de Participaci√≥n Lineal')) {
                            break;
                        }
                        messages[i].remove();
                    }
                    startLinealFlow();
                };
            }, 100);
        }

        function mostrarConfirmacionLinealCompetencia() {
            const confirmBubble = document.createElement('div');
            confirmBubble.className = 'bubble-container';

            confirmBubble.innerHTML = `
                <div class="bubble-title">üìã <strong>Paso 5:</strong> Confirma los datos</div>
                <div style="background: rgba(37, 211, 102, 0.1); padding: 15px; border-radius: 12px; margin: 15px 0; border: 1px solid rgba(37, 211, 102, 0.2);">
                    <div style="margin-bottom: 10px;">
                        <strong>üë§ Asesor:</strong> ${appState.lineal.asesor}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>üìç Ciudad:</strong> ${appState.lineal.ciudad}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>üè™ PDV:</strong> ${appState.lineal.pdv}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>üè∑Ô∏è Tipo:</strong> ${appState.lineal.tipoMarca}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>üì¶ Producto:</strong> ${appState.lineal.producto}
                    </div>
                    <div>
                        <strong>üî¢ Frentes:</strong> ${appState.lineal.numeroFrente}
                    </div>
                </div>
                <div style="margin-bottom: 12px; font-size: 0.9em; color: #666;">
                    ¬øLos datos son correctos?
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="action-button" id="btnConfirmarLinealCompetencia" style="flex:1;">
                        ‚úÖ S√≠, enviar
                    </button>
                    <button class="action-button skip-btn" id="btnCorregirLinealCompetencia" style="flex:1;">
                        ‚ùå No, corregir
                    </button>
                </div>
            `;

            addBotMessage('', confirmBubble);

            setTimeout(() => {
                document.getElementById('btnConfirmarLinealCompetencia').onclick = () => {
                    enviarFormularioLinealCompetencia();
                };
                
                document.getElementById('btnCorregirLinealCompetencia').onclick = () => {
                    // Volver al inicio del flujo lineal
                    const messages = document.querySelectorAll('.message');
                    for (let i = messages.length - 1; i >= 0; i--) {
                        if (messages[i].textContent.includes('Registro de Participaci√≥n Lineal')) {
                            break;
                        }
                        messages[i].remove();
                    }
                    startLinealFlow();
                };
            }, 100);
        }

        function enviarFormularioLineal() {
            if (appState.lineal.enviando) return;
            appState.lineal.enviando = true;
            
            showTyping();
            
            setTimeout(() => {
                hideTyping();
                
                // Llenar todos los campos del formulario lineal
                document.getElementById('linealAsesorField').value = appState.lineal.asesor;
                document.getElementById('linealCiudadField').value = appState.lineal.ciudad;
                document.getElementById('linealPuntoVentaField').value = appState.lineal.pdv;
                document.getElementById('tipoMarcaField').value = appState.lineal.tipoMarca;
                document.getElementById('productoField').value = appState.lineal.producto;
                document.getElementById('numeroFrentesField').value = appState.lineal.numeroFrente;
                document.getElementById('datosCorrectosField').value = 'S√≠';
                
                // Limpiar campos de competencia si no se usan
                document.getElementById('productoCompetenciaField').value = '';
                document.getElementById('frentesCompetenciaField').value = '';
                document.getElementById('confirmacionCompetenciaField').value = '';

                // Enviar formulario
                document.getElementById('googleFormLineal').submit();

                addBotMessage(`
                    ‚úÖ <strong>¬°Participaci√≥n lineal registrada!</strong><br><br>
                    üìã <strong>Datos enviados:</strong><br>
                    üë§ Asesor: ${appState.lineal.asesor}<br>
                    üìç Ciudad: ${appState.lineal.ciudad}<br>
                    üè™ PDV: ${appState.lineal.pdv}<br>
                    üè∑Ô∏è Tipo: ${appState.lineal.tipoMarca}<br>
                    üì¶ Producto: ${appState.lineal.producto}<br>
                    üî¢ Frentes: ${appState.lineal.numeroFrente}
                `);
                
                appState.menuBloqueado = false;
                
                // Preguntar qu√© hacer
                setTimeout(() => {
                    const askBubble = document.createElement('div');
                    askBubble.className = 'bubble-container';
                    askBubble.innerHTML = `
                        <div class="bubble-title">¬øQu√© deseas hacer ahora?</div>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="action-button" id="btnOtroRegistro" style="flex:1;">
                                üìä Registrar otro
                            </button>
                            <button class="action-button camera-btn" id="btnVolverMenu" style="flex:1;">
                                üè† Men√∫ principal
                            </button>
                        </div>
                    `;
                    
                    addBotMessage('', askBubble);
                    
                    setTimeout(() => {
                        document.getElementById('btnOtroRegistro').onclick = () => {
                            startLinealFlow();
                        };
                        document.getElementById('btnVolverMenu').onclick = () => {
                            mostrarMenuPrincipal();
                        };
                    }, 100);
                }, 1000);
            }, 1500);
        }

        function enviarFormularioLinealCompetencia() {
            if (appState.lineal.enviando) return;
            appState.lineal.enviando = true;
            
            showTyping();
            
            setTimeout(() => {
                hideTyping();
                
                // Llenar todos los campos del formulario lineal
                document.getElementById('linealAsesorField').value = appState.lineal.asesor;
                document.getElementById('linealCiudadField').value = appState.lineal.ciudad;
                document.getElementById('linealPuntoVentaField').value = appState.lineal.pdv;
                document.getElementById('tipoMarcaField').value = appState.lineal.tipoMarca;
                document.getElementById('productoCompetenciaField').value = appState.lineal.producto;
                document.getElementById('frentesCompetenciaField').value = appState.lineal.numeroFrente;
                document.getElementById('confirmacionCompetenciaField').value = 'S√≠';
                
                // Limpiar campos de marca propia si no se usan
                document.getElementById('productoField').value = '';
                document.getElementById('numeroFrentesField').value = '';
                document.getElementById('datosCorrectosField').value = '';

                // Enviar formulario
                document.getElementById('googleFormLineal').submit();

                addBotMessage(`
                    ‚úÖ <strong>¬°Participaci√≥n lineal registrada!</strong><br><br>
                    üìã <strong>Datos enviados:</strong><br>
                    üë§ Asesor: ${appState.lineal.asesor}<br>
                    üìç Ciudad: ${appState.lineal.ciudad}<br>
                    üè™ PDV: ${appState.lineal.pdv}<br>
                    üè∑Ô∏è Tipo: ${appState.lineal.tipoMarca}<br>
                    üì¶ Producto: ${appState.lineal.producto}<br>
                    üî¢ Frentes: ${appState.lineal.numeroFrente}
                `);
                
                appState.menuBloqueado = false;
                
                // Preguntar qu√© hacer
                setTimeout(() => {
                    const askBubble = document.createElement('div');
                    askBubble.className = 'bubble-container';
                    askBubble.innerHTML = `
                        <div class="bubble-title">¬øQu√© deseas hacer ahora?</div>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="action-button" id="btnOtroRegistroComp" style="flex:1;">
                                üìä Registrar otro
                            </button>
                            <button class="action-button camera-btn" id="btnVolverMenuComp" style="flex:1;">
                                üè† Men√∫ principal
                            </button>
                        </div>
                    `;
                    
                    addBotMessage('', askBubble);
                    
                    setTimeout(() => {
                        document.getElementById('btnOtroRegistroComp').onclick = () => {
                            startLinealFlow();
                        };
                        document.getElementById('btnVolverMenuComp').onclick = () => {
                            mostrarMenuPrincipal();
                        };
                    }, 100);
                }, 1000);
            }, 1500);
        }

        // ========== MEN√ö PRINCIPAL ==========
        function mostrarMenuPrincipal() {
            appState.menuBloqueado = false;
            
            const menuBubble = document.createElement('div');
            menuBubble.className = 'bubble-container';
            
            menuBubble.innerHTML = `
                <div class="bubble-title">üì± Men√∫ Principal</div>
                <div class="info-text" style="margin-bottom: 15px;">
                    ¬øQu√© deseas reportar hoy?
                </div>
                <div class="menu-options" id="menuOptions">
                    <button class="menu-button" id="btnLineal">
                        <span style="font-size:1.2em;">üìä</span>
                        <div>
                            <strong>Participaci√≥n Lineal</strong><br>
                            <small style="font-size:0.8em; color:#666;">Registro de marcas en lineal</small>
                        </div>
                    </button>
                    <button class="menu-button" id="btnGaleria">
                        <span style="font-size:1.2em;">üè¨</span>
                        <div>
                            <strong>Galer√≠a PDV</strong><br>
                            <small style="font-size:0.8em; color:#666;">Fotos de puntos de venta</small>
                        </div>
                    </button>
                    <button class="menu-button" id="btnProximosVencer">
                        <span style="font-size:1.2em;">‚ö†Ô∏è</span>
                        <div>
                            <strong>Pr√≥ximos a Vencer</strong><br>
                            <small style="font-size:0.8em; color:#666;">Productos cercanos a vencimiento</small>
                        </div>
                    </button>
                    <button class="menu-button" id="btnAgotados">
                        <span style="font-size:1.2em;">üì¶</span>
                        <div>
                            <strong>Productos Agotados</strong><br>
                            <small style="font-size:0.8em; color:#666;">Inventario agotado</small>
                        </div>
                    </button>
                    <button class="menu-button" id="btnDescuentos">
                        <span style="font-size:1.2em;">üí∞</span>
                        <div>
                            <strong>Descuentos</strong><br>
                            <small style="font-size:0.8em; color:#666;">Promociones activas</small>
                        </div>
                    </button>
                    <button class="menu-button" id="btnRegistrosVentas">
                        <span style="font-size:1.2em;">üìà</span>
                        <div>
                            <strong>Registro Ventas</strong><br>
                            <small style="font-size:0.8em; color:#666;">Captura de ventas diarias</small>
                        </div>
                    </button>
                    <button class="menu-button" id="btnVozConsumidor">
                        <span style="font-size:1.2em;">üó£Ô∏è</span>
                        <div>
                            <strong>Voz Consumidor</strong><br>
                            <small style="font-size:0.8em; color:#666;">Feedback de clientes</small>
                        </div>
                    </button>
                    <button class="menu-button" id="btnNuevoIngreso">
                        <span style="font-size:1.2em;">üîÑ</span>
                        <div>
                            <strong>Nuevo Ingreso PDV</strong><br>
                            <small style="font-size:0.8em; color:#666;">Registro inicial en PDV</small>
                        </div>
                    </button>
                </div>
            `;

            addBotMessage('', menuBubble);

            setTimeout(() => {
                const actions = {
                    btnLineal: () => {
                        if (appState.menuBloqueado) return;
                        addUserMessage('üìä Participaci√≥n Lineal');
                        startLinealFlow();
                    },
                    btnGaleria: () => {
                        addUserMessage('üè¨ Galer√≠a PDV');
                        showTyping();
                        setTimeout(() => {
                            hideTyping();
                            addBotMessage('üîß <strong>Galer√≠a PDV</strong><br><br>Pr√≥ximamente podr√°s subir y ver fotos de puntos de venta.');
                        }, 800);
                    },
                    btnProximosVencer: () => {
                        addUserMessage('‚ö†Ô∏è Pr√≥ximos a Vencer');
                        showTyping();
                        setTimeout(() => {
                            hideTyping();
                            addBotMessage('üîß <strong>Pr√≥ximos a Vencer</strong><br><br>Pr√≥ximamente podr√°s registrar productos con fechas cercanas.');
                        }, 800);
                    },
                    btnAgotados: () => {
                        addUserMessage('üì¶ Productos Agotados');
                        showTyping();
                        setTimeout(() => {
                            hideTyping();
                            addBotMessage('üîß <strong>Productos Agotados</strong><br><br>Pr√≥ximamente podr√°s reportar inventario agotado.');
                        }, 800);
                    },
                    btnDescuentos: () => {
                        addUserMessage('üí∞ Descuentos');
                        showTyping();
                        setTimeout(() => {
                            hideTyping();
                            addBotMessage('üîß <strong>Descuentos</strong><br><br>Pr√≥ximamente podr√°s registrar promociones activas.');
                        }, 800);
                    },
                    btnRegistrosVentas: () => {
                        addUserMessage('üìà Registro Ventas');
                        showTyping();
                        setTimeout(() => {
                            hideTyping();
                            addBotMessage('üîß <strong>Registro de Ventas</strong><br><br>Pr√≥ximamente podr√°s capturar ventas diarias.');
                        }, 800);
                    },
                    btnVozConsumidor: () => {
                        addUserMessage('üó£Ô∏è Voz Consumidor');
                        showTyping();
                        setTimeout(() => {
                            hideTyping();
                            addBotMessage('üîß <strong>Voz del Consumidor</strong><br><br>Pr√≥ximamente podr√°s capturar feedback de clientes.');
                        }, 800);
                    },
                    btnNuevoIngreso: () => {
                        if (confirm('¬øIniciar nuevo registro de ingreso al PDV?')) {
                            startIngresoFlow();
                        }
                    }
                };

                Object.keys(actions).forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) btn.onclick = actions[id];
                });
            }, 100);
        }

        // ========== INICIALIZACI√ìN ==========
        async function initChat() {
            addBotMessage(`
                üç∫ <strong>¬°Bienvenido al Asistente PDV Beer!</strong><br><br>
                Sistema integral para registro de puntos de venta.
            `);
            
            // Cargar datos iniciales
            await cargarDatosIniciales();
            
            setTimeout(() => {
                // Iniciar flujo de ingreso
                startIngresoFlow();
            }, 1000);
        }

        // Iniciar cuando cargue la p√°gina
        window.addEventListener('DOMContentLoaded', initChat);

    </script>
</body>
</html>
