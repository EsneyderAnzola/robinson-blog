<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PDV - Asistente | Chatbot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #e5ddd5;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            overflow: hidden;
        }

        .background-pattern {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400"><defs><pattern id="pattern" x="0" y="0" width="40" height="40" patternUnits="userSpaceOnUse"><path d="M0 20 Q10 10 20 20 T40 20" stroke="%23d9d9d9" stroke-width="0.5" fill="none" opacity="0.4"/></pattern></defs><rect width="400" height="400" fill="%23e5ddd5"/><rect width="400" height="400" fill="url(%23pattern)"/></svg>');
        }

        .chat-container {
            width: 100%;
            max-width: 100%;
            height: 100vh;
            background: #e5ddd5;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
        }

        .chat-header {
            background: #075e54;
            color: white;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd700 0%, #ffb800 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            flex-shrink: 0;
        }

        .header-info {
            flex: 1;
        }

        .header-name {
            font-size: 1.05em;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .header-status {
            font-size: 0.75em;
            color: rgba(255,255,255,0.8);
        }

        .chat-messages {
            flex: 1;
            padding: 12px 8px 80px;
            overflow-y: auto;
            background: #e5ddd5;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400"><defs><pattern id="pattern" x="0" y="0" width="40" height="40" patternUnits="userSpaceOnUse"><path d="M0 20 Q10 10 20 20 T40 20" stroke="%23d9d9d9" stroke-width="0.5" fill="none" opacity="0.4"/></pattern></defs><rect width="400" height="400" fill="%23e5ddd5"/><rect width="400" height="400" fill="url(%23pattern)"/></svg>');
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(134, 150, 160, 0.4);
            border-radius: 3px;
        }

        .message {
            margin-bottom: 12px;
            display: flex;
            animation: fadeIn 0.3s ease;
            padding: 0 4px;
            flex-direction: column;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-content {
            max-width: 80%;
            position: relative;
        }

        .bot-message {
            align-items: flex-start;
        }

        .bot-message .message-content {
            background: white;
            padding: 8px 12px;
            border-radius: 0 8px 8px 8px;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
            color: #303030;
        }

        .user-message {
            align-items: flex-end;
        }

        .user-message .message-content {
            background: #dcf8c6;
            padding: 8px 12px;
            border-radius: 8px 0 8px 8px;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
            margin-left: auto;
            color: #303030;
        }

        .message-time {
            font-size: 0.65em;
            color: #667781;
            text-align: right;
            margin-top: 4px;
        }

        .select-bubble {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(30px) saturate(200%);
            -webkit-backdrop-filter: blur(30px) saturate(200%);
            padding: 10px 12px 12px;
            border-radius: 0 8px 8px 8px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.6);
            border: 1.5px solid rgba(255, 255, 255, 0.5);
            max-width: 85%;
            margin-top: 8px;
        }

        .select-bubble-text {
            margin-bottom: 10px;
            font-size: 0.95em;
            color: #303030;
            font-weight: 500;
        }

        .custom-select {
            position: relative;
            width: 100%;
        }

        .select-button {
            width: 100%;
            padding: 12px 14px;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(35px);
            -webkit-backdrop-filter: blur(35px);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 10px;
            color: #303030;
            font-size: 0.9em;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .select-button:active {
            transform: scale(0.98);
        }

        .select-button.active {
            border-color: rgba(37, 211, 102, 0.7);
            background: rgba(255, 255, 255, 0.6);
        }

        .select-arrow {
            transition: transform 0.3s;
            font-size: 0.8em;
            color: #667781;
        }

        .select-button.active .select-arrow {
            transform: rotate(180deg);
        }

        .select-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.55);
            backdrop-filter: blur(50px);
            -webkit-backdrop-filter: blur(50px);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 14px;
            max-height: 0;
            overflow: hidden;
            transition: all 0.4s;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .select-dropdown.active {
            max-height: 250px;
            overflow-y: auto;
            padding: 10px;
        }

        .select-dropdown::-webkit-scrollbar {
            width: 5px;
        }

        .select-dropdown::-webkit-scrollbar-thumb {
            background: rgba(37, 211, 102, 0.4);
            border-radius: 10px;
        }

        .select-search {
            position: sticky;
            top: 0;
            padding: 8px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(25px);
            z-index: 10;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 10px 10px 0 0;
            margin: -2px -2px 8px;
        }

        .select-search input {
            width: 100%;
            padding: 10px 12px;
            background: rgba(240, 240, 240, 0.4);
            border: 1.5px solid rgba(255, 255, 255, 0.4);
            border-radius: 8px;
            color: #303030;
            font-size: 0.9em;
            outline: none;
        }

        .select-search input:focus {
            border-color: rgba(37, 211, 102, 0.6);
        }

        .select-option {
            padding: 11px 12px;
            color: #303030;
            cursor: pointer;
            border-radius: 9px;
            margin: 3px 0;
            transition: all 0.25s;
            font-size: 0.9em;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .select-option:hover {
            background: rgba(37, 211, 102, 0.18);
            border-color: rgba(37, 211, 102, 0.4);
            transform: translateX(3px);
        }

        .select-option:active {
            transform: scale(0.97);
        }

        .capture-container {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            padding: 12px;
            border-radius: 0 8px 8px 8px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
            border: 1.5px solid rgba(255, 255, 255, 0.5);
            max-width: 85%;
            margin-top: 8px;
        }

        .capture-title {
            font-size: 0.95em;
            color: #303030;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .action-button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #25d366 0%, #20ba5a 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
            margin-bottom: 8px;
        }

        .action-button:active {
            transform: scale(0.98);
        }

        .action-button:disabled {
            background: linear-gradient(135deg, #b0b0b0 0%, #999999 100%);
            cursor: not-allowed;
        }

        .action-button.camera-btn {
            background: linear-gradient(135deg, #2196F3 0%, #0b7dda 100%);
        }

        video {
            width: 100%;
            border-radius: 10px;
            margin: 8px 0;
            transform: scaleX(-1);
            display: none;
        }

        .captured-photo {
            width: 100%;
            border-radius: 10px;
            margin-top: 8px;
            display: none;
        }

        .info-text {
            font-size: 0.85em;
            color: #667781;
            margin-top: 8px;
            text-align: center;
        }

        .chat-input-area {
            padding: 8px;
            background: #f0f0f0;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            flex-shrink: 0;
        }

        .input-wrapper {
            flex: 1;
            background: white;
            border-radius: 21px;
            display: flex;
            align-items: center;
            padding: 8px 15px;
        }

        #userInput {
            flex: 1;
            border: none;
            outline: none;
            font-size: 0.95em;
            background: transparent;
            color: #303030;
        }

        #sendBtn {
            width: 42px;
            height: 42px;
            background: #25d366;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            transition: all 0.2s;
        }

        #sendBtn:active {
            transform: scale(0.95);
        }

        #sendBtn:disabled {
            background: #b0b0b0;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667781;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }

        .menu-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .menu-button {
            padding: 12px;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(25px);
            border: 1.5px solid rgba(255, 255, 255, 0.4);
            border-radius: 10px;
            color: #303030;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s;
        }

        .menu-button:active {
            transform: scale(0.98);
            background: rgba(37, 211, 102, 0.2);
        }

        .input-field {
            width: 100%;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(25px);
            border: 1.5px solid rgba(255, 255, 255, 0.4);
            border-radius: 8px;
            color: #303030;
            font-size: 0.9em;
            outline: none;
            margin-top: 8px;
        }

        .input-field:focus {
            border-color: rgba(37, 211, 102, 0.6);
        }

        @media (min-width: 768px) {
            .chat-container {
                max-width: 500px;
                height: 700px;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            }

            .chat-header {
                border-radius: 12px 12px 0 0;
            }
        }
    </style>
</head>
<body>
    <div class="background-pattern"></div>
    <div class="chat-container">
        <div class="chat-header">
            <div class="header-avatar">üç∫</div>
            <div class="header-info">
                <div class="header-name">Asistente PDV Beer</div>
                <div class="header-status">en l√≠nea</div>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages"></div>

        <div class="chat-input-area">
            <div class="input-wrapper">
                <input type="text" id="userInput" placeholder="Mensaje" disabled>
            </div>
            <button id="sendBtn" disabled>‚û§</button>
        </div>
    </div>

    <video id="videoStream" autoplay playsinline></video>
    <canvas id="photoCanvas" style="display:none;"></canvas>

    <iframe name="hidden_iframe" style="display:none;"></iframe>

    <!-- Formulario de Ingreso -->
    <form id="googleFormIngreso" 
          action="https://docs.google.com/forms/d/e/1FAIpQLSc0Kt8C392ffQH6b5eFt-TE8-778mqqwb9tdWCt8XWqQfUgFg/formResponse" 
          target="hidden_iframe" 
          method="POST"
          style="display:none;">
        <input type="text" name="entry.1176318650" id="asesorField">
        <input type="text" name="entry.735888429" id="ubicacionField">
        <input type="text" name="entry.363650812" id="selfieField">
        <input type="text" name="entry.704645502" id="ciudadField">
        <input type="text" name="entry.732551510" id="puntoVentaField">
        <input type="text" name="entry.1281420665" id="confirmacionField" value="S√≠, es correcta">
    </form>

    <!-- Formulario de Participaci√≥n Lineal -->
    <form id="googleFormLineal"
          action="https://docs.google.com/forms/d/e/1FAIpQLScieYTjkAlXma8QLdmMQD2q-gcQb3h8fBWlw1kAWdHrLs8Vow/formResponse"
          target="hidden_iframe"
          method="POST"
          style="display:none;">
        <input type="text" name="entry.238753566" id="tipoMarcaField">
        <input type="text" name="entry.536323816" id="productoField">
        <input type="text" name="entry.857124037" id="competidorField">
        <input type="text" name="entry.1743244481" id="frentesField">
    </form>

    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyCvuZE34DkSCMy7Z_dr7DEaye3a2K2nArlePMG8QuFnxBSjduy4OK8pB1eUR9Nb4PI/exec';

        const formDataIngreso = {
            asesor: '',
            ubicacion: '',
            selfie: '',
            ciudad: '',
            puntoVenta: ''
        };

        const formDataLineal = {
            tipoMarca: '',
            producto: '',
            competidor: '',
            frentes: ''
        };

        const asesores = [
            'Juan David Benavides Gonz√°lez', 'Robinson Esneyder Zapata Anzola',
            'Sheyla Carolina G√≥mez Pati√±o', 'Harlinton Roisel Ortega Nieves',
            'Maria Paula Contreras', 'Leidy Jhoanna Restrepo Zapata',
            'Daniela Andrea Calvo Corena', 'Yadina Villanueva Sibaja',
            'Sandra Viviana Zapata Viafara', 'Stefany Bernal Tique',
            'Angie Vanessa Valenciano Romero', 'Sara Florez Velez',
            'Sara Posso Quintero', 'Juliet Lasso Ramirez',
            'Jenny Marcela Jaramillo Mejia', 'David Lopez Cardenas',
            'Ashly Valentina Montoya Rincon', 'Jaime Andres Castro Diaz',
            'Sergio Alejandro Murillo Gonzales'
        ];

        const ciudades = [
            'Arjona', 'Armenia', 'Barranquilla', 'Cali', 'Cartagena', 'Fusagasug√°',
            'Girardot', 'Guadalajara De Buga', 'Jamundi', 'La Mesa', 'Malambo',
            'Manizales', 'Melgar', 'Neiva', 'Palmira', 'Pereira', 'Pereira- Dosquebradas',
            'Popayan', 'Soledad', 'Tulua', 'Tunja', 'Turbaco', 'Villavicencio',
            'Yumbo', 'Ibagu√©'
        ];

        const puntosVenta = [
            'STO 116 ARJONA', 'Ex 065 Exito Unicentro Armenia',
            'Carulla Feria De Los Platanos', 'Sa 358 Portal Del Quindio',
            'Sa 366 San Diego', 'Si 4235 Super Inter Las Americas',
            'Ex 628 Exito Armenia', 'Si 4239 Super Inter Armenia Plaza',
            'Oxxo Esquina Laureles', 'St 355 Armenia Norte'
        ];

        const productos = [
            'ANDINA LIGHT 330 ml x 6',
            'CLUB COLOMBIA 330 ml',
            'AGUILA 330 ml',
            'POKER 330 ml',
            'PILSEN 330 ml'
        ];

        let currentModule = '';
        let currentStep = 0;
        let videoStream = null;
        let photoBase64 = null;

        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');

        function getTime() {
            const now = new Date();
            return now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
        }

        function scrollToBottom() {
            setTimeout(() => chatMessages.scrollTop = chatMessages.scrollHeight, 100);
        }

        function addBotMessage(text, customElement = null) {
            const wrapper = document.createElement('div');
            wrapper.className = 'message bot-message';

            if (!customElement) {
                const bubble = document.createElement('div');
                bubble.className = 'message-content';
                bubble.innerHTML = text;

                const time = document.createElement('div');
                time.className = 'message-time';
                time.textContent = getTime();
                bubble.appendChild(time);

                wrapper.appendChild(bubble);
            } else {
                wrapper.appendChild(customElement);
            }

            chatMessages.appendChild(wrapper);
            scrollToBottom();
        }

        function addUserMessage(text) {
            const wrapper = document.createElement('div');
            wrapper.className = 'message user-message';

            const bubble = document.createElement('div');
            bubble.className = 'message-content';
            bubble.textContent = text;

            const time = document.createElement('div');
            time.className = 'message-time';
            time.textContent = getTime();
            bubble.appendChild(time);

            wrapper.appendChild(bubble);
            chatMessages.appendChild(wrapper);
            scrollToBottom();
        }

        function createSelect(options, placeholder, label, callback) {
            const bubble = document.createElement('div');
            bubble.className = 'select-bubble';

            const titleDiv = document.createElement('div');
            titleDiv.className = 'select-bubble-text';
            titleDiv.textContent = label;
            bubble.appendChild(titleDiv);

            const selectId = 'select-' + Date.now();
            const container = document.createElement('div');
            container.innerHTML = `
                <div class="custom-select">
                    <div class="select-button" id="${selectId}-btn">
                        <span id="${selectId}-text">${placeholder}</span>
                        <span class="select-arrow">‚ñº</span>
                    </div>
                    <div class="select-dropdown" id="${selectId}-dropdown">
                        <div class="select-search">
                            <input type="text" placeholder="üîç Buscar..." id="${selectId}-search">
                        </div>
                        <div class="select-options" id="${selectId}-options"></div>
                    </div>
                </div>
            `;
            bubble.appendChild(container);

            setTimeout(() => {
                const btn = document.getElementById(`${selectId}-btn`);
                const dropdown = document.getElementById(`${selectId}-dropdown`);
                const search = document.getElementById(`${selectId}-search`);
                const optionsContainer = document.getElementById(`${selectId}-options`);
                const textSpan = document.getElementById(`${selectId}-text`);

                options.forEach(opt => {
                    const optDiv = document.createElement('div');
                    optDiv.className = 'select-option';
                    optDiv.textContent = opt;
                    optDiv.onclick = () => {
                        textSpan.textContent = opt;
                        dropdown.classList.remove('active');
                        btn.classList.remove('active');
                        btn.style.pointerEvents = 'none';
                        btn.style.opacity = '0.6';
                        addUserMessage(opt);
                        callback(opt);
                    };
                    optionsContainer.appendChild(optDiv);
                });

                btn.onclick = (e) => {
                    e.stopPropagation();
                    const isOpen = dropdown.classList.contains('active');
                    document.querySelectorAll('.select-dropdown').forEach(d => d.classList.remove('active'));
                    document.querySelectorAll('.select-button').forEach(b => b.classList.remove('active'));
                    if (!isOpen) {
                        dropdown.classList.add('active');
                        btn.classList.add('active');
                        search.focus();
                    }
                };

                search.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase().normalize('NFD').replace(/[ÃÄ-ÕØ]/g, '');
                    optionsContainer.querySelectorAll('.select-option').forEach(opt => {
                        const text = opt.textContent.toLowerCase().normalize('NFD').replace(/[ÃÄ-ÕØ]/g, '');
                        opt.style.display = text.includes(term) ? 'block' : 'none';
                    });
                });

                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.custom-select')) {
                        dropdown.classList.remove('active');
                        btn.classList.remove('active');
                    }
                });
            }, 100);

            return bubble;
        }

        function createCaptureContainer() {
            const container = document.createElement('div');
            container.className = 'capture-container';
            container.id = 'captureContainer';

            container.innerHTML = `
                <div class="capture-title">Captura de ubicaci√≥n y foto:</div>
                <button class="action-button" id="locationBtn">üìç Escribir ubicaci√≥n</button>
                <button class="action-button camera-btn" id="cameraBtn" style="display:none;">üì∏ Escribir descripci√≥n foto</button>
                <div class="info-text" id="infoText"></div>
            `;

            setTimeout(() => {
                document.getElementById('locationBtn').onclick = manualLocation;
                document.getElementById('cameraBtn').onclick = manualPhoto;
            }, 100);

            return container;
        }

        function manualLocation() {
            const btn = document.getElementById('locationBtn');
            const infoText = document.getElementById('infoText');

            btn.style.display = 'none';

            const bubble = document.createElement('div');
            bubble.className = 'select-bubble';
            bubble.style.maxWidth = '85%';
            bubble.innerHTML = `
                <div class="select-bubble-text">Escribe tu ubicaci√≥n:</div>
                <input type="text" class="input-field" id="manualLocationInput" placeholder="Ej: Calle 123 #45-67">
                <button class="action-button" id="confirmLocationBtn" style="margin-top:8px;">‚úì Confirmar</button>
            `;

            chatMessages.appendChild(bubble);
            scrollToBottom();

            setTimeout(() => {
                document.getElementById('manualLocationInput').focus();
                document.getElementById('confirmLocationBtn').onclick = () => {
                    const input = document.getElementById('manualLocationInput');
                    if (input.value.trim()) {
                        formDataIngreso.ubicacion = input.value.trim();
                        addUserMessage('üìç ' + formDataIngreso.ubicacion);
                        bubble.remove();
                        infoText.textContent = '‚úì Ubicaci√≥n registrada';
                        document.getElementById('cameraBtn').style.display = 'block';
                    }
                };
            }, 100);
        }

        function manualPhoto() {
            const btn = document.getElementById('cameraBtn');
            const infoText = document.getElementById('infoText');

            btn.style.display = 'none';

            const bubble = document.createElement('div');
            bubble.className = 'select-bubble';
            bubble.style.maxWidth = '85%';
            bubble.innerHTML = `
                <div class="select-bubble-text">Describe tu foto:</div>
                <input type="text" class="input-field" id="manualPhotoInput" placeholder="Ej: Selfie en el PDV">
                <button class="action-button camera-btn" id="confirmPhotoBtn" style="margin-top:8px;">‚úì Confirmar</button>
            `;

            chatMessages.appendChild(bubble);
            scrollToBottom();

            setTimeout(() => {
                document.getElementById('manualPhotoInput').focus();
                document.getElementById('confirmPhotoBtn').onclick = () => {
                    const input = document.getElementById('manualPhotoInput');
                    if (input.value.trim()) {
                        formDataIngreso.selfie = input.value.trim();
                        addUserMessage('üì∏ ' + formDataIngreso.selfie);
                        bubble.remove();
                        infoText.textContent = '‚úì Foto registrada';

                        setTimeout(() => {
                            processIngresoResponse('captured_data');
                        }, 500);
                    }
                };
            }, 100);
        }

        function showTyping() {
            const wrapper = document.createElement('div');
            wrapper.className = 'message bot-message';
            wrapper.id = 'typing';
            wrapper.innerHTML = `
                <div class="message-content">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(wrapper);
            scrollToBottom();
        }

        function hideTyping() {
            const typing = document.getElementById('typing');
            if (typing) typing.remove();
        }

        function processIngresoResponse(response) {
            showTyping();

            setTimeout(() => {
                hideTyping();

                switch(currentStep) {
                    case 0:
                        formDataIngreso.asesor = response;
                        addBotMessage(`¬°Hola ${response.split(' ')[0]}! üëã`);
                        setTimeout(() => {
                            addBotMessage('', createCaptureContainer());
                        }, 600);
                        currentStep++;
                        break;

                    case 1:
                        addBotMessage('¬°Perfecto! ‚úÖ');
                        setTimeout(() => {
                            addBotMessage('', createSelect(ciudades, 'Selecciona tu ciudad...', 'Ahora dime tu ciudad:', (val) => processIngresoResponse(val)));
                        }, 600);
                        currentStep++;
                        break;

                    case 2:
                        formDataIngreso.ciudad = response;
                        addBotMessage('Excelente ‚úì');
                        setTimeout(() => {
                            addBotMessage('', createSelect(puntosVenta, 'Selecciona el punto de venta...', 'Por √∫ltimo, tu punto de venta:', (val) => processIngresoResponse(val)));
                        }, 600);
                        currentStep++;
                        break;

                    case 3:
                        formDataIngreso.puntoVenta = response;
                        currentStep++;
                        submitIngreso();
                        break;
                }
            }, 800);
        }

        function submitIngreso() {
            addBotMessage('Enviando tu ingreso... ‚è≥');

            document.getElementById('asesorField').value = formDataIngreso.asesor;
            document.getElementById('ubicacionField').value = formDataIngreso.ubicacion;
            document.getElementById('selfieField').value = formDataIngreso.selfie;
            document.getElementById('ciudadField').value = formDataIngreso.ciudad;
            document.getElementById('puntoVentaField').value = formDataIngreso.puntoVenta;

            setTimeout(() => {
                document.getElementById('googleFormIngreso').submit();

                setTimeout(() => {
                    addBotMessage('‚úÖ ¬°Ingreso registrado exitosamente!');
                    setTimeout(() => showMainMenu(), 800);
                }, 1000);
            }, 500);
        }

        // M√ìDULO DE PARTICIPACI√ìN LINEAL
        function startLinealModule() {
            currentModule = 'lineal';
            currentStep = 0;

            addBotMessage('Perfecto, registremos la participaci√≥n lineal. üìä');

            setTimeout(() => {
                const bubble = document.createElement('div');
                bubble.className = 'select-bubble';

                bubble.innerHTML = `
                    <div class="select-bubble-text">¬øQu√© tipo de marca vas a reportar?</div>
                    <div class="menu-options">
                        <button class="menu-button" onclick="processLinealResponse('MARCA PROPIA')">MARCA PROPIA</button>
                        <button class="menu-button" onclick="processLinealResponse('MARCA COMPETENCIA')">MARCA COMPETENCIA</button>
                    </div>
                `;

                addBotMessage('', bubble);
                currentStep = 1;
            }, 600);
        }

        function processLinealResponse(response) {
            showTyping();

            setTimeout(() => {
                hideTyping();

                switch(currentStep) {
                    case 1:
                        formDataLineal.tipoMarca = response;
                        addUserMessage(response);
                        addBotMessage('Tipo de marca registrado ‚úÖ');

                        setTimeout(() => {
                            if (response === 'MARCA PROPIA') {
                                addBotMessage('', createSelect(productos, 'Selecciona...', 'Selecciona el producto:', (val) => processLinealResponse(val)));
                            } else {
                                const bubble = document.createElement('div');
                                bubble.className = 'select-bubble';
                                bubble.innerHTML = `
                                    <div class="select-bubble-text">Escribe el nombre del competidor:</div>
                                    <input type="text" class="input-field" id="competidorInput" placeholder="Ej: Coca Cola">
                                    <button class="action-button" id="confirmCompetidorBtn" style="margin-top:8px;">‚úì Continuar</button>
                                `;
                                addBotMessage('', bubble);

                                setTimeout(() => {
                                    document.getElementById('competidorInput').focus();
                                    document.getElementById('confirmCompetidorBtn').onclick = () => {
                                        const input = document.getElementById('competidorInput');
                                        if (input.value.trim()) {
                                            formDataLineal.competidor = input.value.trim();
                                            formDataLineal.producto = 'N/A';
                                            addUserMessage(formDataLineal.competidor);
                                            processLinealResponse(formDataLineal.competidor);
                                        }
                                    };
                                }, 100);
                            }
                        }, 600);
                        currentStep = 2;
                        break;

                    case 2:
                        if (formDataLineal.tipoMarca === 'MARCA PROPIA') {
                            formDataLineal.producto = response;
                            formDataLineal.competidor = 'N/A';
                            addBotMessage('Producto registrado ‚úÖ');
                        } else {
                            addBotMessage('Competidor registrado ‚úÖ');
                        }

                        setTimeout(() => {
                            const bubble = document.createElement('div');
                            bubble.className = 'select-bubble';
                            bubble.innerHTML = `
                                <div class="select-bubble-text">¬øCu√°ntos frentes tiene en el lineal?</div>
                                <input type="number" class="input-field" id="frentesInput" placeholder="Ej: 4" min="1">
                                <button class="action-button" id="confirmFrentesBtn" style="margin-top:8px;">‚úì Enviar</button>
                            `;
                            addBotMessage('', bubble);

                            setTimeout(() => {
                                document.getElementById('frentesInput').focus();
                                document.getElementById('confirmFrentesBtn').onclick = () => {
                                    const input = document.getElementById('frentesInput');
                                    if (input.value.trim() && parseInt(input.value) > 0) {
                                        formDataLineal.frentes = input.value.trim();
                                        addUserMessage(formDataLineal.frentes + ' frentes');
                                        processLinealResponse(formDataLineal.frentes);
                                    }
                                };
                            }, 100);
                        }, 600);
                        currentStep = 3;
                        break;

                    case 3:
                        submitLineal();
                        break;
                }
            }, 800);
        }

        function submitLineal() {
            addBotMessage('Enviando reporte... ‚è≥');

            document.getElementById('tipoMarcaField').value = formDataLineal.tipoMarca;
            document.getElementById('productoField').value = formDataLineal.producto;
            document.getElementById('competidorField').value = formDataLineal.competidor;
            document.getElementById('frentesField').value = formDataLineal.frentes;

            setTimeout(() => {
                document.getElementById('googleFormLineal').submit();

                setTimeout(() => {
                    addBotMessage('‚úÖ ¬°Participaci√≥n lineal registrada!');

                    setTimeout(() => {
                        const bubble = document.createElement('div');
                        bubble.className = 'select-bubble';

                        bubble.innerHTML = `
                            <div class="select-bubble-text">¬øDeseas reportar m√°s lineales?</div>
                            <div class="menu-options">
                                <button class="menu-button" onclick="resetLinealAndStart()">S√≠, reportar otro</button>
                                <button class="menu-button" onclick="showMainMenu()">No, volver al men√∫</button>
                            </div>
                        `;

                        addBotMessage('', bubble);
                    }, 800);
                }, 1000);
            }, 500);
        }

        function resetLinealAndStart() {
            formDataLineal.tipoMarca = '';
            formDataLineal.producto = '';
            formDataLineal.competidor = '';
            formDataLineal.frentes = '';
            startLinealModule();
        }

        function showMainMenu() {
            addBotMessage('¬øQu√© deseas hacer?');

            const menuBubble = document.createElement('div');
            menuBubble.className = 'select-bubble';

            menuBubble.innerHTML = `
                <div class="menu-options">
                    <button class="menu-button" onclick="startIngresoModule()">üìù Registrar ingreso al PDV</button>
                    <button class="menu-button" onclick="startLinealModule()">üìä Participaci√≥n Lineal</button>
                </div>
            `;

            addBotMessage('', menuBubble);
        }

        function startIngresoModule() {
            currentModule = 'ingreso';
            currentStep = 0;
            addBotMessage('Perfecto, registremos tu ingreso. üìù');

            setTimeout(() => {
                addBotMessage('', createSelect(asesores, 'Selecciona tu nombre...', 'Para comenzar, selecciona tu nombre:', (val) => processIngresoResponse(val)));
            }, 600);
        }

        // Iniciar chatbot
        setTimeout(() => {
            addBotMessage('¬°Hola! üëã Bienvenido al sistema PDV Beer.');
            setTimeout(() => showMainMenu(), 800);
        }, 500);
    </script>
</body>
</html>
