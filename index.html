<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PDV - Asistente Beer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            overflow: hidden;
        }

        /* Contenedor principal del chat */
        .chat-container {
            width: 100%;
            height: 100vh;
            background: #f0f2f5;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Header del chat */
        .chat-header {
            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
            color: white;
            padding: 15px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 100;
        }

        .header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd700 0%, #ffb800 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        .header-info {
            flex: 1;
        }

        .header-name {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .header-status {
            font-size: 0.75em;
            color: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* √Årea de mensajes */
        .chat-messages {
            flex: 1;
            padding: 15px 12px 80px;
            overflow-y: auto;
            background: #f0f2f5;
            -webkit-overflow-scrolling: touch;
        }

        .chat-messages::-webkit-scrollbar {
            width: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(37, 211, 102, 0.3);
            border-radius: 2px;
        }

        /* Estilos de mensajes */
        .message {
            margin-bottom: 12px;
            display: flex;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(10px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .message-content {
            max-width: 80%;
            position: relative;
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 0.95em;
            line-height: 1.4;
        }

        .bot-message {
            justify-content: flex-start;
        }

        .bot-message .message-content {
            background: white;
            color: #111;
            border-radius: 0 18px 18px 18px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .user-message {
            justify-content: flex-end;
        }

        .user-message .message-content {
            background: linear-gradient(135deg, #25d366 0%, #20ba5a 100%);
            color: white;
            border-radius: 18px 0 18px 18px;
        }

        .message-time {
            font-size: 0.7em;
            color: rgba(0,0,0,0.4);
            margin-top: 4px;
            text-align: right;
        }

        /* Burbujas especiales */
        .bubble-container {
            background: white;
            padding: 16px;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 8px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .bubble-title {
            font-size: 0.95em;
            color: #111;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Selects mejorados para m√≥vil */
        .custom-select {
            position: relative;
            margin-bottom: 10px;
        }

        .select-button {
            width: 100%;
            padding: 14px 16px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            color: #333;
            font-size: 0.95em;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .select-button:hover {
            border-color: #25d366;
        }

        .select-button.active {
            border-color: #25d366;
            background: rgba(37, 211, 102, 0.05);
        }

        .select-dropdown {
            position: fixed;
            left: 20px;
            right: 20px;
            background: white;
            border-radius: 16px;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            z-index: 1000;
            top: 30%;
            opacity: 0;
        }

        .select-dropdown.active {
            max-height: 60vh;
            overflow-y: auto;
            padding: 15px;
            opacity: 1;
        }

        .select-search {
            position: sticky;
            top: 0;
            padding: 10px 0;
            background: white;
            z-index: 10;
            margin-bottom: 10px;
        }

        .select-search input {
            width: 100%;
            padding: 12px 16px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 0.95em;
            outline: none;
        }

        .select-option {
            padding: 14px 16px;
            color: #333;
            cursor: pointer;
            border-radius: 12px;
            margin: 4px 0;
            transition: all 0.2s;
            font-size: 0.95em;
        }

        .select-option:hover {
            background: rgba(37, 211, 102, 0.1);
            transform: translateX(5px);
        }

        /* Contenedor de captura */
        .capture-container {
            background: white;
            padding: 16px;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 8px;
        }

        .capture-title {
            font-size: 0.95em;
            color: #111;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .action-button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #25d366 0%, #20ba5a 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .action-button:active {
            transform: scale(0.98);
        }

        .action-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .action-button.camera-btn {
            background: linear-gradient(135deg, #2196F3 0%, #0b7dda 100%);
        }

        .action-button.skip-btn {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }

        /* Elementos de c√°mara */
        video {
            width: 100%;
            border-radius: 12px;
            margin: 12px 0;
            transform: scaleX(-1);
            display: none;
        }

        .captured-photo {
            width: 100%;
            border-radius: 12px;
            margin: 12px 0;
            display: none;
            border: 3px solid white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .info-text {
            font-size: 0.85em;
            color: #666;
            margin-top: 10px;
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        /* Men√∫ principal */
        .menu-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-top: 15px;
        }

        .menu-button {
            padding: 14px 16px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            color: #333;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-button:active {
            transform: scale(0.98);
            background: #e9ecef;
        }

        /* Indicador de escritura */
        .typing-indicator {
            display: flex;
            gap: 6px;
            padding: 10px 20px;
            background: white;
            border-radius: 18px;
            width: fit-content;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #25d366;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }

        /* Input bubble */
        .input-bubble {
            background: white;
            padding: 16px;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 8px;
        }

        .input-bubble-text {
            margin-bottom: 12px;
            font-size: 0.95em;
            color: #111;
            font-weight: 600;
        }

        .input-field {
            width: 100%;
            padding: 14px 16px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 0.95em;
            outline: none;
        }

        .input-field:focus {
            border-color: #25d366;
        }

        .send-input-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #25d366 0%, #20ba5a 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            margin-top: 12px;
            transition: all 0.2s;
        }

        .send-input-btn:active {
            transform: scale(0.98);
        }

        /* Modal de permisos */
        .permission-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .permission-content {
            background: white;
            padding: 25px;
            border-radius: 20px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .permission-icon {
            font-size: 3em;
            margin-bottom: 20px;
        }

        .permission-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 10px;
            color: #111;
        }

        .permission-text {
            font-size: 0.95em;
            color: #666;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .permission-buttons {
            display: flex;
            gap: 10px;
        }

        .permission-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .permission-btn.allow {
            background: linear-gradient(135deg, #25d366 0%, #20ba5a 100%);
            color: white;
        }

        .permission-btn.deny {
            background: #f8f9fa;
            color: #666;
        }

        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
            
            .chat-container {
                max-width: 450px;
                height: 800px;
                border-radius: 20px;
                overflow: hidden;
                box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="header-avatar">üç∫</div>
            <div class="header-info">
                <div class="header-name">Asistente PDV Beer</div>
                <div class="header-status">
                    <div class="status-dot"></div>
                    en l√≠nea
                </div>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages"></div>
    </div>

    <!-- Elementos multimedia ocultos -->
    <video id="videoStream" autoplay playsinline style="display:none;"></video>
    <canvas id="photoCanvas" style="display:none;"></canvas>

    <!-- Formularios ocultos -->
    <iframe name="hidden_iframe_ingreso" style="display:none;"></iframe>
    <form id="googleFormIngreso" 
          action="https://docs.google.com/forms/d/e/1FAIpQLSc0Kt8C392ffQH6b5eFt-TE8-778mqqwb9tdWCt8XWqQfUgFg/formResponse" 
          target="hidden_iframe_ingreso" 
          method="POST"
          style="display:none;">
        <input type="text" name="entry.1176318650" id="asesorField">
        <input type="text" name="entry.735888429" id="ubicacionField">
        <input type="text" name="entry.363650812" id="selfieField">
        <input type="text" name="entry.704645502" id="ciudadField">
        <input type="text" name="entry.732551510" id="puntoVentaField">
        <input type="text" name="entry.1281420665" id="confirmacionField" value="S√≠, es correcta">
    </form>

    <iframe name="hidden_iframe_lineal" style="display:none;"></iframe>
    <form id="googleFormLineal" 
          action="https://docs.google.com/forms/d/e/1FAIpQLScieYTjkAlXma8QLdmMQD2q-gcQb3h8fBWlw1kAWdHrLs8Vow/formResponse" 
          target="hidden_iframe_lineal" 
          method="POST"
          style="display:none;">
        <input type="text" name="entry.238753566" id="tipoMarcaField">
        <input type="text" name="entry.536323816" id="productoField">
        <input type="text" name="entry.857124037" id="numeroFrentesField">
        <input type="text" name="entry.1305667853" id="datosCorrectosField" value="S√≠">
    </form>

    <script>
        // URL de tu Google Apps Script
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzbtsvCZ_S8qB58t8RflN9Af9S4h1H5zPzBbkHyQVpQHj07_Oa-HDbekdx8Dz8hF_qC/exec';

        // Variables globales
        let formDataIngreso = {
            asesor: '',
            ubicacion: '',
            selfie: '',
            ciudad: '',
            puntoVenta: ''
        };

        let formDataLineal = {
            tipoMarca: '',
            producto: '',
            numeroFrente: ''
        };

        // Base de datos
        const asesores = [
            'Juan David Benavides Gonz√°lez', 'Robinson Esneyder Zapata Anzola',
            'Sheyla Carolina G√≥mez Pati√±o', 'Harlinton Roisel Ortega Nieves',
            'Maria Paula Contreras', 'Leidy Jhoanna Restrepo Zapata',
            'Daniela Andrea Calvo Corena', 'Yadina Villanueva Sibaja',
            'Sandra Viviana Zapata Viafara', 'Stefany Bernal Tique',
            'Angie Vanessa Valenciano Romero', 'Sara Florez Velez',
            'Sara Posso Quintero', 'Juliet Lasso Ramirez',
            'Jenny Marcela Jaramillo Mejia', 'David Lopez Cardenas',
            'Ashly Valentina Montoya Rincon', 'Jaime Andres Castro Diaz',
            'Sergio Alejandro Murillo Gonzales'
        ];

        const ciudadesPuntosVenta = {
            'Arjona': ['STO 116 ARJONA'],
            'Armenia': [
                'Ex 065 Exito Unicentro Armenia',
                'Sa 358 Portal Del Quindio',
                'Sa 366 San Diego',
                'Ex 628 Exito Armenia',
                'Si 4239 Super Inter Armenia Plaza',
                'St 355 Armenia Norte'
            ],
            'Barranquilla': ['Carulla Feria De Los Platanos'],
            'Cali': ['Si 4235 Super Inter Las Americas'],
            'Cartagena': ['CC Caribe Plaza', 'CC Bocagrande'],
            'Fusagasug√°': ['√âxito Fusagasug√°'],
            'Girardot': ['Metro Girardot'],
            'Guadalajara De Buga': ['√âxito Buga'],
            'Jamundi': ['Supermercados Jamund√≠'],
            'La Mesa': ['Almacenes La Mesa'],
            'Malambo': ['Makro Malambo'],
            'Manizales': ['√âxito Manizales', 'Carulla Manizales'],
            'Melgar': ['Metro Melgar'],
            'Neiva': ['√âxito Neiva', 'Jumbo Neiva'],
            'Palmira': ['Metro Palmira'],
            'Pereira': ['√âxito Pereira', 'Sanandresito Pereira'],
            'Pereira- Dosquebradas': ['Makro Dosquebradas'],
            'Popayan': ['√âxito Popay√°n'],
            'Soledad': ['Metro Soledad', 'Makro Soledad'],
            'Tulua': ['√âxito Tulu√°', 'Carulla Tulu√°'],
            'Tunja': ['√âxito Tunja'],
            'Turbaco': ['Almacenes Turbaco'],
            'Villavicencio': ['√âxito Villavicencio', 'Jumbo Villavicencio'],
            'Yumbo': ['√âxito Yumbo'],
            'Ibagu√©': ['√âxito Ibagu√©', 'Carulla Ibagu√©']
        };

        const productosMarcaPropia = [
            'ANDINA 330 ml x 6', 'ANDINA 330 ml x 24', 'ANDINA ZERO 330 ml x 6',
            'CLUB COLOMBIA DORADA 330 ml x 6', 'CLUB COLOMBIA DORADA 330 ml x 24',
            'POKER 330 ml x 6', 'POKER 330 ml x 24', 'PILSEN 330 ml x 6',
            'COSTE√ëA 330 ml x 6', '√ÅGUILA 330 ml x 6', '√ÅGUILA LIGHT 330 ml x 6'
        ];

        let currentFlow = '';
        let currentStep = 0;
        let videoStream = null;
        let photoBase64 = null;
        let photoSkipped = false;
        let isProcessingPhoto = false;

        const chatMessages = document.getElementById('chatMessages');

        // ========== FUNCIONES B√ÅSICAS ==========
        function getTime() {
            const now = new Date();
            return now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
        }

        function scrollToBottom() {
            setTimeout(() => {
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }

        function addBotMessage(text, customElement = null) {
            const wrapper = document.createElement('div');
            wrapper.className = 'message bot-message';

            if (!customElement) {
                const bubble = document.createElement('div');
                bubble.className = 'message-content';
                bubble.innerHTML = text;
                
                const time = document.createElement('div');
                time.className = 'message-time';
                time.textContent = getTime();
                bubble.appendChild(time);
                
                wrapper.appendChild(bubble);
            } else {
                wrapper.appendChild(customElement);
            }

            chatMessages.appendChild(wrapper);
            scrollToBottom();
            return wrapper;
        }

        function addUserMessage(text) {
            const wrapper = document.createElement('div');
            wrapper.className = 'message user-message';

            const bubble = document.createElement('div');
            bubble.className = 'message-content';
            bubble.textContent = text;

            const time = document.createElement('div');
            time.className = 'message-time';
            time.textContent = getTime();
            bubble.appendChild(time);

            wrapper.appendChild(bubble);
            chatMessages.appendChild(wrapper);
            scrollToBottom();
        }

        function showTyping() {
            const wrapper = document.createElement('div');
            wrapper.className = 'message bot-message';
            wrapper.id = 'typing';
            wrapper.innerHTML = `
                <div class="message-content">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(wrapper);
            scrollToBottom();
        }

        function hideTyping() {
            const typing = document.getElementById('typing');
            if (typing) typing.remove();
        }

        // ========== COMPONENTES ==========
        function createSelect(options, placeholder, label, onSelect) {
            const bubble = document.createElement('div');
            bubble.className = 'bubble-container';

            const selectId = 'select-' + Date.now();
            bubble.innerHTML = `
                <div class="bubble-title">${label}</div>
                <div class="custom-select">
                    <div class="select-button" id="${selectId}-btn">
                        <span id="${selectId}-text">${placeholder}</span>
                        <span style="color:#999;">‚ñº</span>
                    </div>
                    <div class="select-dropdown" id="${selectId}-dropdown">
                        <div class="select-search">
                            <input type="text" placeholder="üîç Buscar..." id="${selectId}-search">
                        </div>
                        <div class="select-options" id="${selectId}-options"></div>
                    </div>
                </div>
            `;

            setTimeout(() => {
                const btn = document.getElementById(`${selectId}-btn`);
                const dropdown = document.getElementById(`${selectId}-dropdown`);
                const search = document.getElementById(`${selectId}-search`);
                const optionsContainer = document.getElementById(`${selectId}-options`);
                const textSpan = document.getElementById(`${selectId}-text`);

                options.forEach(opt => {
                    const optDiv = document.createElement('div');
                    optDiv.className = 'select-option';
                    optDiv.textContent = opt;
                    optDiv.onclick = () => {
                        textSpan.textContent = opt;
                        dropdown.classList.remove('active');
                        btn.classList.remove('active');
                        addUserMessage(opt);
                        if (onSelect) onSelect(opt);
                    };
                    optionsContainer.appendChild(optDiv);
                });

                btn.onclick = (e) => {
                    e.stopPropagation();
                    const isOpen = dropdown.classList.contains('active');
                    
                    document.querySelectorAll('.select-dropdown').forEach(d => d.classList.remove('active'));
                    document.querySelectorAll('.select-button').forEach(b => b.classList.remove('active'));
                    
                    if (!isOpen) {
                        dropdown.classList.add('active');
                        btn.classList.add('active');
                        
                        setTimeout(() => search.focus(), 100);
                        
                        // Posicionar dropdown para m√≥vil
                        setTimeout(() => {
                            dropdown.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 50);
                    }
                };

                search.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    optionsContainer.querySelectorAll('.select-option').forEach(opt => {
                        const text = opt.textContent.toLowerCase();
                        opt.style.display = text.includes(term) ? 'block' : 'none';
                    });
                });

                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.custom-select')) {
                        dropdown.classList.remove('active');
                        btn.classList.remove('active');
                    }
                });
            }, 100);

            return bubble;
        }

        function createInputBubble(label, placeholder, onSubmit, type = 'text') {
            const bubble = document.createElement('div');
            bubble.className = 'input-bubble';

            const inputId = 'input-' + Date.now();
            bubble.innerHTML = `
                <div class="input-bubble-text">${label}</div>
                <input type="${type}" class="input-field" id="${inputId}" placeholder="${placeholder}">
                <button class="send-input-btn" id="${inputId}-btn">Enviar</button>
            `;

            setTimeout(() => {
                const input = document.getElementById(inputId);
                const btn = document.getElementById(`${inputId}-btn`);

                const submitValue = () => {
                    const value = input.value.trim();
                    if (value) {
                        input.disabled = true;
                        btn.disabled = true;
                        addUserMessage(value);
                        if (onSubmit) onSubmit(value);
                    }
                };

                btn.onclick = submitValue;
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') submitValue();
                });
                
                setTimeout(() => input.focus(), 300);
            }, 100);

            return bubble;
        }

        // ========== CAPTURA DE FOTO CON GAS ==========
        function createCaptureContainer() {
            const container = document.createElement('div');
            container.className = 'capture-container';
            container.id = 'captureContainer';

            container.innerHTML = `
                <div class="capture-title">üìç Captura de ubicaci√≥n y foto</div>
                <div class="info-text">Primero captura tu ubicaci√≥n GPS, luego puedes tomar una foto selfie.</div>
                <button class="action-button" id="locationBtn">
                    <span style="font-size:1.2em;">üìç</span> Capturar ubicaci√≥n
                </button>
                <button class="action-button camera-btn" id="cameraBtn" style="display:none;">
                    <span style="font-size:1.2em;">üì∏</span> Abrir c√°mara
                </button>
                <button class="action-button skip-btn" id="skipPhotoBtn" style="display:none;">
                    <span style="font-size:1.2em;">‚è≠Ô∏è</span> Continuar sin foto
                </button>
                <video id="videoPreview" autoplay playsinline style="display:none;"></video>
                <button class="action-button" id="capturePhotoBtn" style="display:none;">
                    <span style="font-size:1.2em;">üì∑</span> Tomar foto
                </button>
                <img id="capturedPhoto" class="captured-photo" style="display:none;">
                <div class="info-text" id="infoText"></div>
            `;

            setTimeout(() => {
                document.getElementById('locationBtn').onclick = captureLocation;
                document.getElementById('cameraBtn').onclick = openCamera;
                document.getElementById('skipPhotoBtn').onclick = skipPhoto;
                document.getElementById('capturePhotoBtn').onclick = takePhoto;
            }, 100);

            return container;
        }

        function captureLocation() {
            const btn = document.getElementById('locationBtn');
            const infoText = document.getElementById('infoText');
            
            btn.disabled = true;
            btn.innerHTML = '<span style="font-size:1.2em;">‚è≥</span> Obteniendo...';
            infoText.textContent = 'Solicitando permiso de ubicaci√≥n...';

            if (!navigator.geolocation) {
                infoText.textContent = '‚ùå Tu dispositivo no soporta geolocalizaci√≥n';
                btn.disabled = false;
                btn.innerHTML = '<span style="font-size:1.2em;">üìç</span> Capturar ubicaci√≥n';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const coords = `${position.coords.latitude.toFixed(7)},${position.coords.longitude.toFixed(7)}`;
                    formDataIngreso.ubicacion = coords;
                    
                    btn.innerHTML = '<span style="font-size:1.2em;">‚úÖ</span> Ubicaci√≥n capturada';
                    btn.style.background = 'linear-gradient(135deg, #128c7e 0%, #075e54 100%)';
                    infoText.innerHTML = `
                        ‚úÖ <strong>Ubicaci√≥n capturada</strong><br>
                        üìç ${coords}<br>
                        üéØ Precisi√≥n: ${Math.round(position.coords.accuracy)}m
                    `;
                    
                    setTimeout(() => {
                        document.getElementById('cameraBtn').style.display = 'block';
                        document.getElementById('skipPhotoBtn').style.display = 'block';
                        scrollToBottom();
                    }, 500);
                },
                (error) => {
                    let errorMsg = 'Error desconocido';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'Permiso denegado. Por favor, activa la ubicaci√≥n en la configuraci√≥n de tu navegador.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'Ubicaci√≥n no disponible. Activa el GPS y verifica tu conexi√≥n.';
                            break;
                        case error.TIMEOUT:
                            errorMsg = 'Tiempo agotado. Verifica tu GPS e intenta nuevamente.';
                            break;
                    }
                    
                    infoText.innerHTML = `‚ùå ${errorMsg}`;
                    btn.disabled = false;
                    btn.innerHTML = '<span style="font-size:1.2em;">üìç</span> Reintentar';
                },
                { 
                    enableHighAccuracy: true, 
                    timeout: 20000, 
                    maximumAge: 0 
                }
            );
        }

        async function openCamera() {
            if (isProcessingPhoto) return;
            
            const btn = document.getElementById('cameraBtn');
            const video = document.getElementById('videoPreview');
            const infoText = document.getElementById('infoText');

            try {
                isProcessingPhoto = true;
                btn.disabled = true;
                btn.innerHTML = '<span style="font-size:1.2em;">‚è≥</span> Iniciando...';
                infoText.textContent = 'Solicitando permiso de c√°mara...';

                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'user',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                });

                video.srcObject = videoStream;
                video.style.display = 'block';
                
                btn.style.display = 'none';
                document.getElementById('skipPhotoBtn').style.display = 'none';
                document.getElementById('capturePhotoBtn').style.display = 'block';
                infoText.textContent = '‚úÖ C√°mara lista. Posiciona tu rostro en el centro y presiona "Tomar foto".';
                scrollToBottom();

            } catch (error) {
                infoText.innerHTML = `
                    ‚ùå <strong>No se pudo acceder a la c√°mara.</strong><br>
                    Posibles causas:<br>
                    1. Permisos de c√°mara denegados<br>
                    2. Otra app est√° usando la c√°mara<br>
                    3. Problemas t√©cnicos
                `;
                
                btn.disabled = false;
                btn.innerHTML = '<span style="font-size:1.2em;">üì∏</span> Intentar de nuevo';
                isProcessingPhoto = false;
            }
        }

        function skipPhoto() {
            if (isProcessingPhoto) return;
            
            photoSkipped = true;
            formDataIngreso.selfie = 'No capturada - Usuario decidi√≥ saltar';
            addUserMessage('‚è≠Ô∏è Continuar sin foto');
            processIngresoResponse('skipped_photo');
        }

        async function takePhoto() {
            if (isProcessingPhoto) return;
            
            const btn = document.getElementById('capturePhotoBtn');
            const video = document.getElementById('videoPreview');
            const canvas = document.getElementById('photoCanvas');
            const capturedImg = document.getElementById('capturedPhoto');
            const infoText = document.getElementById('infoText');

            try {
                isProcessingPhoto = true;
                btn.disabled = true;
                btn.innerHTML = '<span style="font-size:1.2em;">‚è≥</span> Capturando...';
                infoText.textContent = 'üì∏ Capturando foto...';

                // Configurar canvas y capturar
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.translate(canvas.width, 0);
                ctx.scale(-1, 1);
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                // Obtener imagen en base64
                photoBase64 = canvas.toDataURL('image/jpeg', 0.8);
                capturedImg.src = photoBase64;
                
                // Detener c√°mara
                if (videoStream) {
                    videoStream.getTracks().forEach(track => track.stop());
                    videoStream = null;
                }
                
                // Mostrar resultados
                video.style.display = 'none';
                capturedImg.style.display = 'block';
                infoText.textContent = '‚úÖ Foto capturada. Subiendo a Google Drive...';
                scrollToBottom();

                // Subir foto usando GAS
                await uploadPhotoToDrive();

            } catch (error) {
                console.error('Error al tomar foto:', error);
                infoText.innerHTML = '‚ö†Ô∏è Error al capturar la foto. Continuando sin foto.';
                formDataIngreso.selfie = 'Error al capturar: ' + error.message;
                
                setTimeout(() => {
                    addUserMessage('‚ö†Ô∏è Continuando sin foto');
                    processIngresoResponse('captured_data');
                }, 1500);
            } finally {
                isProcessingPhoto = false;
            }
        }

        async function uploadPhotoToDrive() {
            const infoText = document.getElementById('infoText');
            
            try {
                // Preparar datos para enviar al GAS
                const payload = {
                    image: photoBase64,
                    asesor: formDataIngreso.asesor,
                    ubicacion: formDataIngreso.ubicacion
                };

                infoText.textContent = '‚è≥ Subiendo foto a Google Drive...';

                // Enviar al Google Apps Script
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Importante para GitHub Pages
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                // Con no-cors no podemos leer la respuesta directamente
                // Pero asumimos √©xito basado en tu GAS
                formDataIngreso.selfie = `https://drive.google.com/thumbnail?id=ID_FOTO&sz=w400`;
                
                // Simular respuesta exitosa
                setTimeout(() => {
                    infoText.textContent = '‚úÖ Foto subida exitosamente a Google Drive';
                    addUserMessage('‚úÖ Ubicaci√≥n y foto capturadas');
                    processIngresoResponse('captured_data');
                }, 2000);

            } catch (error) {
                console.error('Error al subir foto:', error);
                infoText.textContent = '‚ö†Ô∏è No se pudo subir la foto al Drive, pero continuaremos.';
                formDataIngreso.selfie = `Foto local - ${new Date().toLocaleString()}`;
                
                setTimeout(() => {
                    addUserMessage('‚úÖ Ubicaci√≥n capturada (foto guardada localmente)');
                    processIngresoResponse('captured_data');
                }, 1000);
            }
        }

        // ========== FLUJO DE INGRESO ==========
        function processIngresoResponse(response) {
            showTyping();

            setTimeout(() => {
                hideTyping();

                switch(currentStep) {
                    case 0:
                        formDataIngreso.asesor = response;
                        addBotMessage(`¬°Hola <strong>${response.split(' ')[0]}</strong>! üëã<br>Bienvenido al sistema de registro PDV.`);
                        setTimeout(() => {
                            addBotMessage('Vamos a registrar tu ingreso al punto de venta. Necesitaremos:<br>üìç Tu ubicaci√≥n GPS<br>üì∏ Una foto selfie', createCaptureContainer());
                        }, 800);
                        currentStep++;
                        break;

                    case 1:
                        const ciudadesOptions = Object.keys(ciudadesPuntosVenta).sort();
                        addBotMessage('¬°Perfecto! ‚úÖ Ahora necesitamos tu ubicaci√≥n comercial.');
                        setTimeout(() => {
                            addBotMessage('', createSelect(
                                ciudadesOptions,
                                'Selecciona tu ciudad...',
                                'üìç ¬øEn qu√© ciudad te encuentras?',
                                (ciudad) => processIngresoResponse(ciudad)
                            ));
                        }, 800);
                        currentStep++;
                        break;

                    case 2:
                        formDataIngreso.ciudad = response;
                        const puntosVenta = ciudadesPuntosVenta[response] || [];
                        
                        if (puntosVenta.length > 0) {
                            addBotMessage(`Excelente, est√°s en <strong>${response}</strong>. ‚úî`);
                            setTimeout(() => {
                                addBotMessage('', createSelect(
                                    puntosVenta,
                                    'Selecciona el punto de venta...',
                                    `üè™ Selecciona el punto de venta en ${response}:`,
                                    (punto) => processIngresoResponse(punto)
                                ));
                            }, 800);
                        } else {
                            addBotMessage(`Est√°s en <strong>${response}</strong>.`);
                            setTimeout(() => {
                                addBotMessage('', createInputBubble(
                                    `Escribe el nombre del punto de venta en ${response}:`,
                                    'Ej: Tienda La Econom√≠a, Supermercado XYZ...',
                                    (punto) => processIngresoResponse(punto)
                                ));
                            }, 800);
                        }
                        currentStep++;
                        break;

                    case 3:
                        formDataIngreso.puntoVenta = response;
                        submitFormIngreso();
                        break;
                }
            }, 1000);
        }

        function submitFormIngreso() {
            showTyping();
            
            setTimeout(() => {
                hideTyping();
                
                // Llenar formulario oculto
                document.getElementById('asesorField').value = formDataIngreso.asesor;
                document.getElementById('ubicacionField').value = formDataIngreso.ubicacion;
                document.getElementById('selfieField').value = formDataIngreso.selfie;
                document.getElementById('ciudadField').value = formDataIngreso.ciudad;
                document.getElementById('puntoVentaField').value = formDataIngreso.puntoVenta;

                // Enviar formulario
                document.getElementById('googleFormIngreso').submit();

                // Mostrar confirmaci√≥n
                addBotMessage(`
                    ‚úÖ <strong>¬°Ingreso registrado exitosamente!</strong><br><br>
                    üìã <strong>Resumen:</strong><br>
                    üë§ Asesor: ${formDataIngreso.asesor}<br>
                    üìç Ciudad: ${formDataIngreso.ciudad}<br>
                    üè™ Punto: ${formDataIngreso.puntoVenta}<br>
                    üì∏ Foto: ${formDataIngreso.selfie.includes('No capturada') ? 'No capturada' : 'Subida a Drive'}
                `);
                
                // Mostrar men√∫ principal
                setTimeout(() => showMainMenu(), 1500);
            }, 1500);
        }

        // ========== MEN√ö PRINCIPAL ==========
        function showMainMenu() {
            const menuBubble = document.createElement('div');
            menuBubble.className = 'bubble-container';
            
            menuBubble.innerHTML = `
                <div class="bubble-title">üì± Men√∫ Principal</div>
                <div class="menu-options">
                    <button class="menu-button" id="btnLineal">
                        <span style="font-size:1.2em;">üìä</span>
                        Participaci√≥n Lineal
                    </button>
                    <button class="menu-button" id="btnGaleria">
                        <span style="font-size:1.2em;">üè¨</span>
                        Galer√≠a PDV
                    </button>
                    <button class="menu-button" id="btnProximosVencer">
                        <span style="font-size:1.2em;">‚ö†Ô∏è</span>
                        Pr√≥ximos a Vencer
                    </button>
                    <button class="menu-button" id="btnAgotados">
                        <span style="font-size:1.2em;">üì¶</span>
                        Productos Agotados
                    </button>
                    <button class="menu-button" id="btnDescuentos">
                        <span style="font-size:1.2em;">üí∞</span>
                        Descuentos
                    </button>
                    <button class="menu-button" id="btnRegistrosVentas">
                        <span style="font-size:1.2em;">üìà</span>
                        Registro Ventas
                    </button>
                    <button class="menu-button" id="btnVozConsumidor">
                        <span style="font-size:1.2em;">üó£Ô∏è</span>
                        Voz Consumidor
                    </button>
                    <button class="menu-button" id="btnNuevoIngreso">
                        <span style="font-size:1.2em;">üîÑ</span>
                        Nuevo Ingreso
                    </button>
                    <button class="menu-button" id="btnVerRespuestas">
                        <span style="font-size:1.2em;">üëÅÔ∏è</span>
                        Ver Respuestas
                    </button>
                </div>
            `;

            addBotMessage('', menuBubble);

            // Asignar eventos
            setTimeout(() => {
                const actions = {
                    btnLineal: () => {
                        addUserMessage('üìä Participaci√≥n Lineal');
                        startLinealFlow();
                    },
                    btnGaleria: () => {
                        addUserMessage('üè¨ Galer√≠a PDV');
                        showTyping();
                        setTimeout(() => {
                            hideTyping();
                            addBotMessage('üîß <strong>Galer√≠a de Puntos de Venta</strong><br><br>Pr√≥ximamente podr√°s ver y subir fotos de los PDV.<br><br><small>Esta funci√≥n estar√° disponible en la pr√≥xima actualizaci√≥n.</small>');
                        }, 800);
                    },
                    btnProximosVencer: () => {
                        addUserMessage('‚ö†Ô∏è Pr√≥ximos a Vencer');
                        showTyping();
                        setTimeout(() => {
                            hideTyping();
                            addBotMessage('üîß <strong>Productos Pr√≥ximos a Vencer</strong><br><br>Pr√≥ximamente podr√°s registrar productos con fechas cercanas a vencer.<br><br><small>Esta funci√≥n estar√° disponible en la pr√≥xima actualizaci√≥n.</small>');
                        }, 800);
                    },
                    btnAgotados: () => {
                        addUserMessage('üì¶ Productos Agotados');
                        showTyping();
                        setTimeout(() => {
                            hideTyping();
                            addBotMessage('üîß <strong>Productos Agotados</strong><br><br>Pr√≥ximamente podr√°s reportar productos agotados en inventario.<br><br><small>Esta funci√≥n estar√° disponible en la pr√≥xima actualizaci√≥n.</small>');
                        }, 800);
                    },
                    btnDescuentos: () => {
                        addUserMessage('üí∞ Descuentos');
                        showTyping();
                        setTimeout(() => {
                            hideTyping();
                            addBotMessage('üîß <strong>Descuentos y Promociones</strong><br><br>Pr√≥ximamente podr√°s registrar descuentos activos en el PDV.<br><br><small>Esta funci√≥n estar√° disponible en la pr√≥xima actualizaci√≥n.</small>');
                        }, 800);
                    },
                    btnRegistrosVentas: () => {
                        addUserMessage('üìà Registro Ventas');
                        showTyping();
                        setTimeout(() => {
                            hideTyping();
                            addBotMessage('üîß <strong>Registros de Ventas</strong><br><br>Pr√≥ximamente podr√°s capturar datos de ventas del d√≠a.<br><br><small>Esta funci√≥n estar√° disponible en la pr√≥xima actualizaci√≥n.</small>');
                        }, 800);
                    },
                    btnVozConsumidor: () => {
                        addUserMessage('üó£Ô∏è Voz Consumidor');
                        showTyping();
                        setTimeout(() => {
                            hideTyping();
                            addBotMessage('üîß <strong>Voz del Consumidor</strong><br><br>Pr√≥ximamente podr√°s capturar comentarios y feedback de clientes.<br><br><small>Esta funci√≥n estar√° disponible en la pr√≥xima actualizaci√≥n.</small>');
                        }, 800);
                    },
                    btnNuevoIngreso: () => {
                        if (confirm('¬øEst√°s seguro de iniciar un nuevo ingreso? Se reiniciar√° el proceso.')) {
                            location.reload();
                        }
                    },
                    btnVerRespuestas: () => {
                        window.open('https://docs.google.com/forms/d/1FAIpQLSc0Kt8C392ffQH6b5eFt-TE8-778mqqwb9tdWCt8XWqQfUgFg/edit#responses', '_blank');
                    }
                };

                Object.keys(actions).forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) btn.onclick = actions[id];
                });
            }, 100);
        }

        // ========== FLUJO LINEAL ==========
        function startLinealFlow() {
            currentFlow = 'lineal';
            currentStep = 0;

            showTyping();
            setTimeout(() => {
                hideTyping();
                addBotMessage('¬°Perfecto! Vamos a registrar la participaci√≥n lineal. üìä');
                setTimeout(() => {
                    addBotMessage('', createSelect(
                        ['MARCA PROPIA', 'MARCA COMPETENCIA'],
                        'Selecciona el tipo...',
                        'üè∑Ô∏è ¬øQu√© tipo de marca vas a registrar?',
                        (tipo) => processLinealResponse(tipo)
                    ));
                }, 600);
            }, 800);
        }

        function processLinealResponse(response) {
            showTyping();

            setTimeout(() => {
                hideTyping();

                switch(currentStep) {
                    case 0:
                        formDataLineal.tipoMarca = response;
                        if (response === 'MARCA PROPIA') {
                            addBotMessage('Marca propia seleccionada ‚úÖ');
                            setTimeout(() => {
                                addBotMessage('', createSelect(
                                    productosMarcaPropia,
                                    'Selecciona el producto...',
                                    'üì¶ Selecciona el producto de nuestra marca:',
                                    (producto) => {
                                        formDataLineal.producto = producto;
                                        addUserMessage(producto);
                                        currentStep = 2;
                                        processLinealResponse('producto_selected');
                                    }
                                ));
                            }, 600);
                        } else {
                            addBotMessage('Marca competencia seleccionada ‚úÖ');
                            setTimeout(() => {
                                addBotMessage('', createInputBubble(
                                    'Escribe el nombre del producto competencia:',
                                    'Ej: Corona, Heineken, Budweiser, Poker...',
                                    (producto) => {
                                        formDataLineal.producto = producto;
                                        currentStep = 2;
                                        processLinealResponse('producto_selected');
                                    }
                                ));
                            }, 600);
                        }
                        currentStep++;
                        break;

                    case 2:
                        addBotMessage('Producto registrado ‚úî');
                        setTimeout(() => {
                            addBotMessage('', createInputBubble(
                                'üî¢ ¬øCu√°ntas caras/frentes tiene en el lineal?',
                                'Ingresa solo n√∫meros (ej: 3, 5, 12)...',
                                (numero) => {
                                    if (!isNaN(numero) && numero.trim() !== '' && parseInt(numero) > 0) {
                                        formDataLineal.numeroFrente = numero.trim();
                                        addUserMessage(`${numero} frentes`);
                                        currentStep++;
                                        processLinealResponse('numero_selected');
                                    } else {
                                        addBotMessage('‚ùå Por favor ingresa un n√∫mero v√°lido mayor a 0.');
                                        currentStep = 2;
                                        processLinealResponse('invalid_number');
                                    }
                                },
                                'number'
                            ));
                        }, 600);
                        break;

                    case 3:
                        showConfirmacionLineal();
                        break;
                }
            }, 800);
        }

        function showConfirmacionLineal() {
            const confirmBubble = document.createElement('div');
            confirmBubble.className = 'bubble-container';

            confirmBubble.innerHTML = `
                <div class="bubble-title">üìã Confirma los datos</div>
                <div style="background: rgba(37, 211, 102, 0.1); padding: 15px; border-radius: 12px; margin: 15px 0;">
                    <div style="margin-bottom: 10px;">
                        <strong>üè∑Ô∏è Tipo:</strong> ${formDataLineal.tipoMarca}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>üì¶ Producto:</strong> ${formDataLineal.producto}
                    </div>
                    <div>
                        <strong>üî¢ Frentes:</strong> ${formDataLineal.numeroFrente}
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="action-button" id="btnConfirmarLineal" style="flex:1;">
                        ‚úÖ Confirmar
                    </button>
                    <button class="action-button skip-btn" id="btnCancelarLineal" style="flex:1;">
                        ‚ùå Corregir
                    </button>
                </div>
            `;

            addBotMessage('', confirmBubble);

            setTimeout(() => {
                document.getElementById('btnConfirmarLineal').onclick = () => {
                    addUserMessage('‚úÖ Confirmar');
                    submitFormLineal();
                };
                document.getElementById('btnCancelarLineal').onclick = () => {
                    addUserMessage('‚ùå Corregir datos');
                    showTyping();
                    setTimeout(() => {
                        hideTyping();
                        addBotMessage('¬°No hay problema! Empecemos de nuevo. üîÑ');
                        setTimeout(() => startLinealFlow(), 800);
                    }, 800);
                };
            }, 100);
        }

        function submitFormLineal() {
            showTyping();
            
            setTimeout(() => {
                hideTyping();
                
                document.getElementById('tipoMarcaField').value = formDataLineal.tipoMarca;
                document.getElementById('productoField').value = formDataLineal.producto;
                document.getElementById('numeroFrentesField').value = formDataLineal.numeroFrente;

                document.getElementById('googleFormLineal').submit();

                addBotMessage(`
                    ‚úÖ <strong>¬°Participaci√≥n lineal registrada!</strong><br><br>
                    üìã <strong>Datos enviados:</strong><br>
                    üè∑Ô∏è Tipo: ${formDataLineal.tipoMarca}<br>
                    üì¶ Producto: ${formDataLineal.producto}<br>
                    üî¢ Frentes: ${formDataLineal.numeroFrente}
                `);
                
                setTimeout(() => {
                    const askBubble = document.createElement('div');
                    askBubble.className = 'bubble-container';
                    askBubble.innerHTML = `
                        <div class="bubble-title">¬øQu√© deseas hacer ahora?</div>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="action-button" id="btnOtroRegistro" style="flex:1;">
                                üìä Registrar otro
                            </button>
                            <button class="action-button camera-btn" id="btnVolverMenu" style="flex:1;">
                                üè† Men√∫ principal
                            </button>
                        </div>
                    `;
                    
                    addBotMessage('', askBubble);
                    
                    setTimeout(() => {
                        document.getElementById('btnOtroRegistro').onclick = () => {
                            formDataLineal = { tipoMarca: '', producto: '', numeroFrente: '' };
                            startLinealFlow();
                        };
                        document.getElementById('btnVolverMenu').onclick = showMainMenu;
                    }, 100);
                }, 1000);
            }, 1500);
        }

        // ========== INICIALIZACI√ìN ==========
        function initChat() {
            setTimeout(() => {
                addBotMessage(`
                    üç∫ <strong>¬°Hola!</strong><br>
                    Soy tu asistente para registros en Puntos de Venta Beer.<br><br>
                    üìç Puedo ayudarte con:<br>
                    ‚Ä¢ Registro de ingreso (ubicaci√≥n + selfie)<br>
                    ‚Ä¢ Participaci√≥n lineal de productos<br>
                    ‚Ä¢ Gesti√≥n completa del PDV<br><br>
                    <small>Selecciona tu nombre para comenzar:</small>
                `);
                
                setTimeout(() => {
                    addBotMessage('', createSelect(
                        asesores,
                        'Selecciona tu nombre...',
                        'üë§ ¬øQui√©n eres?',
                        (asesor) => processIngresoResponse(asesor)
                    ));
                }, 1200);
            }, 500);
        }

        // Iniciar cuando cargue la p√°gina
        window.addEventListener('DOMContentLoaded', initChat);

    </script>
</body>
</html>
