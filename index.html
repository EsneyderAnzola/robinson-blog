<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PDV - Asistente Beer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            overflow: hidden;
        }

        .chat-container {
            width: 100%;
            max-width: 450px;
            height: 95vh;
            background: white;
            display: flex;
            flex-direction: column;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            position: relative;
        }

        /* Header mejorado */
        .chat-header {
            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 10;
        }

        .header-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd700 0%, #ffb800 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .header-info {
            flex: 1;
        }

        .header-name {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .header-status {
            font-size: 0.8em;
            color: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* √Årea de mensajes mejorada */
        .chat-messages {
            flex: 1;
            padding: 20px 15px 100px;
            overflow-y: auto;
            background: #f0f2f5;
            background-image: 
                radial-gradient(circle at 10px 10px, rgba(0,150,136,0.03) 2px, transparent 0),
                radial-gradient(circle at 30px 30px, rgba(0,150,136,0.03) 2px, transparent 0);
            background-size: 40px 40px;
            position: relative;
            -webkit-overflow-scrolling: touch;
        }

        .chat-messages::-webkit-scrollbar {
            width: 5px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05);
            border-radius: 10px;
        }

        /* Mensajes mejorados */
        .message {
            margin-bottom: 16px;
            display: flex;
            animation: fadeInUp 0.4s ease;
            padding: 0 5px;
            flex-direction: column;
        }

        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(15px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .message-content {
            max-width: 85%;
            position: relative;
            padding: 12px 16px;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            font-size: 0.95em;
            line-height: 1.4;
        }

        .bot-message {
            align-items: flex-start;
        }

        .bot-message .message-content {
            background: white;
            color: #333;
            border-radius: 0 18px 18px 18px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .user-message {
            align-items: flex-end;
        }

        .user-message .message-content {
            background: linear-gradient(135deg, #25d366 0%, #20ba5a 100%);
            color: white;
            border-radius: 18px 0 18px 18px;
            border: none;
        }

        .message-time {
            font-size: 0.7em;
            color: #888;
            text-align: right;
            margin-top: 5px;
            padding-right: 5px;
            opacity: 0.8;
        }

        /* Burbujas de selecci√≥n mejoradas */
        .select-bubble {
            background: white;
            padding: 16px;
            border-radius: 18px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0,0,0,0.05);
            margin-top: 10px;
            position: relative;
            overflow: hidden;
        }

        .select-bubble::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #25d366, #128c7e);
            border-radius: 18px 18px 0 0;
        }

        .select-bubble-text {
            margin-bottom: 15px;
            font-size: 0.95em;
            color: #333;
            font-weight: 600;
            padding-right: 10px;
        }

        /* Select mejorado */
        .custom-select {
            position: relative;
            width: 100%;
            margin-bottom: 10px;
        }

        .select-button {
            width: 100%;
            padding: 14px 16px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            color: #333;
            font-size: 0.9em;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            font-weight: 500;
        }

        .select-button:hover {
            border-color: #25d366;
            background: white;
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.1);
        }

        .select-button.active {
            border-color: #25d366;
            background: rgba(37, 211, 102, 0.05);
        }

        .select-arrow {
            transition: transform 0.3s;
            font-size: 0.8em;
            color: #666;
        }

        .select-button.active .select-arrow {
            transform: rotate(180deg);
            color: #25d366;
        }

        /* Dropdown mejorado */
        .select-dropdown {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 30px);
            max-width: 420px;
            background: white;
            border-radius: 16px;
            max-height: 0;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            opacity: 0;
            top: 20%;
        }

        .select-dropdown.active {
            max-height: 70vh;
            overflow-y: auto;
            padding: 0;
            opacity: 1;
        }

        .select-search {
            position: sticky;
            top: 0;
            padding: 15px;
            background: white;
            border-bottom: 1px solid #eee;
            z-index: 10;
        }

        .select-search input {
            width: 100%;
            padding: 12px 16px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            color: #333;
            font-size: 0.9em;
            outline: none;
            transition: all 0.3s;
        }

        .select-search input:focus {
            border-color: #25d366;
            background: white;
            box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.1);
        }

        .select-option {
            padding: 14px 16px;
            color: #333;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
            transition: all 0.2s;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .select-option:last-child {
            border-bottom: none;
        }

        .select-option:hover {
            background: linear-gradient(90deg, rgba(37, 211, 102, 0.1), rgba(18, 140, 126, 0.05));
            padding-left: 20px;
            color: #128c7e;
        }

        .select-option:active {
            background: linear-gradient(90deg, rgba(37, 211, 102, 0.2), rgba(18, 140, 126, 0.1));
        }

        .select-option::before {
            content: '‚Üí';
            opacity: 0;
            transition: opacity 0.3s;
            color: #25d366;
        }

        .select-option:hover::before {
            opacity: 1;
        }

        /* Contenedor de captura mejorado */
        .capture-container {
            background: white;
            padding: 18px;
            border-radius: 18px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0,0,0,0.05);
            margin-top: 10px;
            position: relative;
            overflow: hidden;
        }

        .capture-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #2196F3, #0b7dda);
            border-radius: 18px 18px 0 0;
        }

        .capture-title {
            font-size: 0.95em;
            color: #333;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        /* Botones mejorados */
        .action-button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #25d366 0%, #20ba5a 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
        }

        .action-button::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.6s;
        }

        .action-button:hover::after {
            left: 100%;
        }

        .action-button:active {
            transform: scale(0.98);
            box-shadow: 0 2px 8px rgba(37, 211, 102, 0.4);
        }

        .action-button:disabled {
            background: linear-gradient(135deg, #b0b0b0 0%, #999999 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .action-button.camera-btn {
            background: linear-gradient(135deg, #2196F3 0%, #0b7dda 100%);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }

        .action-button.skip-btn {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
        }

        /* Elementos de c√°mara */
        video {
            width: 100%;
            border-radius: 12px;
            margin: 12px 0;
            transform: scaleX(-1);
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .captured-photo {
            width: 100%;
            border-radius: 12px;
            margin: 12px 0;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 3px solid white;
        }

        .info-text {
            font-size: 0.85em;
            color: #666;
            margin-top: 10px;
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #25d366;
        }

        /* Men√∫ principal mejorado */
        .menu-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .menu-button {
            padding: 14px 12px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #e9ecef;
            border-radius: 12px;
            color: #333;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-align: center;
            min-height: 80px;
        }

        .menu-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            border-color: #25d366;
            background: white;
        }

        .menu-button:active {
            transform: scale(0.98);
        }

        /* Indicador de escritura */
        .typing-indicator {
            display: flex;
            gap: 6px;
            padding: 12px 20px;
            background: white;
            border-radius: 18px;
            width: fit-content;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .typing-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #25d366;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        /* Input bubble mejorado */
        .input-bubble {
            background: white;
            padding: 16px;
            border-radius: 18px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0,0,0,0.05);
            margin-top: 10px;
            position: relative;
        }

        .input-bubble::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 18px 18px 0 0;
        }

        .input-bubble-text {
            margin-bottom: 12px;
            font-size: 0.95em;
            color: #333;
            font-weight: 600;
        }

        .input-field {
            width: 100%;
            padding: 14px 16px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            color: #333;
            font-size: 0.95em;
            outline: none;
            transition: all 0.3s;
        }

        .input-field:focus {
            border-color: #25d366;
            background: white;
            box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.1);
        }

        .send-input-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #25d366 0%, #20ba5a 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            margin-top: 12px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .send-input-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.3);
        }

        .send-input-btn:active {
            transform: scale(0.98);
        }

        /* Notificaciones */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-left: 5px solid #25d366;
            z-index: 1001;
            transform: translateX(150%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left-color: #25d366;
        }

        .notification.error {
            border-left-color: #f44336;
        }

        .notification.warning {
            border-left-color: #ff9800;
        }

        /* Responsive */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .chat-container {
                height: 100vh;
                max-width: 100%;
                border-radius: 15px;
            }
            
            .menu-options {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .select-dropdown {
                width: calc(100% - 20px);
                top: 15%;
            }
        }

        @media (min-width: 768px) {
            .chat-container {
                height: 700px;
                box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="header-avatar">üç∫</div>
            <div class="header-info">
                <div class="header-name">Asistente PDV Beer</div>
                <div class="header-status">
                    <div class="status-dot"></div>
                    en l√≠nea
                </div>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages"></div>
    </div>

    <!-- Elementos de c√°mara ocultos -->
    <video id="videoStream" autoplay playsinline style="display:none;"></video>
    <canvas id="photoCanvas" style="display:none;"></canvas>

    <!-- Formularios ocultos -->
    <iframe name="hidden_iframe_ingreso" style="display:none;"></iframe>
    <form id="googleFormIngreso" 
          action="https://docs.google.com/forms/d/e/1FAIpQLSc0Kt8C392ffQH6b5eFt-TE8-778mqqwb9tdWCt8XWqQfUgFg/formResponse" 
          target="hidden_iframe_ingreso" 
          method="POST"
          style="display:none;">
        <input type="text" name="entry.1176318650" id="asesorField">
        <input type="text" name="entry.735888429" id="ubicacionField">
        <input type="text" name="entry.363650812" id="selfieField">
        <input type="text" name="entry.704645502" id="ciudadField">
        <input type="text" name="entry.732551510" id="puntoVentaField">
        <input type="text" name="entry.1281420665" id="confirmacionField" value="S√≠, es correcta">
    </form>

    <iframe name="hidden_iframe_lineal" style="display:none;"></iframe>
    <form id="googleFormLineal" 
          action="https://docs.google.com/forms/d/e/1FAIpQLScieYTjkAlXma8QLdmMQD2q-gcQb3h8fBWlw1kAWdHrLs8Vow/formResponse" 
          target="hidden_iframe_lineal" 
          method="POST"
          style="display:none;">
        <input type="text" name="entry.238753566" id="tipoMarcaField">
        <input type="text" name="entry.536323816" id="productoField">
        <input type="text" name="entry.857124037" id="numeroFrentesField">
        <input type="text" name="entry.1305667853" id="datosCorrectosField" value="S√≠">
    </form>

    <script>
        // Configuraci√≥n para GitHub Pages
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyCvuZE34DkSCMy7Z_dr7DEaye3a2K2nArlePMG8QuFnxBSjduy4OK8pB1eUR9Nb4PI/exec';
        
        // URLs alternativas por si la principal falla
        const BACKUP_SCRIPT_URLS = [
            GOOGLE_SCRIPT_URL,
            'https://script.google.com/macros/s/AKfycbwRjyKYoOYvlMkOH7r2izOPq2m_Kf3dJq1AvSqD_iC-TxQbV_7LzqOJQOjfBKCxG2U8/exec'
        ];

        // Variables globales
        let formDataIngreso = {
            asesor: '',
            ubicacion: '',
            selfie: '',
            ciudad: '',
            puntoVenta: ''
        };

        let formDataLineal = {
            tipoMarca: '',
            producto: '',
            numeroFrente: ''
        };

        // Datos de ejemplo (puedes ampliarlos)
        const asesores = [
            'Juan David Benavides Gonz√°lez', 'Robinson Esneyder Zapata Anzola',
            'Sheyla Carolina G√≥mez Pati√±o', 'Harlinton Roisel Ortega Nieves',
            'Maria Paula Contreras', 'Leidy Jhoanna Restrepo Zapata',
            'Daniela Andrea Calvo Corena', 'Yadina Villanueva Sibaja',
            'Sandra Viviana Zapata Viafara', 'Stefany Bernal Tique',
            'Angie Vanessa Valenciano Romero', 'Sara Florez Velez',
            'Sara Posso Quintero', 'Juliet Lasso Ramirez',
            'Jenny Marcela Jaramillo Mejia', 'David Lopez Cardenas',
            'Ashly Valentina Montoya Rincon', 'Jaime Andres Castro Diaz',
            'Sergio Alejandro Murillo Gonzales'
        ];

        const ciudadesPuntosVenta = {
            'Arjona': ['STO 116 ARJONA'],
            'Armenia': [
                'Ex 065 Exito Unicentro Armenia',
                'Sa 358 Portal Del Quindio',
                'Sa 366 San Diego',
                'Ex 628 Exito Armenia',
                'Si 4239 Super Inter Armenia Plaza',
                'St 355 Armenia Norte'
            ],
            'Barranquilla': ['Carulla Feria De Los Platanos'],
            'Cali': ['Si 4235 Super Inter Las Americas'],
            'Cartagena': ['CC Caribe Plaza', 'CC Bocagrande'],
            'Fusagasug√°': ['√âxito Fusagasug√°'],
            'Girardot': ['Metro Girardot'],
            'Guadalajara De Buga': ['√âxito Buga'],
            'Jamundi': ['Supermercados Jamund√≠'],
            'La Mesa': ['Almacenes La Mesa'],
            'Malambo': ['Makro Malambo'],
            'Manizales': ['√âxito Manizales', 'Carulla Manizales'],
            'Melgar': ['Metro Melgar'],
            'Neiva': ['√âxito Neiva', 'Jumbo Neiva'],
            'Palmira': ['Metro Palmira'],
            'Pereira': ['√âxito Pereira', 'Sanandresito Pereira'],
            'Pereira- Dosquebradas': ['Makro Dosquebradas'],
            'Popayan': ['√âxito Popay√°n'],
            'Soledad': ['Metro Soledad', 'Makro Soledad'],
            'Tulua': ['√âxito Tulu√°', 'Carulla Tulu√°'],
            'Tunja': ['√âxito Tunja'],
            'Turbaco': ['Almacenes Turbaco'],
            'Villavicencio': ['√âxito Villavicencio', 'Jumbo Villavicencio'],
            'Yumbo': ['√âxito Yumbo'],
            'Ibagu√©': ['√âxito Ibagu√©', 'Carulla Ibagu√©']
        };

        const productosMarcaPropia = [
            'ANDINA 330 ml x 6', 'ANDINA 330 ml x 24', 'ANDINA ZERO 330 ml x 6',
            'CLUB COLOMBIA DORADA 330 ml x 6', 'CLUB COLOMBIA DORADA 330 ml x 24',
            'POKER 330 ml x 6', 'POKER 330 ml x 24', 'PILSEN 330 ml x 6',
            'COSTE√ëA 330 ml x 6', '√ÅGUILA 330 ml x 6', '√ÅGUILA LIGHT 330 ml x 6'
        ];

        let currentFlow = '';
        let currentStep = 0;
        let videoStream = null;
        let photoBase64 = null;
        let photoSkipped = false;
        let isProcessingPhoto = false;

        const chatMessages = document.getElementById('chatMessages');

        // ========== FUNCIONES DE UTILIDAD ==========
        function showNotification(message, type = 'success', duration = 3000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 5px;">
                    ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ö†Ô∏è'} 
                    ${type === 'success' ? '√âxito' : type === 'error' ? 'Error' : 'Advertencia'}
                </div>
                <div style="font-size: 0.9em;">${message}</div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 10);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 400);
            }, duration);
        }

        function getTime() {
            const now = new Date();
            return now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
        }

        // ========== MANEJO DEL CHAT ==========
        function scrollToBottom(instant = false) {
            setTimeout(() => {
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: instant ? 'auto' : 'smooth'
                });
            }, 100);
        }

        function addBotMessage(text, customElement = null) {
            const wrapper = document.createElement('div');
            wrapper.className = 'message bot-message';

            if (!customElement) {
                const bubble = document.createElement('div');
                bubble.className = 'message-content';
                bubble.innerHTML = text;
                
                const time = document.createElement('div');
                time.className = 'message-time';
                time.textContent = getTime();
                bubble.appendChild(time);
                
                wrapper.appendChild(bubble);
            } else {
                wrapper.appendChild(customElement);
            }

            chatMessages.appendChild(wrapper);
            scrollToBottom();
            return wrapper;
        }

        function addUserMessage(text) {
            const wrapper = document.createElement('div');
            wrapper.className = 'message user-message';

            const bubble = document.createElement('div');
            bubble.className = 'message-content';
            bubble.textContent = text;

            const time = document.createElement('div');
            time.className = 'message-time';
            time.textContent = getTime();
            bubble.appendChild(time);

            wrapper.appendChild(bubble);
            chatMessages.appendChild(wrapper);
            scrollToBottom();
        }

        // ========== COMPONENTES MEJORADOS ==========
        function createSelect(options, placeholder, label, onSelect) {
            const bubble = document.createElement('div');
            bubble.className = 'select-bubble';

            bubble.innerHTML = `
                <div class="select-bubble-text">${label}</div>
                <div class="custom-select">
                    <div class="select-button" id="select-btn-${Date.now()}">
                        <span id="select-text-${Date.now()}">${placeholder}</span>
                        <span class="select-arrow">‚ñº</span>
                    </div>
                    <div class="select-dropdown" id="select-dropdown-${Date.now()}">
                        <div class="select-search">
                            <input type="text" placeholder="üîç Buscar..." id="select-search-${Date.now()}">
                        </div>
                        <div class="select-options" id="select-options-${Date.now()}"></div>
                    </div>
                </div>
            `;

            setTimeout(() => {
                const btn = bubble.querySelector('.select-button');
                const dropdown = bubble.querySelector('.select-dropdown');
                const search = bubble.querySelector('input');
                const optionsContainer = bubble.querySelector('.select-options');
                const textSpan = bubble.querySelector('.select-button span:first-child');

                // Agregar opciones
                options.forEach(opt => {
                    const optDiv = document.createElement('div');
                    optDiv.className = 'select-option';
                    optDiv.textContent = opt;
                    optDiv.onclick = (e) => {
                        e.stopPropagation();
                        textSpan.textContent = opt;
                        dropdown.classList.remove('active');
                        btn.classList.remove('active');
                        addUserMessage(opt);
                        if (onSelect) onSelect(opt);
                        scrollToBottom();
                    };
                    optionsContainer.appendChild(optDiv);
                });

                // Manejar clic
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const isOpen = dropdown.classList.contains('active');
                    
                    // Cerrar otros dropdowns
                    document.querySelectorAll('.select-dropdown').forEach(d => {
                        if (d !== dropdown) d.classList.remove('active');
                    });
                    document.querySelectorAll('.select-button').forEach(b => {
                        if (b !== btn) b.classList.remove('active');
                    });
                    
                    if (!isOpen) {
                        dropdown.classList.add('active');
                        btn.classList.add('active');
                        search.focus();
                        
                        // Posicionar dropdown
                        const rect = btn.getBoundingClientRect();
                        dropdown.style.top = `${rect.bottom + 10}px`;
                        
                        // Asegurar visibilidad
                        setTimeout(() => {
                            dropdown.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }, 50);
                    } else {
                        dropdown.classList.remove('active');
                        btn.classList.remove('active');
                    }
                };

                // Buscador
                search.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    optionsContainer.querySelectorAll('.select-option').forEach(opt => {
                        const text = opt.textContent.toLowerCase();
                        opt.style.display = text.includes(term) ? 'flex' : 'none';
                    });
                });

                // Cerrar al hacer clic fuera
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.custom-select')) {
                        dropdown.classList.remove('active');
                        btn.classList.remove('active');
                    }
                });

                // Asegurar visibilidad
                scrollToBottom();
            }, 50);

            return bubble;
        }

        function createInputBubble(label, placeholder, onSubmit, type = 'text') {
            const bubble = document.createElement('div');
            bubble.className = 'input-bubble';

            const inputId = `input-${Date.now()}`;
            bubble.innerHTML = `
                <div class="input-bubble-text">${label}</div>
                <input type="${type}" class="input-field" id="${inputId}" placeholder="${placeholder}">
                <button class="send-input-btn" id="${inputId}-btn">Enviar</button>
            `;

            setTimeout(() => {
                const input = document.getElementById(inputId);
                const btn = document.getElementById(`${inputId}-btn`);

                const submitValue = () => {
                    const value = input.value.trim();
                    if (value) {
                        input.disabled = true;
                        btn.disabled = true;
                        addUserMessage(value);
                        if (onSubmit) onSubmit(value);
                    }
                };

                btn.onclick = submitValue;
                input.onkeypress = (e) => e.key === 'Enter' && submitValue();
                input.focus();
                scrollToBottom();
            }, 50);

            return bubble;
        }

        // ========== CAPTURA DE FOTO (CORREGIDA PARA GITHUB PAGES) ==========
        function createCaptureContainer() {
            const container = document.createElement('div');
            container.className = 'capture-container';
            container.id = 'captureContainer';

            container.innerHTML = `
                <div class="capture-title">üìç Captura de ubicaci√≥n y foto</div>
                <div class="info-text">Primero captura tu ubicaci√≥n, luego puedes tomar una foto selfie.</div>
                <button class="action-button" id="locationBtn">
                    <span style="font-size: 1.2em;">üìç</span> Capturar ubicaci√≥n
                </button>
                <button class="action-button camera-btn" id="cameraBtn" style="display:none;">
                    <span style="font-size: 1.2em;">üì∏</span> Abrir c√°mara para selfie
                </button>
                <button class="action-button skip-btn" id="skipPhotoBtn" style="display:none;">
                    <span style="font-size: 1.2em;">‚è≠Ô∏è</span> Continuar sin foto
                </button>
                <video id="videoPreview" autoplay playsinline style="display:none;"></video>
                <div id="cameraControls" style="display:none;">
                    <button class="action-button" id="capturePhotoBtn">
                        <span style="font-size: 1.2em;">üì∑</span> Tomar foto
                    </button>
                    <button class="action-button skip-btn" id="retakePhotoBtn" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);">
                        <span style="font-size: 1.2em;">üîÑ</span> Volver a tomar
                    </button>
                </div>
                <img id="capturedPhoto" class="captured-photo" style="display:none;">
                <div class="info-text" id="infoText"></div>
            `;

            setTimeout(() => {
                document.getElementById('locationBtn').onclick = captureLocation;
                document.getElementById('cameraBtn').onclick = openCamera;
                document.getElementById('skipPhotoBtn').onclick = skipPhoto;
                document.getElementById('capturePhotoBtn').onclick = takePhoto;
                document.getElementById('retakePhotoBtn').onclick = retakePhoto;
            }, 50);

            return container;
        }

        function captureLocation() {
            const btn = document.getElementById('locationBtn');
            const infoText = document.getElementById('infoText');
            
            if (isProcessingPhoto) return;
            
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Obteniendo ubicaci√≥n...';
            infoText.textContent = 'Obteniendo tu ubicaci√≥n GPS...';

            if (!navigator.geolocation) {
                infoText.textContent = '‚ùå Tu dispositivo no soporta geolocalizaci√≥n. Usa otro dispositivo o contin√∫a sin ubicaci√≥n.';
                formDataIngreso.ubicacion = 'No soportado';
                showCameraOptions();
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const coords = `${position.coords.latitude.toFixed(6)},${position.coords.longitude.toFixed(6)}`;
                    formDataIngreso.ubicacion = coords;
                    
                    btn.innerHTML = '‚úÖ Ubicaci√≥n capturada';
                    btn.style.background = 'linear-gradient(135deg, #128c7e 0%, #075e54 100%)';
                    infoText.innerHTML = `‚úÖ <strong>Ubicaci√≥n capturada:</strong><br>Lat: ${position.coords.latitude.toFixed(6)}<br>Lon: ${position.coords.longitude.toFixed(6)}`;
                    
                    showCameraOptions();
                    showNotification('Ubicaci√≥n capturada exitosamente');
                },
                (error) => {
                    infoText.innerHTML = '‚ö†Ô∏è <strong>No se pudo obtener la ubicaci√≥n exacta.</strong><br>Puedes continuar sin ubicaci√≥n o intentar de nuevo.';
                    formDataIngreso.ubicacion = 'Error: ' + error.message;
                    
                    btn.disabled = false;
                    btn.innerHTML = 'üìç Intentar de nuevo';
                    
                    // Mostrar opciones de c√°mara de todas formas
                    setTimeout(() => showCameraOptions(), 1000);
                },
                { 
                    enableHighAccuracy: true, 
                    timeout: 15000, 
                    maximumAge: 0 
                }
            );
        }

        function showCameraOptions() {
            setTimeout(() => {
                document.getElementById('cameraBtn').style.display = 'block';
                document.getElementById('skipPhotoBtn').style.display = 'block';
                scrollToBottom();
            }, 500);
        }

        async function openCamera() {
            if (isProcessingPhoto) return;
            
            const btn = document.getElementById('cameraBtn');
            const video = document.getElementById('videoPreview');
            const infoText = document.getElementById('infoText');
            const cameraControls = document.getElementById('cameraControls');

            try {
                isProcessingPhoto = true;
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Accediendo a la c√°mara...';
                infoText.textContent = 'Solicitando acceso a la c√°mara...';

                // Para GitHub Pages, necesitamos HTTPS
                const constraints = {
                    video: { 
                        facingMode: 'user',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                };

                videoStream = await navigator.mediaDevices.getUserMedia(constraints);

                video.srcObject = videoStream;
                video.style.display = 'block';
                
                btn.style.display = 'none';
                document.getElementById('skipPhotoBtn').style.display = 'none';
                cameraControls.style.display = 'block';
                infoText.textContent = '‚úÖ C√°mara lista. Aseg√∫rate de estar bien iluminado.';

                showNotification('C√°mara activada', 'success');
                scrollToBottom();

            } catch (error) {
                console.error('Error al acceder a la c√°mara:', error);
                infoText.innerHTML = `
                    ‚ùå <strong>No se pudo acceder a la c√°mara.</strong><br>
                    Posibles causas:<br>
                    1. Permisos de c√°mara denegados<br>
                    2. Otra app est√° usando la c√°mara<br>
                    3. Problemas t√©cnicos del dispositivo
                `;
                
                btn.disabled = false;
                btn.innerHTML = 'üì∏ Intentar de nuevo';
                isProcessingPhoto = false;
                
                showNotification('Error al acceder a la c√°mara', 'error');
            }
        }

        function skipPhoto() {
            if (isProcessingPhoto) return;
            
            photoSkipped = true;
            formDataIngreso.selfie = 'No capturada - Usuario decidi√≥ saltar';
            addUserMessage('‚è≠Ô∏è Continuar sin foto');
            showNotification('Continuando sin foto', 'warning');
            processIngresoResponse('skipped_photo');
        }

        function retakePhoto() {
            const video = document.getElementById('videoPreview');
            const capturedImg = document.getElementById('capturedPhoto');
            const infoText = document.getElementById('infoText');
            
            capturedImg.style.display = 'none';
            video.style.display = 'block';
            infoText.textContent = 'Listo para tomar otra foto';
            scrollToBottom();
        }

        async function takePhoto() {
            if (isProcessingPhoto) return;
            
            const btn = document.getElementById('capturePhotoBtn');
            const video = document.getElementById('videoPreview');
            const canvas = document.getElementById('photoCanvas');
            const capturedImg = document.getElementById('capturedPhoto');
            const infoText = document.getElementById('infoText');

            try {
                isProcessingPhoto = true;
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Capturando...';
                infoText.textContent = 'Capturando foto...';

                // Configurar canvas
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                
                // Espejar la imagen para selfie
                ctx.translate(canvas.width, 0);
                ctx.scale(-1, 1);
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                // Obtener imagen en base64
                photoBase64 = canvas.toDataURL('image/jpeg', 0.8);
                capturedImg.src = photoBase64;
                
                // Detener c√°mara
                if (videoStream) {
                    videoStream.getTracks().forEach(track => track.stop());
                    videoStream = null;
                }
                
                // Mostrar resultados
                video.style.display = 'none';
                capturedImg.style.display = 'block';
                infoText.textContent = '‚úÖ Foto capturada. Subiendo a Drive...';
                
                showNotification('Foto capturada exitosamente', 'success');
                scrollToBottom();

                // Intentar subir la foto
                await uploadPhotoToDrive();

            } catch (error) {
                console.error('Error al tomar foto:', error);
                infoText.innerHTML = '‚ö†Ô∏è Error al capturar la foto. Continuando sin foto.';
                formDataIngreso.selfie = 'Error al capturar: ' + error.message;
                
                setTimeout(() => {
                    addUserMessage('‚ö†Ô∏è Continuando sin foto por error t√©cnico');
                    processIngresoResponse('captured_data');
                }, 1500);
                
                showNotification('Error al procesar foto', 'error');
            } finally {
                isProcessingPhoto = false;
            }
        }

        async function uploadPhotoToDrive() {
            const infoText = document.getElementById('infoText');
            
            try {
                // Preparar datos para enviar
                const payload = {
                    image: photoBase64.split(',')[1], // Enviar solo la parte base64
                    asesor: formDataIngreso.asesor,
                    ubicacion: formDataIngreso.ubicacion,
                    timestamp: new Date().toISOString()
                };

                // Intentar con URLs de backup si falla la principal
                let lastError = null;
                
                for (const scriptUrl of BACKUP_SCRIPT_URLS) {
                    try {
                        infoText.textContent = `‚è≥ Subiendo foto... (intento ${BACKUP_SCRIPT_URLS.indexOf(scriptUrl) + 1})`;
                        
                        const response = await fetch(scriptUrl, {
                            method: 'POST',
                            mode: 'no-cors', // Para evitar problemas CORS en GitHub Pages
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload)
                        });

                        // Con no-cors no podemos leer la respuesta, pero asumimos √©xito
                        formDataIngreso.selfie = `Foto capturada - ${new Date().toLocaleString()}`;
                        infoText.textContent = '‚úÖ Foto procesada (modo seguro para GitHub Pages)';
                        
                        showNotification('Foto procesada correctamente', 'success');
                        
                        setTimeout(() => {
                            addUserMessage('‚úÖ Ubicaci√≥n y foto capturadas');
                            processIngresoResponse('captured_data');
                        }, 1000);
                        
                        return;
                        
                    } catch (error) {
                        lastError = error;
                        console.warn(`Intento fallido con ${scriptUrl}:`, error);
                        continue;
                    }
                }

                // Si todos los intentos fallan
                throw lastError || new Error('Todos los intentos fallaron');

            } catch (error) {
                console.error('Error al subir foto:', error);
                infoText.textContent = '‚ö†Ô∏è No se pudo subir la foto al Drive, pero continuaremos.';
                formDataIngreso.selfie = `Foto local - ${new Date().toLocaleString()}`;
                
                setTimeout(() => {
                    addUserMessage('‚úÖ Ubicaci√≥n capturada (foto guardada localmente)');
                    processIngresoResponse('captured_data');
                }, 1000);
                
                showNotification('Foto guardada localmente', 'warning');
            }
        }

        // ========== FLUJO PRINCIPAL ==========
        function showTyping() {
            const wrapper = document.createElement('div');
            wrapper.className = 'message bot-message';
            wrapper.id = 'typing';
            wrapper.innerHTML = `
                <div class="message-content">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(wrapper);
            scrollToBottom();
        }

        function hideTyping() {
            const typing = document.getElementById('typing');
            if (typing) typing.remove();
        }

        function processIngresoResponse(response) {
            showTyping();

            setTimeout(() => {
                hideTyping();

                switch(currentStep) {
                    case 0:
                        formDataIngreso.asesor = response;
                        addBotMessage(`¬°Hola <strong>${response.split(' ')[0]}</strong>! üëã<br>Bienvenido al sistema de registro PDV.`);
                        setTimeout(() => {
                            addBotMessage('Vamos a registrar tu ingreso al punto de venta.', createCaptureContainer());
                        }, 800);
                        currentStep++;
                        break;

                    case 1:
                        const ciudadesOptions = Object.keys(ciudadesPuntosVenta).sort();
                        addBotMessage('Perfecto! ‚úÖ Ahora necesitamos tu ubicaci√≥n.');
                        setTimeout(() => {
                            addBotMessage('', createSelect(
                                ciudadesOptions,
                                'Selecciona tu ciudad...',
                                'üìç ¬øEn qu√© ciudad te encuentras?',
                                (ciudad) => processIngresoResponse(ciudad)
                            ));
                        }, 800);
                        currentStep++;
                        break;

                    case 2:
                        formDataIngreso.ciudad = response;
                        const puntosVenta = ciudadesPuntosVenta[response] || [];
                        
                        if (puntosVenta.length > 0) {
                            addBotMessage(`Excelente, est√°s en <strong>${response}</strong>. ‚úî`);
                            setTimeout(() => {
                                addBotMessage('', createSelect(
                                    puntosVenta,
                                    'Selecciona el punto de venta...',
                                    `üè™ Selecciona el punto de venta en ${response}:`,
                                    (punto) => processIngresoResponse(punto)
                                ));
                            }, 800);
                        } else {
                            addBotMessage(`Est√°s en <strong>${response}</strong>.`);
                            setTimeout(() => {
                                addBotMessage('', createInputBubble(
                                    `Escribe el nombre del punto de venta en ${response}:`,
                                    'Ej: Tienda La Econom√≠a, Supermercado XYZ...',
                                    (punto) => processIngresoResponse(punto)
                                ));
                            }, 800);
                        }
                        currentStep++;
                        break;

                    case 3:
                        formDataIngreso.puntoVenta = response;
                        submitFormIngreso();
                        break;
                }
            }, 1000);
        }

        function submitFormIngreso() {
            showTyping();
            
            setTimeout(() => {
                hideTyping();
                
                // Llenar formulario oculto
                document.getElementById('asesorField').value = formDataIngreso.asesor;
                document.getElementById('ubicacionField').value = formDataIngreso.ubicacion;
                document.getElementById('selfieField').value = formDataIngreso.selfie;
                document.getElementById('ciudadField').value = formDataIngreso.ciudad;
                document.getElementById('puntoVentaField').value = formDataIngreso.puntoVenta;

                // Enviar formulario
                document.getElementById('googleFormIngreso').submit();

                // Mostrar confirmaci√≥n
                addBotMessage(`
                    ‚úÖ <strong>¬°Ingreso registrado exitosamente!</strong><br><br>
                    üìã <strong>Resumen:</strong><br>
                    üë§ Asesor: ${formDataIngreso.asesor}<br>
                    üìç Ciudad: ${formDataIngreso.ciudad}<br>
                    üè™ Punto: ${formDataIngreso.puntoVenta}<br>
                    üì∏ Foto: ${formDataIngreso.selfie.includes('No capturada') ? 'No capturada' : 'Capturada'}
                `);
                
                showNotification('Ingreso registrado correctamente', 'success');
                
                // Mostrar men√∫ principal
                setTimeout(() => showMainMenu(), 1500);
            }, 1500);
        }

        // ========== MEN√ö PRINCIPAL MEJORADO ==========
        function showMainMenu() {
            const menuBubble = document.createElement('div');
            menuBubble.className = 'select-bubble';
            
            menuBubble.innerHTML = `
                <div class="select-bubble-text">üì± <strong>Men√∫ Principal</strong><br><small>Selecciona una opci√≥n:</small></div>
                <div class="menu-options">
                    <button class="menu-button" id="btnLineal">
                        <span style="font-size: 1.3em;">üìä</span>
                        Participaci√≥n Lineal
                    </button>
                    <button class="menu-button" id="btnGaleria">
                        <span style="font-size: 1.3em;">üè¨</span>
                        Galer√≠a PDV
                    </button>
                    <button class="menu-button" id="btnProximosVencer">
                        <span style="font-size: 1.3em;">‚ö†Ô∏è</span>
                        Pr√≥ximos a Vencer
                    </button>
                    <button class="menu-button" id="btnAgotados">
                        <span style="font-size: 1.3em;">üì¶</span>
                        Productos Agotados
                    </button>
                    <button class="menu-button" id="btnDescuentos">
                        <span style="font-size: 1.3em;">üí∞</span>
                        Descuentos
                    </button>
                    <button class="menu-button" id="btnRegistrosVentas">
                        <span style="font-size: 1.3em;">üìà</span>
                        Registro Ventas
                    </button>
                    <button class="menu-button" id="btnVozConsumidor">
                        <span style="font-size: 1.3em;">üó£Ô∏è</span>
                        Voz Consumidor
                    </button>
                    <button class="menu-button" id="btnNuevoIngreso">
                        <span style="font-size: 1.3em;">üîÑ</span>
                        Nuevo Ingreso
                    </button>
                    <button class="menu-button" id="btnVerRespuestas">
                        <span style="font-size: 1.3em;">üëÅÔ∏è</span>
                        Ver Respuestas
                    </button>
                </div>
            `;

            addBotMessage('', menuBubble);

            // Asignar eventos
            setTimeout(() => {
                const actions = {
                    btnLineal: () => {
                        addUserMessage('üìä Participaci√≥n Lineal');
                        startLinealFlow();
                    },
                    btnGaleria: () => showFeatureMessage('Galer√≠a de Puntos de Venta', 'Pr√≥ximamente podr√°s ver y subir fotos de los PDV.'),
                    btnProximosVencer: () => showFeatureMessage('Productos Pr√≥ximos a Vencer', 'Pr√≥ximamente podr√°s registrar productos con fechas cercanas a vencer.'),
                    btnAgotados: () => showFeatureMessage('Productos Agotados', 'Pr√≥ximamente podr√°s reportar productos agotados en inventario.'),
                    btnDescuentos: () => showFeatureMessage('Descuentos y Promociones', 'Pr√≥ximamente podr√°s registrar descuentos activos en el PDV.'),
                    btnRegistrosVentas: () => showFeatureMessage('Registros de Ventas', 'Pr√≥ximamente podr√°s capturar datos de ventas del d√≠a.'),
                    btnVozConsumidor: () => showFeatureMessage('Voz del Consumidor', 'Pr√≥ximamente podr√°s capturar comentarios y feedback de clientes.'),
                    btnNuevoIngreso: () => {
                        if (confirm('¬øEst√°s seguro de iniciar un nuevo ingreso? Se reiniciar√° el proceso.')) {
                            location.reload();
                        }
                    },
                    btnVerRespuestas: () => {
                        window.open('https://docs.google.com/forms/d/1FAIpQLSc0Kt8C392ffQH6b5eFt-TE8-778mqqwb9tdWCt8XWqQfUgFg/edit#responses', '_blank');
                        showNotification('Abriendo respuestas en nueva pesta√±a', 'success');
                    }
                };

                Object.keys(actions).forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) btn.onclick = actions[id];
                });
            }, 100);
        }

        function showFeatureMessage(title, description) {
            addUserMessage(title);
            showTyping();
            setTimeout(() => {
                hideTyping();
                addBotMessage(`üîß <strong>${title}</strong><br><br>${description}<br><br><small>Esta funci√≥n estar√° disponible en la pr√≥xima actualizaci√≥n.</small>`);
            }, 800);
        }

        // ========== FLUJO LINEAL (MANTENIDO) ==========
        function startLinealFlow() {
            currentFlow = 'lineal';
            currentStep = 0;

            showTyping();
            setTimeout(() => {
                hideTyping();
                addBotMessage('¬°Perfecto! Vamos a registrar la participaci√≥n lineal. üìä');
                setTimeout(() => {
                    addBotMessage('', createSelect(
                        ['MARCA PROPIA', 'MARCA COMPETENCIA'],
                        'Selecciona el tipo...',
                        'üè∑Ô∏è ¬øQu√© tipo de marca vas a registrar?',
                        (tipo) => processLinealResponse(tipo)
                    ));
                }, 600);
            }, 800);
        }

        function processLinealResponse(response) {
            showTyping();

            setTimeout(() => {
                hideTyping();

                switch(currentStep) {
                    case 0:
                        formDataLineal.tipoMarca = response;
                        if (response === 'MARCA PROPIA') {
                            addBotMessage('Marca propia seleccionada ‚úÖ');
                            setTimeout(() => {
                                addBotMessage('', createSelect(
                                    productosMarcaPropia,
                                    'Selecciona el producto...',
                                    'üì¶ Selecciona el producto de nuestra marca:',
                                    (producto) => {
                                        formDataLineal.producto = producto;
                                        addUserMessage(producto);
                                        currentStep = 2;
                                        processLinealResponse('producto_selected');
                                    }
                                ));
                            }, 600);
                        } else {
                            addBotMessage('Marca competencia seleccionada ‚úÖ');
                            setTimeout(() => {
                                addBotMessage('', createInputBubble(
                                    'Escribe el nombre del producto competencia:',
                                    'Ej: Corona, Heineken, Budweiser, Poker...',
                                    (producto) => {
                                        formDataLineal.producto = producto;
                                        currentStep = 2;
                                        processLinealResponse('producto_selected');
                                    }
                                ));
                            }, 600);
                        }
                        currentStep++;
                        break;

                    case 2:
                        addBotMessage('Producto registrado ‚úî');
                        setTimeout(() => {
                            addBotMessage('', createInputBubble(
                                'üî¢ ¬øCu√°ntas caras/frentes tiene en el lineal?',
                                'Ingresa solo n√∫meros (ej: 3, 5, 12)...',
                                (numero) => {
                                    if (!isNaN(numero) && numero.trim() !== '' && parseInt(numero) > 0) {
                                        formDataLineal.numeroFrente = numero.trim();
                                        addUserMessage(`${numero} frentes`);
                                        currentStep++;
                                        processLinealResponse('numero_selected');
                                    } else {
                                        addBotMessage('‚ùå Por favor ingresa un n√∫mero v√°lido mayor a 0.');
                                        currentStep = 2;
                                        processLinealResponse('invalid_number');
                                    }
                                },
                                'number'
                            ));
                        }, 600);
                        break;

                    case 3:
                        showConfirmacionLineal();
                        break;
                }
            }, 800);
        }

        function showConfirmacionLineal() {
            const confirmBubble = document.createElement('div');
            confirmBubble.className = 'select-bubble';

            confirmBubble.innerHTML = `
                <div class="select-bubble-text">üìã <strong>Confirma los datos:</strong></div>
                <div style="background: rgba(37, 211, 102, 0.1); padding: 15px; border-radius: 12px; margin: 15px 0; border: 2px solid rgba(37, 211, 102, 0.2);">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 1.2em;">üè∑Ô∏è</span>
                        <span style="font-weight: 600;">Tipo:</span> ${formDataLineal.tipoMarca}
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 1.2em;">üì¶</span>
                        <span style="font-weight: 600;">Producto:</span> ${formDataLineal.producto}
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.2em;">üî¢</span>
                        <span style="font-weight: 600;">Frentes:</span> ${formDataLineal.numeroFrente}
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="action-button" id="btnConfirmarLineal" style="flex: 1;">
                        ‚úÖ Confirmar y Enviar
                    </button>
                    <button class="action-button skip-btn" id="btnCancelarLineal" style="flex: 1;">
                        ‚ùå Corregir
                    </button>
                </div>
            `;

            addBotMessage('', confirmBubble);

            setTimeout(() => {
                document.getElementById('btnConfirmarLineal').onclick = () => {
                    addUserMessage('‚úÖ Confirmar y Enviar');
                    submitFormLineal();
                };
                document.getElementById('btnCancelarLineal').onclick = () => {
                    addUserMessage('‚ùå Corregir datos');
                    showTyping();
                    setTimeout(() => {
                        hideTyping();
                        addBotMessage('¬°No hay problema! Empecemos de nuevo. üîÑ');
                        setTimeout(() => startLinealFlow(), 800);
                    }, 800);
                };
            }, 100);
        }

        function submitFormLineal() {
            showTyping();
            
            setTimeout(() => {
                hideTyping();
                
                document.getElementById('tipoMarcaField').value = formDataLineal.tipoMarca;
                document.getElementById('productoField').value = formDataLineal.producto;
                document.getElementById('numeroFrentesField').value = formDataLineal.numeroFrente;

                document.getElementById('googleFormLineal').submit();

                addBotMessage(`
                    ‚úÖ <strong>¬°Participaci√≥n lineal registrada!</strong><br><br>
                    üìã <strong>Datos enviados:</strong><br>
                    üè∑Ô∏è Tipo: ${formDataLineal.tipoMarca}<br>
                    üì¶ Producto: ${formDataLineal.producto}<br>
                    üî¢ Frentes: ${formDataLineal.numeroFrente}
                `);
                
                showNotification('Datos de lineal guardados', 'success');
                
                setTimeout(() => {
                    const askBubble = document.createElement('div');
                    askBubble.className = 'select-bubble';
                    askBubble.innerHTML = `
                        <div class="select-bubble-text">¬øQu√© deseas hacer ahora?</div>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="action-button" id="btnOtroRegistro" style="flex: 1;">
                                üìä Registrar otro
                            </button>
                            <button class="action-button camera-btn" id="btnVolverMenu" style="flex: 1;">
                                üè† Men√∫ principal
                            </button>
                        </div>
                    `;
                    
                    addBotMessage('', askBubble);
                    
                    setTimeout(() => {
                        document.getElementById('btnOtroRegistro').onclick = () => {
                            formDataLineal = { tipoMarca: '', producto: '', numeroFrente: '' };
                            startLinealFlow();
                        };
                        document.getElementById('btnVolverMenu').onclick = showMainMenu;
                    }, 100);
                }, 1000);
            }, 1500);
        }

        // ========== INICIALIZACI√ìN ==========
        function initChat() {
            setTimeout(() => {
                addBotMessage(`
                    üç∫ <strong>¬°Hola!</strong><br>
                    Soy tu asistente para registros en Puntos de Venta Beer.<br><br>
                    üìç Puedo ayudarte con:<br>
                    ‚Ä¢ Registro de ingreso (ubicaci√≥n + selfie)<br>
                    ‚Ä¢ Participaci√≥n lineal de productos<br>
                    ‚Ä¢ Gesti√≥n completa del PDV<br><br>
                    <small>Selecciona tu nombre para comenzar:</small>
                `);
                
                setTimeout(() => {
                    addBotMessage('', createSelect(
                        asesores,
                        'Selecciona tu nombre...',
                        'üë§ ¬øQui√©n eres?',
                        (asesor) => processIngresoResponse(asesor)
                    ));
                }, 1200);
            }, 500);
        }

        // Iniciar cuando cargue la p√°gina
        window.addEventListener('DOMContentLoaded', initChat);
        
        // Para GitHub Pages - Asegurar HTTPS
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            location.protocol = 'https:';
        }

    </script>
</body>
</html>
