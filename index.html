<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PDV - Asistente Beer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #e5ddd5;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            overflow: hidden;
        }

        .background-pattern {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400"><defs><pattern id="pattern" x="0" y="0" width="40" height="40" patternUnits="userSpaceOnUse"><path d="M0 20 Q10 10 20 20 T40 20" stroke="%23d9d9d9" stroke-width="0.5" fill="none" opacity="0.4"/></pattern></defs><rect width="400" height="400" fill="%23e5ddd5"/><rect width="400" height="400" fill="url(%23pattern)"/></svg>');
        }

        .chat-container {
            width: 100%;
            max-width: 100%;
            height: 100vh;
            background: #e5ddd5;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
        }

        .chat-header {
            background: #075e54;
            color: white;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd700 0%, #ffb800 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            flex-shrink: 0;
        }

        .header-info {
            flex: 1;
        }

        .header-name {
            font-size: 1.05em;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .header-status {
            font-size: 0.75em;
            color: rgba(255,255,255,0.8);
        }

        .chat-messages {
            flex: 1;
            padding: 12px 8px 80px;
            overflow-y: auto;
            background: #e5ddd5;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400"><defs><pattern id="pattern" x="0" y="0" width="40" height="40" patternUnits="userSpaceOnUse"><path d="M0 20 Q10 10 20 20 T40 20" stroke="%23d9d9d9" stroke-width="0.5" fill="none" opacity="0.4"/></pattern></defs><rect width="400" height="400" fill="%23e5ddd5"/><rect width="400" height="400" fill="url(%23pattern)"/></svg>');
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(134, 150, 160, 0.4);
            border-radius: 3px;
        }

        .message {
            margin-bottom: 12px;
            display: flex;
            animation: fadeIn 0.3s ease;
            padding: 0 4px;
            flex-direction: column;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-content {
            max-width: 80%;
            position: relative;
        }

        .bot-message {
            align-items: flex-start;
        }

        .bot-message .message-content {
            background: white;
            padding: 8px 12px;
            border-radius: 0 8px 8px 8px;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
            color: #303030;
        }

        .user-message {
            align-items: flex-end;
        }

        .user-message .message-content {
            background: #dcf8c6;
            padding: 8px 12px;
            border-radius: 8px 0 8px 8px;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
            margin-left: auto;
            color: #303030;
        }

        .message-time {
            font-size: 0.65em;
            color: #667781;
            text-align: right;
            margin-top: 4px;
        }

        .select-bubble {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(30px) saturate(200%);
            -webkit-backdrop-filter: blur(30px) saturate(200%);
            padding: 10px 12px 12px;
            border-radius: 0 8px 8px 8px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.6);
            border: 1.5px solid rgba(255, 255, 255, 0.5);
            max-width: 85%;
            margin-top: 8px;
        }

        .select-bubble-text {
            margin-bottom: 10px;
            font-size: 0.95em;
            color: #303030;
            font-weight: 500;
        }

        .custom-select {
            position: relative;
            width: 100%;
        }

        .select-button {
            width: 100%;
            padding: 12px 14px;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(35px);
            -webkit-backdrop-filter: blur(35px);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 10px;
            color: #303030;
            font-size: 0.9em;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .select-button:active {
            transform: scale(0.98);
        }

        .select-button.active {
            border-color: rgba(37, 211, 102, 0.7);
            background: rgba(255, 255, 255, 0.6);
        }

        .select-arrow {
            transition: transform 0.3s;
            font-size: 0.8em;
            color: #667781;
        }

        .select-button.active .select-arrow {
            transform: rotate(180deg);
        }

        .select-dropdown {
            position: fixed;
            left: 8px;
            right: 8px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(50px);
            -webkit-backdrop-filter: blur(50px);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 14px;
            max-height: 0;
            overflow: hidden;
            transition: all 0.4s;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
            z-index: 9999;
        }

        .select-dropdown.active {
            max-height: 70vh;
            overflow-y: auto;
            padding: 10px;
        }

        .select-dropdown::-webkit-scrollbar {
            width: 5px;
        }

        .select-dropdown::-webkit-scrollbar-thumb {
            background: rgba(37, 211, 102, 0.4);
            border-radius: 10px;
        }

        .select-search {
            position: sticky;
            top: 0;
            padding: 8px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(25px);
            z-index: 10;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 10px 10px 0 0;
            margin: -2px -2px 8px;
        }

        .select-search input {
            width: 100%;
            padding: 10px 12px;
            background: rgba(240, 240, 240, 0.4);
            border: 1.5px solid rgba(255, 255, 255, 0.4);
            border-radius: 8px;
            color: #303030;
            font-size: 0.9em;
            outline: none;
        }

        .select-search input:focus {
            border-color: rgba(37, 211, 102, 0.6);
        }

        .select-option {
            padding: 11px 12px;
            color: #303030;
            cursor: pointer;
            border-radius: 9px;
            margin: 3px 0;
            transition: all 0.25s;
            font-size: 0.9em;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .select-option:hover {
            background: rgba(37, 211, 102, 0.18);
            border-color: rgba(37, 211, 102, 0.4);
            transform: translateX(3px);
        }

        .select-option:active {
            transform: scale(0.97);
        }

        .capture-container {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            padding: 12px;
            border-radius: 0 8px 8px 8px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
            border: 1.5px solid rgba(255, 255, 255, 0.5);
            max-width: 85%;
            margin-top: 8px;
        }

        .capture-title {
            font-size: 0.95em;
            color: #303030;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .action-button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #25d366 0%, #20ba5a 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
            margin-bottom: 8px;
        }

        .action-button:active {
            transform: scale(0.98);
        }

        .action-button:disabled {
            background: linear-gradient(135deg, #b0b0b0 0%, #999999 100%);
            cursor: not-allowed;
        }

        .action-button.camera-btn {
            background: linear-gradient(135deg, #2196F3 0%, #0b7dda 100%);
        }

        .action-button.skip-btn {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }

        video {
            width: 100%;
            border-radius: 10px;
            margin: 8px 0;
            transform: scaleX(-1);
            display: none;
        }

        .captured-photo {
            width: 100%;
            border-radius: 10px;
            margin-top: 8px;
            display: none;
        }

        .info-text {
            font-size: 0.85em;
            color: #667781;
            margin-top: 8px;
            text-align: center;
        }

        .menu-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .menu-button {
            padding: 12px;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(25px);
            border: 1.5px solid rgba(255, 255, 255, 0.4);
            border-radius: 10px;
            color: #303030;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s;
        }

        .menu-button:active {
            transform: scale(0.98);
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667781;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }

        .input-bubble {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(30px);
            padding: 10px 12px;
            border-radius: 0 8px 8px 8px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
            border: 1.5px solid rgba(255, 255, 255, 0.5);
            max-width: 85%;
            margin-top: 8px;
        }

        .input-bubble-text {
            margin-bottom: 8px;
            font-size: 0.95em;
            color: #303030;
            font-weight: 500;
        }

        .input-field {
            width: 100%;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 8px;
            color: #303030;
            font-size: 0.9em;
            outline: none;
        }

        .input-field:focus {
            border-color: rgba(37, 211, 102, 0.6);
        }

        .send-input-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #25d366 0%, #20ba5a 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            margin-top: 8px;
            transition: all 0.3s;
        }

        .send-input-btn:active {
            transform: scale(0.98);
        }

        @media (min-width: 768px) {
            .chat-container {
                max-width: 500px;
                height: 700px;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            }

            .chat-header {
                border-radius: 12px 12px 0 0;
            }
        }
    </style>
</head>
<body>
    <div class="background-pattern"></div>
    <div class="chat-container">
        <div class="chat-header">
            <div class="header-avatar">üç∫</div>
            <div class="header-info">
                <div class="header-name">Asistente PDV Beer</div>
                <div class="header-status">en l√≠nea</div>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages"></div>
    </div>

    <video id="videoStream" autoplay playsinline></video>
    <canvas id="photoCanvas" style="display:none;"></canvas>

    <iframe name="hidden_iframe_ingreso" style="display:none;"></iframe>
    <form id="googleFormIngreso" 
          action="https://docs.google.com/forms/d/e/1FAIpQLSc0Kt8C392ffQH6b5eFt-TE8-778mqqwb9tdWCt8XWqQfUgFg/formResponse" 
          target="hidden_iframe_ingreso" 
          method="POST"
          style="display:none;">
        <input type="text" name="entry.1176318650" id="asesorField">
        <input type="text" name="entry.735888429" id="ubicacionField">
        <input type="text" name="entry.363650812" id="selfieField">
        <input type="text" name="entry.704645502" id="ciudadField">
        <input type="text" name="entry.732551510" id="puntoVentaField">
        <input type="text" name="entry.1281420665" id="confirmacionField" value="S√≠, es correcta">
    </form>

    <iframe name="hidden_iframe_lineal" style="display:none;"></iframe>
    <form id="googleFormLineal" 
          action="https://docs.google.com/forms/d/e/1FAIpQLScieYTjkAlXma8QLdmMQD2q-gcQb3h8fBWlw1kAWdHrLs8Vow/formResponse" 
          target="hidden_iframe_lineal" 
          method="POST"
          style="display:none;">
        <input type="text" name="entry.238753566" id="tipoMarcaField">
        <input type="text" name="entry.536323816" id="productoField">
        <input type="text" name="entry.857124037" id="numeroFrentesField">
        <input type="text" name="entry.1305667853" id="datosCorrectosField" value="S√≠">
    </form>

    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyCvuZE34DkSCMy7Z_dr7DEaye3a2K2nArlePMG8QuFnxBSjduy4OK8pB1eUR9Nb4PI/exec';

        const formDataIngreso = {
            asesor: '',
            ubicacion: '',
            selfie: '',
            ciudad: '',
            puntoVenta: ''
        };

        const formDataLineal = {
            tipoMarca: '',
            producto: '',
            numeroFrente: ''
        };

        const asesores = [
            'Juan David Benavides Gonz√°lez', 'Robinson Esneyder Zapata Anzola',
            'Sheyla Carolina G√≥mez Pati√±o', 'Harlinton Roisel Ortega Nieves',
            'Maria Paula Contreras', 'Leidy Jhoanna Restrepo Zapata',
            'Daniela Andrea Calvo Corena', 'Yadina Villanueva Sibaja',
            'Sandra Viviana Zapata Viafara', 'Stefany Bernal Tique',
            'Angie Vanessa Valenciano Romero', 'Sara Florez Velez',
            'Sara Posso Quintero', 'Juliet Lasso Ramirez',
            'Jenny Marcela Jaramillo Mejia', 'David Lopez Cardenas',
            'Ashly Valentina Montoya Rincon', 'Jaime Andres Castro Diaz',
            'Sergio Alejandro Murillo Gonzales'
        ];

        const ciudades = [
            'Arjona', 'Armenia', 'Barranquilla', 'Cali', 'Cartagena', 'Fusagasug√°',
            'Girardot', 'Guadalajara De Buga', 'Jamundi', 'La Mesa', 'Malambo',
            'Manizales', 'Melgar', 'Neiva', 'Palmira', 'Pereira', 'Pereira- Dosquebradas',
            'Popayan', 'Soledad', 'Tulua', 'Tunja', 'Turbaco', 'Villavicencio',
            'Yumbo', 'Ibagu√©'
        ];

        const puntosVenta = [
            'STO 116 ARJONA', 'Ex 065 Exito Unicentro Armenia',
            'Carulla Feria De Los Platanos', 'Sa 358 Portal Del Quindio',
            'Sa 366 San Diego', 'Si 4235 Super Inter Las Americas',
            'Ex 628 Exito Armenia', 'Si 4239 Super Inter Armenia Plaza',
            'Oxxo Esquina Laureles', 'St 355 Armenia Norte'
        ];

        const productosMarcaPropia = [
            'ANDINA 330 ml x 6', 'ANDINA 330 ml x 24', 'ANDINA ZERO 330 ml x 6',
            'CLUB COLOMBIA DORADA 330 ml x 6', 'CLUB COLOMBIA DORADA 330 ml x 24',
            'POKER 330 ml x 6', 'POKER 330 ml x 24', 'PILSEN 330 ml x 6',
            'COSTE√ëA 330 ml x 6', '√ÅGUILA 330 ml x 6', '√ÅGUILA LIGHT 330 ml x 6'
        ];

        let currentFlow = '';
        let currentStep = 0;
        let videoStream = null;
        let photoBase64 = null;
        let photoSkipped = false;

        const chatMessages = document.getElementById('chatMessages');

        function getTime() {
            const now = new Date();
            return now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
        }

        function scrollToBottom() {
            setTimeout(() => chatMessages.scrollTop = chatMessages.scrollHeight, 100);
        }

        function addBotMessage(text, customElement = null) {
            const wrapper = document.createElement('div');
            wrapper.className = 'message bot-message';

            if (!customElement) {
                const bubble = document.createElement('div');
                bubble.className = 'message-content';
                bubble.innerHTML = text;
                
                const time = document.createElement('div');
                time.className = 'message-time';
                time.textContent = getTime();
                bubble.appendChild(time);
                
                wrapper.appendChild(bubble);
            } else {
                wrapper.appendChild(customElement);
            }

            chatMessages.appendChild(wrapper);
            scrollToBottom();
        }

        function addUserMessage(text) {
            const wrapper = document.createElement('div');
            wrapper.className = 'message user-message';

            const bubble = document.createElement('div');
            bubble.className = 'message-content';
            bubble.textContent = text;

            const time = document.createElement('div');
            time.className = 'message-time';
            time.textContent = getTime();
            bubble.appendChild(time);

            wrapper.appendChild(bubble);
            chatMessages.appendChild(wrapper);
            scrollToBottom();
        }

        function createSelect(options, placeholder, label, onSelect) {
            const bubble = document.createElement('div');
            bubble.className = 'select-bubble';

            const titleDiv = document.createElement('div');
            titleDiv.className = 'select-bubble-text';
            titleDiv.textContent = label;
            bubble.appendChild(titleDiv);

            const selectId = 'select-' + Date.now();
            const container = document.createElement('div');
            container.innerHTML = `
                <div class="custom-select">
                    <div class="select-button" id="${selectId}-btn">
                        <span id="${selectId}-text">${placeholder}</span>
                        <span class="select-arrow">‚ñº</span>
                    </div>
                    <div class="select-dropdown" id="${selectId}-dropdown">
                        <div class="select-search">
                            <input type="text" placeholder="üîç Buscar..." id="${selectId}-search">
                        </div>
                        <div class="select-options" id="${selectId}-options"></div>
                    </div>
                </div>
            `;
            bubble.appendChild(container);

            setTimeout(() => {
                const btn = document.getElementById(`${selectId}-btn`);
                const dropdown = document.getElementById(`${selectId}-dropdown`);
                const search = document.getElementById(`${selectId}-search`);
                const optionsContainer = document.getElementById(`${selectId}-options`);
                const textSpan = document.getElementById(`${selectId}-text`);

                options.forEach(opt => {
                    const optDiv = document.createElement('div');
                    optDiv.className = 'select-option';
                    optDiv.textContent = opt;
                    optDiv.onclick = () => {
                        textSpan.textContent = opt;
                        dropdown.classList.remove('active');
                        btn.classList.remove('active');
                        btn.style.pointerEvents = 'none';
                        btn.style.opacity = '0.6';
                        addUserMessage(opt);
                        if (onSelect) onSelect(opt);
                    };
                    optionsContainer.appendChild(optDiv);
                });

                btn.onclick = (e) => {
                    e.stopPropagation();
                    const isOpen = dropdown.classList.contains('active');
                    document.querySelectorAll('.select-dropdown').forEach(d => d.classList.remove('active'));
                    document.querySelectorAll('.select-button').forEach(b => b.classList.remove('active'));
                    if (!isOpen) {
                        dropdown.classList.add('active');
                        btn.classList.add('active');
                        
                        const btnRect = btn.getBoundingClientRect();
                        dropdown.style.top = (btnRect.bottom + 8) + 'px';
                        
                        setTimeout(() => search.focus(), 100);
                    }
                };

                search.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                    optionsContainer.querySelectorAll('.select-option').forEach(opt => {
                        const text = opt.textContent.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                        opt.style.display = text.includes(term) ? 'block' : 'none';
                    });
                });

                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.custom-select')) {
                        dropdown.classList.remove('active');
                        btn.classList.remove('active');
                    }
                });
            }, 100);

            return bubble;
        }

        function createInputBubble(label, placeholder, onSubmit) {
            const bubble = document.createElement('div');
            bubble.className = 'input-bubble';

            const inputId = 'input-' + Date.now();
            bubble.innerHTML = `
                <div class="input-bubble-text">${label}</div>
                <input type="text" class="input-field" id="${inputId}" placeholder="${placeholder}">
                <button class="send-input-btn" id="${inputId}-btn">Enviar</button>
            `;

            setTimeout(() => {
                const input = document.getElementById(inputId);
                const btn = document.getElementById(`${inputId}-btn`);

                const submitValue = () => {
                    const value = input.value.trim();
                    if (value) {
                        input.disabled = true;
                        btn.disabled = true;
                        addUserMessage(value);
                        if (onSubmit) onSubmit(value);
                    }
                };

                btn.onclick = submitValue;
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') submitValue();
                });
            }, 100);

            return bubble;
        }

        function createCaptureContainer() {
            const container = document.createElement('div');
            container.className = 'capture-container';
            container.id = 'captureContainer';

            container.innerHTML = `
                <div class="capture-title">Captura de ubicaci√≥n y foto:</div>
                <button class="action-button" id="locationBtn">üìç Capturar ubicaci√≥n</button>
                <button class="action-button camera-btn" id="cameraBtn" style="display:none;">üì∏ Abrir c√°mara</button>
                <button class="action-button skip-btn" id="skipPhotoBtn" style="display:none;">‚è≠Ô∏è Continuar sin foto</button>
                <video id="videoPreview" autoplay playsinline></video>
                <button class="action-button" id="capturePhotoBtn" style="display:none;">‚úî Capturar foto</button>
                <img id="capturedPhoto" class="captured-photo">
                <div class="info-text" id="infoText"></div>
            `;

            setTimeout(() => {
                document.getElementById('locationBtn').onclick = captureLocation;
                document.getElementById('cameraBtn').onclick = openCamera;
                document.getElementById('skipPhotoBtn').onclick = skipPhoto;
                document.getElementById('capturePhotoBtn').onclick = takePhoto;
            }, 100);

            return container;
        }

        function captureLocation() {
            const btn = document.getElementById('locationBtn');
            const infoText = document.getElementById('infoText');
            
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Obteniendo ubicaci√≥n...';
            infoText.textContent = 'Obteniendo tu ubicaci√≥n GPS...';

            if (!navigator.geolocation) {
                infoText.textContent = '‚ùå Tu dispositivo no soporta geolocalizaci√≥n';
                btn.disabled = false;
                btn.innerHTML = 'üìç Capturar ubicaci√≥n';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const coords = `${position.coords.latitude.toFixed(7)},${position.coords.longitude.toFixed(7)}`;
                    formDataIngreso.ubicacion = coords;
                    
                    btn.innerHTML = '‚úÖ Ubicaci√≥n capturada';
                    btn.style.background = 'linear-gradient(135deg, #128c7e 0%, #075e54 100%)';
                    infoText.textContent = `‚úÖ Coordenadas: ${coords}`;
                    
                    setTimeout(() => {
                        document.getElementById('cameraBtn').style.display = 'block';
                        document.getElementById('skipPhotoBtn').style.display = 'block';
                    }, 500);
                },
                (error) => {
                    infoText.textContent = '‚ùå No se pudo obtener la ubicaci√≥n. Por favor activa el GPS.';
                    btn.disabled = false;
                    btn.innerHTML = 'üìç Reintentar';
                },
                { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
            );
        }

        async function openCamera() {
            const btn = document.getElementById('cameraBtn');
            const video = document.getElementById('videoPreview');
            const infoText = document.getElementById('infoText');

            try {
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Iniciando c√°mara...';
                infoText.textContent = 'Iniciando c√°mara frontal...';

                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } },
                    audio: false
                });

                video.srcObject = videoStream;
                video.style.display = 'block';
                
                btn.style.display = 'none';
                document.getElementById('skipPhotoBtn').style.display = 'none';
                document.getElementById('capturePhotoBtn').style.display = 'block';
                infoText.textContent = '‚úÖ C√°mara activa. Cuando est√©s listo, captura tu foto.';

            } catch (error) {
                infoText.textContent = '‚ùå Error al acceder a la c√°mara. Contin√∫a sin foto.';
                btn.disabled = false;
                btn.innerHTML = 'üì∏ Abrir c√°mara';
            }
        }

        function skipPhoto() {
            photoSkipped = true;
            formDataIngreso.selfie = 'No capturada';
            addUserMessage('‚è≠Ô∏è Continuar sin foto');
            processIngresoResponse('skipped_photo');
        }

        async function takePhoto() {
            const btn = document.getElementById('capturePhotoBtn');
            const video = document.getElementById('videoPreview');
            const canvas = document.getElementById('photoCanvas');
            const capturedImg = document.getElementById('capturedPhoto');
            const infoText = document.getElementById('infoText');

            try {
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Capturando...';
                infoText.textContent = 'üì∏ Capturando foto...';

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const context = canvas.getContext('2d');
                context.translate(canvas.width, 0);
                context.scale(-1, 1);
                context.drawImage(video, 0, 0);

                photoBase64 = canvas.toDataURL('image/jpeg', 0.85);
                capturedImg.src = photoBase64;
                capturedImg.style.display = 'block';

                if (videoStream) {
                    videoStream.getTracks().forEach(track => track.stop());
                }
                video.style.display = 'none';
                btn.style.display = 'none';

                infoText.textContent = '‚è≥ Subiendo foto a Drive...';

                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image: photoBase64,
                        asesor: formDataIngreso.asesor,
                        ubicacion: formDataIngreso.ubicacion
                    })
                });

                const result = await response.json();

                if (result.success) {
                    formDataIngreso.selfie = result.publicUrl || result.directLink;
                    infoText.textContent = `‚úÖ Foto guardada: ${result.fileName}`;
                    
                    setTimeout(() => {
                        addUserMessage('‚úÖ Ubicaci√≥n y foto capturadas');
                        processIngresoResponse('captured_data');
                    }, 1000);
                } else {
                    throw new Error(result.error || 'Error al guardar');
                }

            } catch (error) {
                infoText.textContent = `‚ö†Ô∏è Error al subir foto. Continuando...`;
                formDataIngreso.selfie = 'Error al capturar';
                setTimeout(() => {
                    addUserMessage('‚ö†Ô∏è Continuando sin foto');
                    processIngresoResponse('captured_data');
                }, 1500);
            }
        }

        function showTyping() {
            const wrapper = document.createElement('div');
            wrapper.className = 'message bot-message';
            wrapper.id = 'typing';
            wrapper.innerHTML = `
                <div class="message-content">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(wrapper);
            scrollToBottom();
        }

        function hideTyping() {
            const typing = document.getElementById('typing');
            if (typing) typing.remove();
        }

        function processIngresoResponse(response) {
            showTyping();

            setTimeout(() => {
                hideTyping();

                switch(currentStep) {
                    case 0:
                        formDataIngreso.asesor = response;
                        addBotMessage(`¬°Hola ${response.split(' ')[0]}! üëã`);
                        setTimeout(() => {
                            addBotMessage('', createCaptureContainer());
                        }, 600);
                        currentStep++;
                        break;

                    case 1:
                        addBotMessage('¬°Perfecto! ‚úÖ');
                        setTimeout(() => {
                            addBotMessage('', createSelect(ciudades, 'Selecciona tu ciudad...', 'Ahora dime tu ciudad:', (ciudad) => {
                                processIngresoResponse(ciudad);
                            }));
                        }, 600);
                        currentStep++;
                        break;

                    case 2:
                        formDataIngreso.ciudad = response;
                        addBotMessage('Excelente ‚úî');
                        setTimeout(() => {
                            addBotMessage('', createSelect(puntosVenta, 'Selecciona el punto de venta...', 'Por √∫ltimo, tu punto de venta:', (punto) => {
                                processIngresoResponse(punto);
                            }));
                        }, 600);
                        currentStep++;
                        break;

                    case 3:
                        formDataIngreso.puntoVenta = response;
                        currentStep++;
                        submitFormIngreso();
                        break;
                }
            }, 800);
        }

        function submitFormIngreso() {
            addBotMessage('Enviando tu ingreso... ‚è≥');

            document.getElementById('asesorField').value = formDataIngreso.asesor;
            document.getElementById('ubicacionField').value = formDataIngreso.ubicacion;
            document.getElementById('selfieField').value = formDataIngreso.selfie;
            document.getElementById('ciudadField').value = formDataIngreso.ciudad;
            document.getElementById('puntoVentaField').value = formDataIngreso.puntoVenta;

            setTimeout(() => {
                document.getElementById('googleFormIngreso').submit();

                setTimeout(() => {
                    addBotMessage('‚úÖ ¬°Ingreso registrado exitosamente!');
                    
                    setTimeout(() => {
                        showMainMenu();
                    }, 800);
                }, 1000);
            }, 500);
        }

        function showMainMenu() {
            const menuBubble = document.createElement('div');
            menuBubble.className = 'select-bubble';

            menuBubble.innerHTML = `
                <div class="select-bubble-text">¬øQu√© deseas hacer?</div>
                <div class="menu-options">
                    <button class="menu-button" id="btnLineal">
                        üìä Registrar Participaci√≥n Lineal
                    </button>
                    <button class="menu-button" id="btnNuevoIngreso">
                        üîÑ Nuevo ingreso
                    </button>
                    <button class="menu-button" id="btnVerRespuestas">
                        üìà Ver respuestas
                    </button>
                </div>
            `;

            addBotMessage('', menuBubble);

            setTimeout(() => {
                document.getElementById('btnLineal').onclick = () => {
                    addUserMessage('üìä Registrar Participaci√≥n Lineal');
                    startLinealFlow();
                };
                document.getElementById('btnNuevoIngreso').onclick = () => location.reload();
                document.getElementById('btnVerRespuestas').onclick = () => {
                    window.open('https://docs.google.com/forms/d/1FAIpQLSc0Kt8C392ffQH6b5eFt-TE8-778mqqwb9tdWCt8XWqQfUgFg/edit#responses', '_blank');
                };
            }, 100);
        }

        function startLinealFlow() {
            currentFlow = 'lineal';
            currentStep = 0;

            showTyping();
            setTimeout(() => {
                hideTyping();
                addBotMessage('¬°Perfecto! Vamos a registrar la participaci√≥n lineal. üìä');
                setTimeout(() => {
                    const selectBubble = createSelect(
                        ['MARCA PROPIA', 'MARCA COMPETENCIA'],
                        'Selecciona el tipo...',
                        'Selecciona el tipo de marca:',
                        (tipo) => processLinealResponse(tipo)
                    );
                    addBotMessage('', selectBubble);
                }, 600);
            }, 800);
        }

        function processLinealResponse(response) {
            showTyping();

            setTimeout(() => {
                hideTyping();

                switch(currentStep) {
                    case 0:
                        formDataLineal.tipoMarca = response;
                        if (response === 'MARCA PROPIA') {
                            addBotMessage('Marca propia seleccionada ‚úÖ');
                            setTimeout(() => {
                                addBotMessage('', createSelect(
                                    productosMarcaPropia,
                                    'Selecciona el producto...',
                                    'Selecciona el producto:',
                                    (producto) => {
                                        formDataLineal.producto = producto;
                                        addUserMessage(producto);
                                        currentStep = 2;
                                        processLinealResponse('producto_selected');
                                    }
                                ));
                            }, 600);
                        } else {
                            addBotMessage('Marca competencia seleccionada ‚úÖ');
                            setTimeout(() => {
                                addBotMessage('', createInputBubble(
                                    'Escribe el nombre del producto competencia:',
                                    'Ej: Corona, Heineken...',
                                    (producto) => {
                                        formDataLineal.producto = producto;
                                        currentStep = 2;
                                        processLinealResponse('producto_selected');
                                    }
                                ));
                            }, 600);
                        }
                        currentStep++;
                        break;

                    case 2:
                        addBotMessage('Producto registrado ‚úî');
                        setTimeout(() => {
                            addBotMessage('', createInputBubble(
                                '¬øCu√°ntas caras/frentes tiene en el lineal?',
                                'Ingresa un n√∫mero...',
                                (numero) => {
                                    formDataLineal.numeroFrente = numero;
                                    addUserMessage(numero);
                                    currentStep++;
                                    processLinealResponse('numero_selected');
                                }
                            ));
                        }, 600);
                        break;

                    case 3:
                        addBotMessage('Perfecto ‚úÖ');
                        setTimeout(() => {
                            showConfirmacionLineal();
                        }, 600);
                        break;
                }
            }, 800);
        }

        function showConfirmacionLineal() {
            const confirmBubble = document.createElement('div');
            confirmBubble.className = 'select-bubble';

            confirmBubble.innerHTML = `
                <div class="select-bubble-text">Confirma los datos:</div>
                <div style="background: rgba(255,255,255,0.3); padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 0.85em;">
                    <div style="margin-bottom: 5px;"><strong>Tipo:</strong> ${formDataLineal.tipoMarca}</div>
                    <div style="margin-bottom: 5px;"><strong>Producto:</strong> ${formDataLineal.producto}</div>
                    <div><strong>Frentes:</strong> ${formDataLineal.numeroFrente}</div>
                </div>
                <div class="menu-options">
                    <button class="menu-button" id="btnConfirmarLineal" style="background: rgba(37, 211, 102, 0.3); border-color: rgba(37, 211, 102, 0.5);">
                        ‚úÖ S√≠, es correcto
                    </button>
                    <button class="menu-button" id="btnCancelarLineal" style="background: rgba(244, 67, 54, 0.3); border-color: rgba(244, 67, 54, 0.5);">
                        ‚ùå No, corregir
                    </button>
                </div>
            `;

            addBotMessage('', confirmBubble);

            setTimeout(() => {
                document.getElementById('btnConfirmarLineal').onclick = () => {
                    addUserMessage('‚úÖ S√≠, es correcto');
                    submitFormLineal();
                };
                document.getElementById('btnCancelarLineal').onclick = () => {
                    addUserMessage('‚ùå Voy a corregir');
                    showTyping();
                    setTimeout(() => {
                        hideTyping();
                        addBotMessage('Est√° bien, empecemos de nuevo. üîÑ');
                        setTimeout(() => startLinealFlow(), 800);
                    }, 800);
                };
            }, 100);
        }

        function submitFormLineal() {
            addBotMessage('Guardando participaci√≥n lineal... ‚è≥');

            document.getElementById('tipoMarcaField').value = formDataLineal.tipoMarca;
            document.getElementById('productoField').value = formDataLineal.producto;
            document.getElementById('numeroFrentesField').value = formDataLineal.numeroFrente;

            setTimeout(() => {
                document.getElementById('googleFormLineal').submit();

                setTimeout(() => {
                    addBotMessage('‚úÖ ¬°Participaci√≥n lineal registrada!');
                    
                    setTimeout(() => {
                        askForAnotherRegistro();
                    }, 800);
                }, 1000);
            }, 500);
        }

        function askForAnotherRegistro() {
            const askBubble = document.createElement('div');
            askBubble.className = 'select-bubble';

            askBubble.innerHTML = `
                <div class="select-bubble-text">¬øDeseas registrar otra participaci√≥n?</div>
                <div class="menu-options">
                    <button class="menu-button" id="btnSiOtro">
                        ‚úÖ S√≠, registrar otro
                    </button>
                    <button class="menu-button" id="btnNoMenu">
                        üè† No, ir al men√∫
                    </button>
                </div>
            `;

            addBotMessage('', askBubble);

            setTimeout(() => {
                document.getElementById('btnSiOtro').onclick = () => {
                    addUserMessage('‚úÖ S√≠, registrar otro');
                    formDataLineal.tipoMarca = '';
                    formDataLineal.producto = '';
                    formDataLineal.numeroFrente = '';
                    startLinealFlow();
                };
                document.getElementById('btnNoMenu').onclick = () => {
                    addUserMessage('üè† Volver al men√∫');
                    showTyping();
                    setTimeout(() => {
                        hideTyping();
                        showMainMenu();
                    }, 800);
                };
            }, 100);
        }

        setTimeout(() => {
            addBotMessage('¬°Hola! üëã Soy tu asistente para registros en PDV.');
            setTimeout(() => {
                addBotMessage('Puedo ayudarte con:<br>üìç Registro de ingreso (ubicaci√≥n + selfie)<br>üìä Participaci√≥n lineal de productos<br>üìà Consulta de respuestas');
                setTimeout(() => {
                    addBotMessage('', createSelect(asesores, 'Selecciona tu nombre...', 'Para comenzar, selecciona tu nombre:', (asesor) => {
                        processIngresoResponse(asesor);
                    }));
                }, 1200);
            }, 1000);
        }, 500);
    </script>
</body>
</html>
