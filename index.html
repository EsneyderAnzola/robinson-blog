<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PDV - Asistente Beer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            overflow: hidden;
        }

        /* Contenedor principal del chat - TODO DENTRO */
        .chat-container {
            width: 100%;
            height: 100vh;
            background: #f0f2f5;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Header del chat */
        .chat-header {
            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
            color: white;
            padding: 15px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 100;
        }

        .header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd700 0%, #ffb800 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        .header-info {
            flex: 1;
        }

        .header-name {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .header-status {
            font-size: 0.75em;
            color: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* √Årea de mensajes - TODO DENTRO DEL CHAT */
        .chat-messages {
            flex: 1;
            padding: 15px 12px 80px;
            overflow-y: auto;
            background: #f0f2f5;
            -webkit-overflow-scrolling: touch;
        }

        .chat-messages::-webkit-scrollbar {
            width: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(37, 211, 102, 0.3);
            border-radius: 2px;
        }

        /* Estilos de mensajes */
        .message {
            margin-bottom: 12px;
            display: flex;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(10px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .message-content {
            max-width: 80%;
            position: relative;
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 0.95em;
            line-height: 1.4;
        }

        .bot-message {
            justify-content: flex-start;
        }

        .bot-message .message-content {
            background: white;
            color: #111;
            border-radius: 0 18px 18px 18px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .user-message {
            justify-content: flex-end;
        }

        .user-message .message-content {
            background: linear-gradient(135deg, #25d366 0%, #20ba5a 100%);
            color: white;
            border-radius: 18px 0 18px 18px;
        }

        .message-time {
            font-size: 0.7em;
            color: rgba(0,0,0,0.4);
            margin-top: 4px;
            text-align: right;
        }

        /* Burbujas especiales - TODO DENTRO */
        .bubble-container {
            background: white;
            padding: 16px;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 8px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .bubble-title {
            font-size: 0.95em;
            color: #111;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Selects mejorados para m√≥vil - TODO DENTRO */
        .custom-select {
            position: relative;
            margin-bottom: 10px;
        }

        .select-button {
            width: 100%;
            padding: 14px 16px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            color: #333;
            font-size: 0.95em;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .select-button:hover {
            border-color: #25d366;
        }

        .select-button.active {
            border-color: #25d366;
            background: rgba(37, 211, 102, 0.05);
        }

        .select-dropdown {
            position: absolute;
            left: 0;
            right: 0;
            background: white;
            border-radius: 16px;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            z-index: 1000;
            opacity: 0;
            margin-top: 5px;
        }

        .select-dropdown.active {
            max-height: 60vh;
            overflow-y: auto;
            padding: 15px;
            opacity: 1;
        }

        .select-search {
            position: sticky;
            top: 0;
            padding: 10px 0;
            background: white;
            z-index: 10;
            margin-bottom: 10px;
        }

        .select-search input {
            width: 100%;
            padding: 12px 16px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 0.95em;
            outline: none;
        }

        .select-option {
            padding: 14px 16px;
            color: #333;
            cursor: pointer;
            border-radius: 12px;
            margin: 4px 0;
            transition: all 0.2s;
            font-size: 0.95em;
        }

        .select-option:hover {
            background: rgba(37, 211, 102, 0.1);
            transform: translateX(5px);
        }

        /* Botones */
        .action-button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #25d366 0%, #20ba5a 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .action-button:active {
            transform: scale(0.98);
        }

        .action-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .action-button.camera-btn {
            background: linear-gradient(135deg, #2196F3 0%, #0b7dda 100%);
        }

        .action-button.skip-btn {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }

        /* Men√∫ principal - TODO DENTRO */
        .menu-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-top: 15px;
        }

        .menu-button {
            padding: 14px 16px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            color: #333;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-button:active {
            transform: scale(0.98);
            background: #e9ecef;
        }

        /* Indicador de escritura */
        .typing-indicator {
            display: flex;
            gap: 6px;
            padding: 10px 20px;
            background: white;
            border-radius: 18px;
            width: fit-content;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #25d366;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }

        /* Input bubble - TODO DENTRO */
        .input-bubble {
            background: white;
            padding: 16px;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 8px;
        }

        .input-bubble-text {
            margin-bottom: 12px;
            font-size: 0.95em;
            color: #111;
            font-weight: 600;
        }

        .input-field {
            width: 100%;
            padding: 14px 16px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 0.95em;
            outline: none;
        }

        .input-field:focus {
            border-color: #25d366;
        }

        .send-input-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #25d366 0%, #20ba5a 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            margin-top: 12px;
            transition: all 0.2s;
        }

        .send-input-btn:active {
            transform: scale(0.98);
        }

        /* Info text */
        .info-text {
            font-size: 0.85em;
            color: #666;
            margin-top: 10px;
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        /* Prevenir zoom en inputs */
        input, select, textarea {
            font-size: 16px !important;
        }

        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
            
            .chat-container {
                max-width: 450px;
                height: 800px;
                border-radius: 20px;
                overflow: hidden;
                box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            }
        }
    </style>
</head>
<body>
    <!-- TODO EST√Å DENTRO DEL CHAT - NO HAY REDIRECCIONES -->
    <div class="chat-container">
        <div class="chat-header">
            <div class="header-avatar">üç∫</div>
            <div class="header-info">
                <div class="header-name">Asistente PDV Beer</div>
                <div class="header-status">
                    <div class="status-dot"></div>
                    en l√≠nea
                </div>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages"></div>
    </div>

    <!-- Formularios ocultos - SIN REDIRECCIONES -->
    <iframe name="hidden_iframe_ingreso" id="hiddenIframeIngreso" style="display:none;"></iframe>
    <form id="googleFormIngreso" 
          action="https://docs.google.com/forms/d/e/1FAIpQLSc0Kt8C392ffQH6b5eFt-TE8-778mqqwb9tdWCt8XWqQfUgFg/formResponse" 
          target="hiddenIframeIngreso" 
          method="POST"
          style="display:none;">
        <input type="text" name="entry.1176318650" id="asesorField">
        <input type="text" name="entry.735888429" id="ubicacionField">
        <input type="text" name="entry.363650812" id="selfieField">
        <input type="text" name="entry.704645502" id="ciudadField">
        <input type="text" name="entry.732551510" id="puntoVentaField">
        <input type="text" name="entry.1281420665" id="confirmacionField" value="S√≠, es correcta">
    </form>

    <iframe name="hidden_iframe_lineal" id="hiddenIframeLineal" style="display:none;"></iframe>
    <form id="googleFormLineal" 
          action="https://docs.google.com/forms/d/e/1FAIpQLScieYTjkAlXma8QLdmMQD2q-gcQb3h8fBWlw1kAWdHrLs8Vow/formResponse" 
          target="hiddenIframeLineal" 
          method="POST"
          style="display:none;">
        <input type="text" name="entry.238753566" id="tipoMarcaField">
        <input type="text" name="entry.536323816" id="productoField">
        <input type="text" name="entry.857124037" id="numeroFrentesField">
        <input type="text" name="entry.1305667853" id="datosCorrectosField" value="S√≠">
    </form>

    <script>
        // ========== VARIABLES GLOBALES ==========
        let appState = {
            ingreso: {
                asesor: '',
                ubicacion: '',
                selfie: '',
                ciudad: '',
                puntoVenta: '',
                completado: false
            },
            lineal: {
                tipoMarca: '',
                producto: '',
                numeroFrente: '',
                enviando: false
            },
            currentStep: 0,
            isProcessingPhoto: false,
            menuBloqueado: false
        };

        // ========== DATOS ==========
        const asesores = [
            'Juan David Benavides Gonz√°lez', 'Robinson Esneyder Zapata Anzola',
            'Sheyla Carolina G√≥mez Pati√±o', 'Harlinton Roisel Ortega Nieves',
            'Maria Paula Contreras', 'Leidy Jhoanna Restrepo Zapata',
            'Daniela Andrea Calvo Corena', 'Yadina Villanueva Sibaja',
            'Sandra Viviana Zapata Viafara', 'Stefany Bernal Tique',
            'Angie Vanessa Valenciano Romero', 'Sara Florez Velez',
            'Sara Posso Quintero', 'Juliet Lasso Ramirez',
            'Jenny Marcela Jaramillo Mejia', 'David Lopez Cardenas',
            'Ashly Valentina Montoya Rincon', 'Jaime Andres Castro Diaz',
            'Sergio Alejandro Murillo Gonzales'
        ];

        const ciudadesPuntosVenta = {
            'Arjona': ['STO 116 ARJONA'],
            'Armenia': [
                'Ex 065 Exito Unicentro Armenia',
                'Sa 358 Portal Del Quindio',
                'Sa 366 San Diego',
                'Ex 628 Exito Armenia',
                'Si 4239 Super Inter Armenia Plaza',
                'St 355 Armenia Norte'
            ],
            'Barranquilla': ['Carulla Feria De Los Platanos'],
            'Cali': ['Si 4235 Super Inter Las Americas'],
            'Cartagena': ['CC Caribe Plaza', 'CC Bocagrande'],
            'Fusagasug√°': ['√âxito Fusagasug√°'],
            'Girardot': ['Metro Girardot'],
            'Guadalajara De Buga': ['√âxito Buga'],
            'Jamundi': ['Supermercados Jamund√≠'],
            'La Mesa': ['Almacenes La Mesa'],
            'Malambo': ['Makro Malambo'],
            'Manizales': ['√âxito Manizales', 'Carulla Manizales'],
            'Melgar': ['Metro Melgar'],
            'Neiva': ['√âxito Neiva', 'Jumbo Neiva'],
            'Palmira': ['Metro Palmira'],
            'Pereira': ['√âxito Pereira', 'Sanandresito Pereira'],
            'Pereira- Dosquebradas': ['Makro Dosquebradas'],
            'Popayan': ['√âxito Popay√°n'],
            'Soledad': ['Metro Soledad', 'Makro Soledad'],
            'Tulua': ['√âxito Tulu√°', 'Carulla Tulu√°'],
            'Tunja': ['√âxito Tunja'],
            'Turbaco': ['Almacenes Turbaco'],
            'Villavicencio': ['√âxito Villavicencio', 'Jumbo Villavicencio'],
            'Yumbo': ['√âxito Yumbo'],
            'Ibagu√©': ['√âxito Ibagu√©', 'Carulla Ibagu√©']
        };

        const productosMarcaPropia = [
            'ANDINA 330 ml x 6', 'ANDINA 330 ml x 24', 'ANDINA ZERO 330 ml x 6',
            'CLUB COLOMBIA DORADA 330 ml x 6', 'CLUB COLOMBIA DORADA 330 ml x 24',
            'POKER 330 ml x 6', 'POKER 330 ml x 24', 'PILSEN 330 ml x 6',
            'COSTE√ëA 330 ml x 6', '√ÅGUILA 330 ml x 6', '√ÅGUILA LIGHT 330 ml x 6'
        ];

        const chatMessages = document.getElementById('chatMessages');

        // ========== FUNCIONES B√ÅSICAS ==========
        function getTime() {
            const now = new Date();
            return now.getHours().toString().padStart(2, '0') + ':' + 
                   now.getMinutes().toString().padStart(2, '0');
        }

        function scrollToBottom() {
            setTimeout(() => {
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }

        function addBotMessage(text, customElement = null) {
            const wrapper = document.createElement('div');
            wrapper.className = 'message bot-message';

            if (!customElement) {
                const bubble = document.createElement('div');
                bubble.className = 'message-content';
                bubble.innerHTML = text;
                
                const time = document.createElement('div');
                time.className = 'message-time';
                time.textContent = getTime();
                bubble.appendChild(time);
                
                wrapper.appendChild(bubble);
            } else {
                wrapper.appendChild(customElement);
            }

            chatMessages.appendChild(wrapper);
            scrollToBottom();
            return wrapper;
        }

        function addUserMessage(text) {
            const wrapper = document.createElement('div');
            wrapper.className = 'message user-message';

            const bubble = document.createElement('div');
            bubble.className = 'message-content';
            bubble.textContent = text;

            const time = document.createElement('div');
            time.className = 'message-time';
            time.textContent = getTime();
            bubble.appendChild(time);

            wrapper.appendChild(bubble);
            chatMessages.appendChild(wrapper);
            scrollToBottom();
        }

        function showTyping() {
            const wrapper = document.createElement('div');
            wrapper.className = 'message bot-message';
            wrapper.id = 'typing';
            wrapper.innerHTML = `
                <div class="message-content">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(wrapper);
            scrollToBottom();
        }

        function hideTyping() {
            const typing = document.getElementById('typing');
            if (typing) typing.remove();
        }

        // ========== COMPONENTES ==========
        function createSelect(options, placeholder, label, onSelect) {
            const bubble = document.createElement('div');
            bubble.className = 'bubble-container';

            const selectId = 'select-' + Date.now();
            bubble.innerHTML = `
                <div class="bubble-title">${label}</div>
                <div class="custom-select">
                    <div class="select-button" id="${selectId}-btn">
                        <span id="${selectId}-text">${placeholder}</span>
                        <span style="color:#999;">‚ñº</span>
                    </div>
                    <div class="select-dropdown" id="${selectId}-dropdown">
                        <div class="select-search">
                            <input type="text" placeholder="üîç Buscar..." id="${selectId}-search">
                        </div>
                        <div class="select-options" id="${selectId}-options"></div>
                    </div>
                </div>
            `;

            setTimeout(() => {
                const btn = document.getElementById(`${selectId}-btn`);
                const dropdown = document.getElementById(`${selectId}-dropdown`);
                const search = document.getElementById(`${selectId}-search`);
                const optionsContainer = document.getElementById(`${selectId}-options`);
                const textSpan = document.getElementById(`${selectId}-text`);

                // Limpiar opciones anteriores
                optionsContainer.innerHTML = '';

                options.forEach(opt => {
                    const optDiv = document.createElement('div');
                    optDiv.className = 'select-option';
                    optDiv.textContent = opt;
                    optDiv.onclick = () => {
                        textSpan.textContent = opt;
                        dropdown.classList.remove('active');
                        btn.classList.remove('active');
                        addUserMessage(opt);
                        if (onSelect) onSelect(opt);
                    };
                    optionsContainer.appendChild(optDiv);
                });

                btn.onclick = (e) => {
                    e.stopPropagation();
                    const isOpen = dropdown.classList.contains('active');
                    
                    // Cerrar otros dropdowns
                    document.querySelectorAll('.select-dropdown').forEach(d => {
                        if (d !== dropdown) d.classList.remove('active');
                    });
                    document.querySelectorAll('.select-button').forEach(b => {
                        if (b !== btn) b.classList.remove('active');
                    });
                    
                    if (!isOpen) {
                        dropdown.classList.add('active');
                        btn.classList.add('active');
                        setTimeout(() => search.focus(), 100);
                    }
                };

                search.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    optionsContainer.querySelectorAll('.select-option').forEach(opt => {
                        const text = opt.textContent.toLowerCase();
                        opt.style.display = text.includes(term) ? 'block' : 'none';
                    });
                });

                // Cerrar al hacer clic fuera - PERO DENTRO DEL CHAT
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.custom-select')) {
                        dropdown.classList.remove('active');
                        btn.classList.remove('active');
                    }
                });
            }, 100);

            return bubble;
        }

        function createInputBubble(label, placeholder, onSubmit, type = 'text') {
            const bubble = document.createElement('div');
            bubble.className = 'input-bubble';

            const inputId = 'input-' + Date.now();
            bubble.innerHTML = `
                <div class="input-bubble-text">${label}</div>
                <input type="${type}" class="input-field" id="${inputId}" placeholder="${placeholder}">
                <button class="send-input-btn" id="${inputId}-btn">Enviar</button>
            `;

            setTimeout(() => {
                const input = document.getElementById(inputId);
                const btn = document.getElementById(`${inputId}-btn`);

                const submitValue = () => {
                    const value = input.value.trim();
                    if (value) {
                        input.disabled = true;
                        btn.disabled = true;
                        addUserMessage(value);
                        if (onSubmit) onSubmit(value);
                    }
                };

                btn.onclick = submitValue;
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') submitValue();
                });
                
                setTimeout(() => input.focus(), 300);
            }, 100);

            return bubble;
        }

        // ========== FLUJO DE INGRESO - SIMPLIFICADO ==========
        function startIngresoFlow() {
            appState.currentStep = 0;
            appState.ingreso = {
                asesor: '',
                ubicacion: '',
                selfie: '',
                ciudad: '',
                puntoVenta: '',
                completado: false
            };
            
            showTyping();
            setTimeout(() => {
                hideTyping();
                addBotMessage('Vamos a registrar tu ingreso al PDV.');
                
                setTimeout(() => {
                    addBotMessage('', createSelect(
                        asesores,
                        'Selecciona tu nombre...',
                        'üë§ Selecciona tu nombre:',
                        (asesor) => handleIngresoStep(asesor)
                    ));
                }, 600);
            }, 800);
        }

        function handleIngresoStep(response) {
            showTyping();
            
            setTimeout(() => {
                hideTyping();
                
                switch(appState.currentStep) {
                    case 0:
                        appState.ingreso.asesor = response;
                        addBotMessage(`¬°Hola ${response.split(' ')[0]}! üëã`);
                        appState.currentStep++;
                        
                        // Simulamos ubicaci√≥n (en producci√≥n usar√≠as geolocation)
                        appState.ingreso.ubicacion = 'Ubicaci√≥n simulada para prueba';
                        appState.ingreso.selfie = 'Selfie simulada';
                        
                        setTimeout(() => {
                            const ciudadesOptions = Object.keys(ciudadesPuntosVenta).sort();
                            addBotMessage('Perfecto! Ahora tu ubicaci√≥n comercial.');
                            setTimeout(() => {
                                addBotMessage('', createSelect(
                                    ciudadesOptions,
                                    'Selecciona tu ciudad...',
                                    'üìç Selecciona tu ciudad:',
                                    (ciudad) => handleIngresoStep(ciudad)
                                ));
                            }, 800);
                        }, 800);
                        break;
                        
                    case 1:
                        appState.ingreso.ciudad = response;
                        const puntosVenta = ciudadesPuntosVenta[response] || [];
                        
                        if (puntosVenta.length > 0) {
                            addBotMessage(`Est√°s en <strong>${response}</strong>.`);
                            setTimeout(() => {
                                addBotMessage('', createSelect(
                                    puntosVenta,
                                    'Selecciona el PDV...',
                                    `üè™ Selecciona el punto de venta:`,
                                    (punto) => handleIngresoStep(punto)
                                ));
                            }, 800);
                        } else {
                            addBotMessage(`Est√°s en <strong>${response}</strong>.`);
                            setTimeout(() => {
                                addBotMessage('', createInputBubble(
                                    `Escribe el nombre del PDV:`,
                                    'Ej: Tienda La Econom√≠a...',
                                    (punto) => handleIngresoStep(punto)
                                ));
                            }, 800);
                        }
                        appState.currentStep++;
                        break;
                        
                    case 2:
                        appState.ingreso.puntoVenta = response;
                        submitFormIngreso();
                        break;
                }
            }, 800);
        }

        function submitFormIngreso() {
            showTyping();
            
            setTimeout(() => {
                hideTyping();
                
                // Llenar formulario
                document.getElementById('asesorField').value = appState.ingreso.asesor;
                document.getElementById('ubicacionField').value = appState.ingreso.ubicacion;
                document.getElementById('selfieField').value = appState.ingreso.selfie;
                document.getElementById('ciudadField').value = appState.ingreso.ciudad;
                document.getElementById('puntoVentaField').value = appState.ingreso.puntoVenta;

                // Enviar formulario SILENCIOSAMENTE
                document.getElementById('googleFormIngreso').submit();

                // Mostrar confirmaci√≥n SIN REDIRIGIR
                addBotMessage(`
                    ‚úÖ <strong>¬°Ingreso registrado!</strong><br><br>
                    üìã <strong>Resumen:</strong><br>
                    üë§ Asesor: ${appState.ingreso.asesor}<br>
                    üìç Ciudad: ${appState.ingreso.ciudad}<br>
                    üè™ PDV: ${appState.ingreso.puntoVenta}
                `);
                
                appState.ingreso.completado = true;
                
                // Mostrar men√∫ principal
                setTimeout(() => showMainMenu(), 1500);
            }, 1500);
        }

        // ========== FLUJO LINEAL - CORREGIDO ==========
        function startLinealFlow() {
            // Reset completo
            appState.lineal = {
                tipoMarca: '',
                producto: '',
                numeroFrente: '',
                enviando: false
            };
            appState.currentStep = 0;
            appState.menuBloqueado = true;
            
            showTyping();
            setTimeout(() => {
                hideTyping();
                addBotMessage('üìä <strong>Registro de Participaci√≥n Lineal</strong>');
                
                setTimeout(() => {
                    addBotMessage('', createSelect(
                        ['MARCA PROPIA', 'MARCA COMPETENCIA'],
                        'Selecciona el tipo...',
                        'üè∑Ô∏è <strong>Paso 1:</strong> Tipo de marca:',
                        (tipo) => handleLinealStep1(tipo)
                    ));
                }, 600);
            }, 800);
        }

        function handleLinealStep1(tipo) {
            appState.lineal.tipoMarca = tipo;
            
            showTyping();
            setTimeout(() => {
                hideTyping();
                
                if (tipo === 'MARCA PROPIA') {
                    addBotMessage('‚úÖ Marca propia seleccionada');
                    
                    setTimeout(() => {
                        addBotMessage('', createSelect(
                            productosMarcaPropia,
                            'Selecciona la referencia...',
                            'üì¶ <strong>Paso 2:</strong> Selecciona la referencia:',
                            (producto) => handleLinealStep2(producto)
                        ));
                    }, 600);
                } else {
                    addBotMessage('‚úÖ Marca competencia seleccionada');
                    
                    setTimeout(() => {
                        addBotMessage('', createInputBubble(
                            'üìù <strong>Paso 2:</strong> Escribe el producto competencia:',
                            'Ej: Corona, Heineken...',
                            (producto) => handleLinealStep2(producto)
                        ));
                    }, 600);
                }
            }, 800);
        }

        function handleLinealStep2(producto) {
            appState.lineal.producto = producto;
            
            showTyping();
            setTimeout(() => {
                hideTyping();
                
                addBotMessage('‚úÖ Referencia registrada');
                
                setTimeout(() => {
                    addBotMessage('', createInputBubble(
                        'üî¢ <strong>Paso 3:</strong> Cantidad de caras/frentes:',
                        'Ingresa solo n√∫meros...',
                        (numero) => handleLinealStep3(numero),
                        'number'
                    ));
                }, 600);
            }, 800);
        }

        function handleLinealStep3(numero) {
            if (!isNaN(numero) && numero.trim() !== '' && parseInt(numero) > 0) {
                appState.lineal.numeroFrente = numero.trim();
                
                showTyping();
                setTimeout(() => {
                    hideTyping();
                    showConfirmacionLineal();
                }, 800);
            } else {
                addBotMessage('‚ùå Ingresa un n√∫mero v√°lido mayor a 0.');
                
                setTimeout(() => {
                    addBotMessage('', createInputBubble(
                        'üî¢ <strong>Paso 3:</strong> Cantidad de caras/frentes:',
                        'Ingresa solo n√∫meros...',
                        (numero) => handleLinealStep3(numero),
                        'number'
                    ));
                }, 600);
            }
        }

        function showConfirmacionLineal() {
            const confirmBubble = document.createElement('div');
            confirmBubble.className = 'bubble-container';

            confirmBubble.innerHTML = `
                <div class="bubble-title">üìã <strong>Paso 4:</strong> Confirma los datos</div>
                <div style="background: rgba(37, 211, 102, 0.1); padding: 15px; border-radius: 12px; margin: 15px 0; border: 1px solid rgba(37, 211, 102, 0.2);">
                    <div style="margin-bottom: 10px;">
                        <strong>üè∑Ô∏è Tipo:</strong> ${appState.lineal.tipoMarca}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>üì¶ Producto:</strong> ${appState.lineal.producto}
                    </div>
                    <div>
                        <strong>üî¢ Frentes:</strong> ${appState.lineal.numeroFrente}
                    </div>
                </div>
                <div style="margin-bottom: 12px; font-size: 0.9em; color: #666;">
                    ¬øLos datos son correctos?
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="action-button" id="btnConfirmarLineal" style="flex:1;">
                        ‚úÖ S√≠, enviar
                    </button>
                    <button class="action-button skip-btn" id="btnCorregirLineal" style="flex:1;">
                        ‚ùå No, corregir
                    </button>
                </div>
            `;

            addBotMessage('', confirmBubble);

            setTimeout(() => {
                document.getElementById('btnConfirmarLineal').onclick = () => {
                    if (appState.lineal.enviando) return;
                    appState.lineal.enviando = true;
                    submitFormLineal();
                };
                
                document.getElementById('btnCorregirLineal').onclick = () => {
                    // Eliminar mensajes del flujo lineal
                    const messages = document.querySelectorAll('.message');
                    const lastIndex = messages.length - 1;
                    
                    // Eliminar confirmaci√≥n y pasos anteriores
                    for (let i = lastIndex; i >= 0; i--) {
                        const msg = messages[i];
                        if (msg.querySelector('.bubble-container') || 
                            msg.textContent.includes('Paso') ||
                            msg.textContent.includes('Tipo de marca') ||
                            msg.textContent.includes('Selecciona') ||
                            msg.textContent.includes('Referencia') ||
                            msg.textContent.includes('Cantidad')) {
                            msg.remove();
                        } else {
                            break;
                        }
                    }
                    
                    // Volver al inicio
                    startLinealFlow();
                };
            }, 100);
        }

        function submitFormLineal() {
            showTyping();
            
            setTimeout(() => {
                hideTyping();
                
                // Llenar formulario UNA SOLA VEZ
                document.getElementById('tipoMarcaField').value = appState.lineal.tipoMarca;
                document.getElementById('productoField').value = appState.lineal.producto;
                document.getElementById('numeroFrentesField').value = appState.lineal.numeroFrente;

                // Enviar formulario SILENCIOSAMENTE
                document.getElementById('googleFormLineal').submit();

                addBotMessage(`
                    ‚úÖ <strong>¬°Participaci√≥n lineal registrada!</strong><br><br>
                    üìã <strong>Datos enviados:</strong><br>
                    üè∑Ô∏è Tipo: ${appState.lineal.tipoMarca}<br>
                    üì¶ Producto: ${appState.lineal.producto}<br>
                    üî¢ Frentes: ${appState.lineal.numeroFrente}
                `);
                
                // Desbloquear men√∫
                appState.menuBloqueado = false;
                
                // Preguntar qu√© hacer
                setTimeout(() => {
                    const askBubble = document.createElement('div');
                    askBubble.className = 'bubble-container';
                    askBubble.innerHTML = `
                        <div class="bubble-title">¬øQu√© deseas hacer ahora?</div>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="action-button" id="btnOtroRegistro" style="flex:1;">
                                üìä Registrar otro
                            </button>
                            <button class="action-button camera-btn" id="btnVolverMenu" style="flex:1;">
                                üè† Men√∫ principal
                            </button>
                        </div>
                    `;
                    
                    addBotMessage('', askBubble);
                    
                    setTimeout(() => {
                        document.getElementById('btnOtroRegistro').onclick = () => {
                            startLinealFlow();
                        };
                        document.getElementById('btnVolverMenu').onclick = () => {
                            showMainMenu();
                        };
                    }, 100);
                }, 1000);
            }, 1500);
        }

        // ========== MEN√ö PRINCIPAL - TODO DENTRO ==========
        function showMainMenu() {
            appState.menuBloqueado = false;
            
            const menuBubble = document.createElement('div');
            menuBubble.className = 'bubble-container';
            
            menuBubble.innerHTML = `
                <div class="bubble-title">üì± Men√∫ Principal</div>
                <div class="info-text" style="margin-bottom: 15px;">
                    Selecciona una opci√≥n:
                </div>
                <div class="menu-options" id="menuOptions">
                    <button class="menu-button" id="btnLineal">
                        <span style="font-size:1.2em;">üìä</span>
                        <div>
                            <strong>Participaci√≥n Lineal</strong><br>
                            <small style="font-size:0.8em; color:#666;">Registro de marcas en lineal</small>
                        </div>
                    </button>
                    <button class="menu-button" id="btnGaleria">
                        <span style="font-size:1.2em;">üè¨</span>
                        <div>
                            <strong>Galer√≠a PDV</strong><br>
                            <small style="font-size:0.8em; color:#666;">Fotos de puntos de venta</small>
                        </div>
                    </button>
                    <button class="menu-button" id="btnProximosVencer">
                        <span style="font-size:1.2em;">‚ö†Ô∏è</span>
                        <div>
                            <strong>Pr√≥ximos a Vencer</strong><br>
                            <small style="font-size:0.8em; color:#666;">Productos cercanos a vencimiento</small>
                        </div>
                    </button>
                    <button class="menu-button" id="btnAgotados">
                        <span style="font-size:1.2em;">üì¶</span>
                        <div>
                            <strong>Productos Agotados</strong><br>
                            <small style="font-size:0.8em; color:#666;">Inventario agotado</small>
                        </div>
                    </button>
                    <button class="menu-button" id="btnDescuentos">
                        <span style="font-size:1.2em;">üí∞</span>
                        <div>
                            <strong>Descuentos</strong><br>
                            <small style="font-size:0.8em; color:#666;">Promociones activas</small>
                        </div>
                    </button>
                    <button class="menu-button" id="btnRegistrosVentas">
                        <span style="font-size:1.2em;">üìà</span>
                        <div>
                            <strong>Registro Ventas</strong><br>
                            <small style="font-size:0.8em; color:#666;">Captura de ventas diarias</small>
                        </div>
                    </button>
                    <button class="menu-button" id="btnVozConsumidor">
                        <span style="font-size:1.2em;">üó£Ô∏è</span>
                        <div>
                            <strong>Voz Consumidor</strong><br>
                            <small style="font-size:0.8em; color:#666;">Feedback de clientes</small>
                        </div>
                    </button>
                    <button class="menu-button" id="btnNuevoIngreso">
                        <span style="font-size:1.2em;">üîÑ</span>
                        <div>
                            <strong>Nuevo Ingreso</strong><br>
                            <small style="font-size:0.8em; color:#666;">Registrar nuevo ingreso PDV</small>
                        </div>
                    </button>
                </div>
            `;

            addBotMessage('', menuBubble);

            setTimeout(() => {
                const actions = {
                    btnLineal: () => {
                        if (appState.menuBloqueado) return;
                        addUserMessage('üìä Participaci√≥n Lineal');
                        startLinealFlow();
                    },
                    btnGaleria: () => {
                        addUserMessage('üè¨ Galer√≠a PDV');
                        showTyping();
                        setTimeout(() => {
                            hideTyping();
                            addBotMessage('üîß <strong>Galer√≠a PDV</strong><br><br>Pr√≥ximamente podr√°s subir y ver fotos de puntos de venta.');
                        }, 800);
                    },
                    btnProximosVencer: () => {
                        addUserMessage('‚ö†Ô∏è Pr√≥ximos a Vencer');
                        showTyping();
                        setTimeout(() => {
                            hideTyping();
                            addBotMessage('üîß <strong>Pr√≥ximos a Vencer</strong><br><br>Pr√≥ximamente podr√°s registrar productos con fechas cercanas.');
                        }, 800);
                    },
                    btnAgotados: () => {
                        addUserMessage('üì¶ Productos Agotados');
                        showTyping();
                        setTimeout(() => {
                            hideTyping();
                            addBotMessage('üîß <strong>Productos Agotados</strong><br><br>Pr√≥ximamente podr√°s reportar inventario agotado.');
                        }, 800);
                    },
                    btnDescuentos: () => {
                        addUserMessage('üí∞ Descuentos');
                        showTyping();
                        setTimeout(() => {
                            hideTyping();
                            addBotMessage('üîß <strong>Descuentos</strong><br><br>Pr√≥ximamente podr√°s registrar promociones activas.');
                        }, 800);
                    },
                    btnRegistrosVentas: () => {
                        addUserMessage('üìà Registro Ventas');
                        showTyping();
                        setTimeout(() => {
                            hideTyping();
                            addBotMessage('üîß <strong>Registro de Ventas</strong><br><br>Pr√≥ximamente podr√°s capturar ventas diarias.');
                        }, 800);
                    },
                    btnVozConsumidor: () => {
                        addUserMessage('üó£Ô∏è Voz Consumidor');
                        showTyping();
                        setTimeout(() => {
                            hideTyping();
                            addBotMessage('üîß <strong>Voz del Consumidor</strong><br><br>Pr√≥ximamente podr√°s capturar feedback de clientes.');
                        }, 800);
                    },
                    btnNuevoIngreso: () => {
                        if (confirm('¬øIniciar nuevo registro de ingreso al PDV?')) {
                            startIngresoFlow();
                        }
                    }
                };

                Object.keys(actions).forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) btn.onclick = actions[id];
                });
            }, 100);
        }

        // ========== INICIALIZACI√ìN ==========
        function initChat() {
            setTimeout(() => {
                addBotMessage(`
                    üç∫ <strong>¬°Hola!</strong><br>
                    Soy tu asistente para registros en Puntos de Venta Beer.<br><br>
                    <em>Toda la interacci√≥n es dentro del chat. No hay redirecciones.</em>
                `);
                
                // Iniciar directamente con ingreso
                startIngresoFlow();
            }, 500);
        }

        // Prevenir redirecciones
        window.addEventListener('beforeunload', (e) => {
            // Solo prevenir si estamos en medio de un proceso
            if (appState.menuBloqueado || appState.lineal.enviando) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // Iniciar cuando cargue la p√°gina
        window.addEventListener('DOMContentLoaded', initChat);

    </script>
</body>
</html>
